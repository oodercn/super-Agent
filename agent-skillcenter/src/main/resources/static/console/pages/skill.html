<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>技能管理 - SkillCenter</title>
    
    <link rel="stylesheet" href="/skillcenter/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/skillcenter/console/css/theme.css">
    <link rel="stylesheet" href="/skillcenter/console/css/nexus.css">
    <style>
        .skill-status-pending { background: var(--nx-warning); color: white; }
        .skill-status-active { background: var(--nx-success); color: white; }
        .skill-status-rejected { background: var(--nx-danger); color: white; }
        .skill-status-inactive { background: var(--nx-text-secondary); color: white; }
    </style>
</head>
<body>
    <div class="nx-page">
        <aside class="nx-page__sidebar">
            <div class="nx-p-4 nx-mb-4">
                <h1 class="nx-text-lg nx-font-bold" style="display: flex; align-items: center; gap: 8px;">
                    <i class="ri-bolt-line"></i> SkillCenter
                </h1>
            </div>
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        
        <main class="nx-page__content">
            <header class="nx-page__header">
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-sidebar-toggle>
                        <i class="ri-menu-line"></i>
                    </button>
                    <h2 class="nx-text-lg nx-font-semibold">技能管理</h2>
                </div>
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--primary" onclick="openAddModal()">
                        <i class="ri-add-line"></i> 新建技能
                    </button>
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-theme-toggle>
                        <i class="ri-sun-line"></i>
                    </button>
                </div>
            </header>
            
            <div class="nx-page__main">
                <div class="nx-container">
                    <div class="nx-card nx-mb-6">
                        <div class="nx-card__header nx-flex nx-justify-between nx-items-center">
                            <h3 class="nx-card__title">技能列表</h3>
                            <div class="nx-flex nx-gap-2">
                                <input type="text" id="searchKeyword" class="nx-input" placeholder="搜索技能..." style="width: 200px;">
                                <button class="nx-btn nx-btn--secondary" onclick="loadSkills()">
                                    <i class="ri-search-line"></i> 搜索
                                </button>
                            </div>
                        </div>
                        <div class="nx-card__body">
                            <div class="nx-table-container">
                                <table class="nx-table">
                                    <thead>
                                        <tr>
                                            <th>技能ID</th>
                                            <th>技能名称</th>
                                            <th>分类</th>
                                            <th>版本</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="skill-table-body">
                                        <tr><td colspan="6" style="text-align: center;">加载中...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="skillModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h3 id="modalTitle">新建技能</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editSkillId">
                
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">技能ID</label>
                    <input type="text" id="skillId" class="nx-input" placeholder="输入技能ID">
                </div>
                
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">技能名称</label>
                    <input type="text" id="skillName" class="nx-input" placeholder="输入技能名称">
                </div>
                
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">分类</label>
                    <select id="skillCategory" class="nx-select" style="width: 100%;">
                        <option value="信息查询">信息查询</option>
                        <option value="金融">金融</option>
                        <option value="工具">工具</option>
                        <option value="娱乐">娱乐</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">版本</label>
                    <input type="text" id="skillVersion" class="nx-input" placeholder="如: 1.0.0">
                </div>
                
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">描述</label>
                    <textarea id="skillDescription" class="nx-textarea" rows="3" placeholder="技能描述"></textarea>
                </div>
                
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">入口文件</label>
                    <input type="text" id="skillEntry" class="nx-input" placeholder="如: main.py">
                </div>
            </div>
            <div class="modal-footer">
                <button class="nx-btn nx-btn--ghost" onclick="closeModal()">取消</button>
                <button class="nx-btn nx-btn--primary" onclick="saveSkill()">保存</button>
            </div>
        </div>
    </div>
    
    <div id="detailModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 700px;">
            <div class="modal-header">
                <h3>技能详情</h3>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="detailContent">
            </div>
            <div class="modal-footer">
                <button class="nx-btn nx-btn--ghost" onclick="closeDetailModal()">关闭</button>
            </div>
        </div>
    </div>
    
    <script src="/skillcenter/console/js/theme-manager.js"></script>
    <script src="/skillcenter/console/js/nexus-menu.js"></script>
    <script src="/skillcenter/console/js/utils.js"></script>
    <script src="/skillcenter/console/js/page-init.js" data-auto-init></script>
    <script>
        var skillsData = [];
        
        window.onPageInit = function() {
            console.log('[SkillManagement] 页面初始化');
            if (typeof initMenu === 'function') {
                initMenu('skill-management');
            }
            loadSkills();
        };
        
        async function loadSkills() {
            const tbody = document.getElementById('skill-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">加载中...</td></tr>';
            
            const keyword = document.getElementById('searchKeyword').value;
            
            try {
                const result = await utils.api.post('/skills/list', {
                    pageNum: 1,
                    pageSize: 50,
                    keyword: keyword || ''
                });
                
                if (result.code === 200 && result.data) {
                    skillsData = result.data.list || result.data.content || result.data.items || result.data || [];
                    
                    if (skillsData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--nx-text-secondary);">暂无技能数据</td></tr>';
                        return;
                    }
                    
                    renderSkillTable();
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--nx-danger);">加载失败</td></tr>';
                }
            } catch (error) {
                console.error('[SkillManagement] 加载技能列表错误:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--nx-danger);">加载失败</td></tr>';
            }
        }
        
        function renderSkillTable() {
            const tbody = document.getElementById('skill-table-body');
            tbody.innerHTML = skillsData.map(skill => `
                <tr>
                    <td>${skill.id || skill.skillId || '-'}</td>
                    <td>${skill.name || '-'}</td>
                    <td><span class="nx-badge nx-badge--primary">${skill.category || '未分类'}</span></td>
                    <td>${skill.version || '-'}</td>
                    <td><span class="nx-badge skill-status-${skill.status || 'pending'}">${getStatusText(skill.status)}</span></td>
                    <td>
                        <button class="nx-btn nx-btn--ghost nx-btn--sm" onclick="viewDetail('${skill.id || skill.skillId}')">详情</button>
                        <button class="nx-btn nx-btn--ghost nx-btn--sm" onclick="editSkill('${skill.id || skill.skillId}')">编辑</button>
                        <button class="nx-btn nx-btn--ghost nx-btn--sm" onclick="executeSkill('${skill.id || skill.skillId}')">执行</button>
                        <button class="nx-btn nx-btn--ghost nx-btn--sm nx-text-danger" onclick="deleteSkill('${skill.id || skill.skillId}')">删除</button>
                    </td>
                </tr>
            `).join('');
        }
        
        window.openAddModal = function() {
            document.getElementById('modalTitle').textContent = '新建技能';
            document.getElementById('editSkillId').value = '';
            document.getElementById('skillId').value = '';
            document.getElementById('skillId').disabled = false;
            document.getElementById('skillName').value = '';
            document.getElementById('skillCategory').value = '信息查询';
            document.getElementById('skillVersion').value = '1.0.0';
            document.getElementById('skillDescription').value = '';
            document.getElementById('skillEntry').value = '';
            document.getElementById('skillModal').style.display = 'block';
        };
        
        window.closeModal = function() {
            document.getElementById('skillModal').style.display = 'none';
        };
        
        window.editSkill = async function(skillId) {
            const skill = skillsData.find(s => (s.id || s.skillId) === skillId);
            if (!skill) {
                utils.msg.error('未找到技能信息');
                return;
            }
            
            document.getElementById('modalTitle').textContent = '编辑技能';
            document.getElementById('editSkillId').value = skillId;
            document.getElementById('skillId').value = skillId;
            document.getElementById('skillId').disabled = true;
            document.getElementById('skillName').value = skill.name || '';
            document.getElementById('skillCategory').value = skill.category || '信息查询';
            document.getElementById('skillVersion').value = skill.version || '';
            document.getElementById('skillDescription').value = skill.description || '';
            document.getElementById('skillEntry').value = skill.entry || '';
            document.getElementById('skillModal').style.display = 'block';
        };
        
        window.saveSkill = async function() {
            const editId = document.getElementById('editSkillId').value;
            const skillId = document.getElementById('skillId').value;
            const name = document.getElementById('skillName').value;
            const category = document.getElementById('skillCategory').value;
            const version = document.getElementById('skillVersion').value;
            const description = document.getElementById('skillDescription').value;
            const entry = document.getElementById('skillEntry').value;
            
            if (!skillId) {
                utils.msg.error('请输入技能ID');
                return;
            }
            if (!name) {
                utils.msg.error('请输入技能名称');
                return;
            }
            
            const data = {
                id: skillId,
                skillId: skillId,
                name: name,
                category: category,
                version: version,
                description: description,
                entry: entry
            };
            
            try {
                let result;
                if (editId) {
                    result = await utils.api.post('/skills/update', data);
                } else {
                    result = await utils.api.post('/skills/add', data);
                }
                
                if (result.code === 200) {
                    utils.msg.success(editId ? '更新成功' : '创建成功');
                    closeModal();
                    loadSkills();
                } else {
                    utils.msg.error('操作失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('[SkillManagement] 保存技能错误:', error);
                utils.msg.error('操作失败');
            }
        };
        
        window.deleteSkill = async function(skillId) {
            if (!confirm('确定要删除技能 "' + skillId + '" 吗？')) return;
            
            try {
                const result = await utils.api.post('/skills/delete', { id: skillId });
                
                if (result.code === 200) {
                    utils.msg.success('删除成功');
                    loadSkills();
                } else {
                    utils.msg.error('删除失败');
                }
            } catch (error) {
                console.error('[SkillManagement] 删除技能错误:', error);
                utils.msg.error('删除失败');
            }
        };
        
        window.executeSkill = function(skillId) {
            window.location.href = '/skillcenter/console/pages/execution.html?skillId=' + skillId;
        };
        
        window.viewDetail = async function(skillId) {
            try {
                const result = await utils.api.post('/skills/get', { id: skillId });
                
                if (result.code === 200 && result.data) {
                    const skill = result.data;
                    document.getElementById('detailContent').innerHTML = `
                        <div class="nx-grid nx-grid-cols-2 nx-gap-4">
                            <div class="nx-form-group">
                                <label class="nx-label">技能ID</label>
                                <p>${skill.id || skill.skillId || '-'}</p>
                            </div>
                            <div class="nx-form-group">
                                <label class="nx-label">技能名称</label>
                                <p>${skill.name || '-'}</p>
                            </div>
                            <div class="nx-form-group">
                                <label class="nx-label">分类</label>
                                <p>${skill.category || '-'}</p>
                            </div>
                            <div class="nx-form-group">
                                <label class="nx-label">版本</label>
                                <p>${skill.version || '-'}</p>
                            </div>
                            <div class="nx-form-group">
                                <label class="nx-label">状态</label>
                                <p><span class="nx-badge skill-status-${skill.status || 'pending'}">${getStatusText(skill.status)}</span></p>
                            </div>
                            <div class="nx-form-group">
                                <label class="nx-label">入口文件</label>
                                <p>${skill.entry || '-'}</p>
                            </div>
                            <div class="nx-form-group nx-col-span-2">
                                <label class="nx-label">描述</label>
                                <p>${skill.description || '-'}</p>
                            </div>
                        </div>
                        ${skill.status === 'pending' ? `
                        <div class="nx-flex nx-gap-2 nx-mt-4">
                            <button class="nx-btn nx-btn--success" onclick="approveSkill('${skill.id || skill.skillId}')">
                                <i class="ri-check-line"></i> 审批通过
                            </button>
                            <button class="nx-btn nx-btn--danger" onclick="rejectSkill('${skill.id || skill.skillId}')">
                                <i class="ri-close-line"></i> 拒绝
                            </button>
                        </div>
                        ` : ''}
                    `;
                    document.getElementById('detailModal').style.display = 'block';
                } else {
                    utils.msg.error('获取详情失败');
                }
            } catch (error) {
                console.error('[SkillManagement] 获取详情错误:', error);
                utils.msg.error('获取详情失败');
            }
        };
        
        window.closeDetailModal = function() {
            document.getElementById('detailModal').style.display = 'none';
        };
        
        window.approveSkill = async function(skillId) {
            try {
                const result = await utils.api.post('/skills/' + skillId + '/approve', {});
                
                if (result.code === 200) {
                    utils.msg.success('审批通过');
                    closeDetailModal();
                    loadSkills();
                } else {
                    utils.msg.error('审批失败');
                }
            } catch (error) {
                utils.msg.error('审批失败');
            }
        };
        
        window.rejectSkill = async function(skillId) {
            try {
                const result = await utils.api.post('/skills/' + skillId + '/reject', {});
                
                if (result.code === 200) {
                    utils.msg.success('已拒绝');
                    closeDetailModal();
                    loadSkills();
                } else {
                    utils.msg.error('操作失败');
                }
            } catch (error) {
                utils.msg.error('操作失败');
            }
        };
        
        function getStatusText(status) {
            const map = {
                'pending': '待审批',
                'active': '已发布',
                'rejected': '已拒绝',
                'inactive': '已停用'
            };
            return map[status] || status || '未知';
        }
    </script>
</body>
</html>
