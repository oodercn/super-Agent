<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>执行计划 - SkillCenter</title>
    <link rel="stylesheet" href="/skillcenter/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/skillcenter/console/css/theme.css">
    <link rel="stylesheet" href="/skillcenter/console/css/nexus.css">
    <style>
        .schedule-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .schedule-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .status-active .status-dot { background: #10b981; }
        .status-paused .status-dot { background: #f59e0b; }
        .status-error .status-dot { background: #ef4444; }
        .cron-expression {
            font-family: 'Consolas', 'Monaco', monospace;
            background: var(--nexus-input-bg);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="nx-page">
        <aside class="nx-page__sidebar">
            <div class="nx-p-4 nx-mb-4">
                <h1 class="nx-text-lg nx-font-bold" style="display: flex; align-items: center; gap: 8px;">
                    <i class="ri-bolt-line"></i> SkillCenter
                </h1>
            </div>
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        
        <main class="nx-page__content">
            <header class="nx-page__header">
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-sidebar-toggle>
                        <i class="ri-menu-line"></i>
                    </button>
                    <h2 class="nx-text-lg nx-font-semibold">执行计划</h2>
                </div>
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--primary" onclick="showCreateModal()">
                        <i class="ri-add-line"></i> 创建计划
                    </button>
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-theme-toggle>
                        <i class="ri-sun-line"></i>
                    </button>
                </div>
            </header>
            
            <div class="nx-page__main">
                <div class="nx-container" style="padding: 16px;">
                    <div class="nx-tabs nx-mb-6">
                        <button class="nx-tabs__tab" onclick="location.href='orchestration-templates.html'">编排模板</button>
                        <button class="nx-tabs__tab nx-tabs__tab--active" onclick="location.href='execution-schedule.html'">执行计划</button>
                        <button class="nx-tabs__tab" onclick="location.href='flow-design.html'">流程设计</button>
                    </div>
                    
                    <div class="nx-card">
                        <div class="nx-card__header">
                            <div class="nx-flex nx-items-center nx-gap-4">
                                <select class="nx-select" id="status-filter" onchange="loadSchedules()">
                                    <option value="">全部状态</option>
                                    <option value="active">运行中</option>
                                    <option value="paused">已暂停</option>
                                </select>
                                <input type="text" class="nx-input" id="search-input" placeholder="搜索计划名称..." onkeyup="filterSchedules()" style="width: 200px;">
                            </div>
                        </div>
                        <div class="nx-card__body">
                            <div class="nx-table-container">
                                <table class="nx-table">
                                    <thead>
                                        <tr>
                                            <th>计划名称</th>
                                            <th>关联模板</th>
                                            <th>Cron表达式</th>
                                            <th>时区</th>
                                            <th>状态</th>
                                            <th>执行次数</th>
                                            <th>下次执行</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schedule-list">
                                        <tr>
                                            <td colspan="8" class="nx-text-center nx-text-secondary">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="create-modal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="hideCreateModal()"></div>
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header">
                <h3>创建执行计划</h3>
                <button class="modal-close" onclick="hideCreateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">计划名称 <span style="color: red;">*</span></label>
                    <input type="text" class="nx-input" id="create-name" placeholder="输入计划名称">
                </div>
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">关联模板 <span style="color: red;">*</span></label>
                    <select class="nx-select" id="create-template">
                        <option value="">选择模板</option>
                    </select>
                </div>
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">Cron表达式 <span style="color: red;">*</span></label>
                    <input type="text" class="nx-input" id="create-cron" placeholder="例如: 0 0 2 * * ?">
                    <div class="nx-text-secondary nx-text-sm nx-mt-1">
                        格式: 秒 分 时 日 月 周 (例如: 0 0 2 * * ? 表示每天凌晨2点执行)
                    </div>
                </div>
                <div class="nx-form-group nx-mb-4">
                    <label class="nx-label">时区</label>
                    <select class="nx-select" id="create-timezone">
                        <option value="Asia/Shanghai">Asia/Shanghai (北京时间)</option>
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">America/New_York</option>
                        <option value="Europe/London">Europe/London</option>
                    </select>
                </div>
                <div class="nx-form-group">
                    <label class="nx-label">常用预设</label>
                    <div class="nx-flex nx-flex-wrap nx-gap-2">
                        <button class="nx-btn nx-btn--secondary nx-btn--sm" onclick="setCron('0 0 * * * ?')">每小时</button>
                        <button class="nx-btn nx-btn--secondary nx-btn--sm" onclick="setCron('0 0 0 * * ?')">每天零点</button>
                        <button class="nx-btn nx-btn--secondary nx-btn--sm" onclick="setCron('0 0 2 * * ?')">每天凌晨2点</button>
                        <button class="nx-btn nx-btn--secondary nx-btn--sm" onclick="setCron('0 0 0 * * MON')">每周一</button>
                        <button class="nx-btn nx-btn--secondary nx-btn--sm" onclick="setCron('0 0 0 1 * ?')">每月1号</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="nx-btn nx-btn--ghost" onclick="hideCreateModal()">取消</button>
                <button class="nx-btn nx-btn--primary" onclick="createSchedule()">创建</button>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="hideHistoryModal()"></div>
        <div class="modal-content" style="width: 700px;">
            <div class="modal-header">
                <h3>执行历史 - <span id="history-schedule-name"></span></h3>
                <button class="modal-close" onclick="hideHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="nx-table-container">
                    <table class="nx-table">
                        <thead>
                            <tr>
                                <th>执行时间</th>
                                <th>状态</th>
                                <th>耗时</th>
                                <th>结果</th>
                            </tr>
                        </thead>
                        <tbody id="history-list">
                            <tr>
                                <td colspan="4" class="nx-text-center nx-text-secondary">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/skillcenter/console/js/theme-manager.js"></script>
    <script src="/skillcenter/console/js/api-client.js"></script>
    <script src="/skillcenter/console/js/nexus-menu.js"></script>
    <script src="/skillcenter/console/js/page-init.js" data-auto-init></script>
    <script>
        let allSchedules = [];
        let templates = [];
        
        window.onPageInit = function() {
            console.log('Execution Schedule 页面初始化完成');
            loadTemplates();
            loadSchedules();
        };
        
        async function loadTemplates() {
            try {
                const result = await ApiClient.post('/api/orchestration/templates', {});
                if (result.code === 200 && result.data) {
                    templates = result.data.list || result.data || [];
                    
                    const select = document.getElementById('create-template');
                    select.innerHTML = '<option value="">选择模板</option>';
                    templates.forEach(t => {
                        select.innerHTML += `<option value="${t.templateId}">${t.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('加载模板失败:', error);
            }
        }
        
        async function loadSchedules() {
            const status = document.getElementById('status-filter').value;
            
            try {
                const result = await ApiClient.post('/api/orchestration/schedules', {
                    status: status,
                    pageNum: 1,
                    pageSize: 100
                });
                
                if (result.code === 200 && result.data) {
                    allSchedules = result.data.list || result.data || [];
                    renderSchedules(allSchedules);
                }
            } catch (error) {
                console.error('加载计划失败:', error);
                document.getElementById('schedule-list').innerHTML = 
                    '<tr><td colspan="8" class="nx-text-center nx-text-error">加载失败</td></tr>';
            }
        }
        
        function renderSchedules(schedules) {
            const container = document.getElementById('schedule-list');
            
            if (schedules.length === 0) {
                container.innerHTML = '<tr><td colspan="8" class="nx-text-center nx-text-secondary">暂无执行计划</td></tr>';
                return;
            }
            
            container.innerHTML = schedules.map(s => {
                const template = templates.find(t => t.templateId === s.templateId);
                const templateName = template ? template.name : s.templateId;
                
                return `
                    <tr>
                        <td>${s.name}</td>
                        <td>${templateName}</td>
                        <td><code class="cron-expression">${s.cronExpression}</code></td>
                        <td>${s.timezone || 'Asia/Shanghai'}</td>
                        <td>
                            <span class="schedule-status status-${s.status}">
                                <span class="status-dot"></span>
                                ${s.status === 'active' ? '运行中' : (s.status === 'paused' ? '已暂停' : s.status)}
                            </span>
                        </td>
                        <td>
                            <span class="nx-text-success">${s.executionCount || 0}</span> / 
                            <span class="nx-text-error">${s.failureCount || 0}</span>
                        </td>
                        <td>${s.nextExecutionTime ? formatTime(s.nextExecutionTime) : '-'}</td>
                        <td>
                            <button class="nx-btn nx-btn--ghost nx-btn--sm" onclick="toggleSchedule('${s.scheduleId}')" title="${s.status === 'active' ? '暂停' : '启用'}">
                                <i class="ri-${s.status === 'active' ? 'pause' : 'play'}-line"></i>
                            </button>
                            <button class="nx-btn nx-btn--ghost nx-btn--sm" onclick="showHistory('${s.scheduleId}', '${s.name}')" title="执行历史">
                                <i class="ri-history-line"></i>
                            </button>
                            <button class="nx-btn nx-btn--ghost nx-btn--sm nx-text-error" onclick="deleteSchedule('${s.scheduleId}')" title="删除">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterSchedules() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = allSchedules.filter(s => 
                s.name.toLowerCase().includes(search)
            );
            renderSchedules(filtered);
        }
        
        function showCreateModal() {
            document.getElementById('create-name').value = '';
            document.getElementById('create-template').value = '';
            document.getElementById('create-cron').value = '';
            document.getElementById('create-timezone').value = 'Asia/Shanghai';
            document.getElementById('create-modal').style.display = 'flex';
        }
        
        function hideCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
        }
        
        function setCron(expression) {
            document.getElementById('create-cron').value = expression;
        }
        
        async function createSchedule() {
            const name = document.getElementById('create-name').value.trim();
            const templateId = document.getElementById('create-template').value;
            const cronExpression = document.getElementById('create-cron').value.trim();
            const timezone = document.getElementById('create-timezone').value;
            
            if (!name || !templateId || !cronExpression) {
                ApiClient.showError('请填写必填项');
                return;
            }
            
            try {
                const result = await ApiClient.post('/api/orchestration/schedules/create', {
                    name: name,
                    templateId: templateId,
                    cronExpression: cronExpression,
                    timezone: timezone
                });
                
                if (result.code === 200) {
                    ApiClient.showSuccess('创建成功');
                    hideCreateModal();
                    loadSchedules();
                } else {
                    ApiClient.showError(result.message || '创建失败');
                }
            } catch (error) {
                ApiClient.showError('创建失败: ' + error.message);
            }
        }
        
        async function toggleSchedule(scheduleId) {
            try {
                const result = await ApiClient.post('/api/orchestration/schedules/toggle', {
                    scheduleId: scheduleId
                });
                
                if (result.code === 200) {
                    ApiClient.showSuccess(result.message);
                    loadSchedules();
                } else {
                    ApiClient.showError(result.message || '操作失败');
                }
            } catch (error) {
                ApiClient.showError('操作失败: ' + error.message);
            }
        }
        
        async function deleteSchedule(scheduleId) {
            if (!confirm('确定要删除此执行计划吗？')) return;
            
            try {
                const result = await ApiClient.post('/api/orchestration/schedules/delete', {
                    scheduleId: scheduleId
                });
                
                if (result.code === 200) {
                    ApiClient.showSuccess('删除成功');
                    loadSchedules();
                } else {
                    ApiClient.showError(result.message || '删除失败');
                }
            } catch (error) {
                ApiClient.showError('删除失败: ' + error.message);
            }
        }
        
        function showHistory(scheduleId, name) {
            document.getElementById('history-schedule-name').textContent = name;
            document.getElementById('history-modal').style.display = 'flex';
            
            renderMockHistory();
        }
        
        function renderMockHistory() {
            const container = document.getElementById('history-list');
            
            const mockHistory = [];
            for (let i = 0; i < 10; i++) {
                const success = Math.random() > 0.1;
                mockHistory.push({
                    time: Date.now() - i * 86400000,
                    status: success ? 'success' : 'failed',
                    duration: Math.floor(Math.random() * 5000) + 100,
                    result: success ? '执行成功' : '执行失败: 超时'
                });
            }
            
            container.innerHTML = mockHistory.map(h => `
                <tr>
                    <td>${formatTime(h.time)}</td>
                    <td>
                        <span class="nx-badge nx-badge--${h.status === 'success' ? 'success' : 'error'}">
                            ${h.status === 'success' ? '成功' : '失败'}
                        </span>
                    </td>
                    <td>${h.duration}ms</td>
                    <td class="${h.status === 'success' ? 'nx-text-success' : 'nx-text-error'}">${h.result}</td>
                </tr>
            `).join('');
        }
        
        function hideHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleString();
        }
    </script>
</body>
</html>
