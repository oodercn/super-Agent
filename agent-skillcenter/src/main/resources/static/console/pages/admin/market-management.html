<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理中心 - 市场管理</title>
    <link rel="stylesheet" href="/skillcenter/console/css/style.css">
    <link href="../../assets/css/remixicon/remixicon.css" rel="stylesheet">
    <script src="/skillcenter/console/js/menu.js"></script>

</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <!-- 菜单将通过menu.js动态加载 -->
        </aside>
        <main class="main-content">
            <header class="header">
                <h1>市场管理</h1>
                <div class="user-info">
                    <span class="user-name">管理员</span>
                    <i class="ri-user-line"></i>
                </div>
            </header>
            
            <!-- 搜索和筛选 -->
            <div class="search-box">
                <input type="text" class="form-control" placeholder="搜索技能名称或ID" id="skillSearch">
            </div>
            
            <div class="filter-box">
                <select id="categoryFilter" class="form-control">
                    <option value="all">全部分类</option>
                    <option value="text-processing">文本处理</option>
                    <option value="development">开发工具</option>
                    <option value="deployment">部署工具</option>
                    <option value="media">媒体处理</option>
                    <option value="storage">存储管理</option>
                </select>
                <select id="statusFilter" class="form-control">
                    <option value="all">全部状态</option>
                    <option value="active">活跃</option>
                    <option value="pending">待审核</option>
                    <option value="inactive"> inactive</option>
                </select>
            </div>
            
            <!-- 市场技能列表 -->
            <div class="skills-table">
                <table>
                    <thead>
                        <tr>
                            <th>技能ID</th>
                            <th>技能名称</th>
                            <th>分类</th>
                            <th>状态</th>
                            <th>下载量</th>
                            <th>评分</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="skillTableBody">
                        <!-- 技能数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    
    <!-- 添加/编辑市场技能模态框 -->
    <div id="skillModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加市场技能</h3>
                <span class="close" onclick="closeSkillModal()">&times;</span>
            </div>
            <form id="skillForm">
                <input type="hidden" id="skillId">
                <div class="form-group">
                    <label for="skillName">技能名称</label>
                    <input type="text" class="form-control" id="skillName" required>
                </div>
                <div class="form-group">
                    <label for="skillDescription">技能描述</label>
                    <textarea class="form-control" id="skillDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label for="skillCategory">技能分类</label>
                    <select class="form-control" id="skillCategory" required>
                        <option value="text-processing">文本处理</option>
                        <option value="development">开发工具</option>
                        <option value="deployment">部署工具</option>
                        <option value="media">媒体处理</option>
                        <option value="storage">存储管理</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="skillStatus">技能状态</label>
                    <select class="form-control" id="skillStatus" required>
                        <option value="active">活跃</option>
                        <option value="pending">待审核</option>
                        <option value="inactive"> inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="skillVersion">技能版本</label>
                    <input type="text" class="form-control" id="skillVersion" required>
                </div>
                <div class="form-group">
                    <label for="skillAuthor">技能作者</label>
                    <input type="text" class="form-control" id="skillAuthor" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSkillModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // 初始化菜单
        initMenu('market-management');
        
        // API基础URL
        const API_BASE_URL = '/skillcenter/api';
        
        // 页面加载时渲染技能列表
        document.addEventListener('DOMContentLoaded', function() {
            renderSkillList();
        });
        
        // 渲染技能列表
        function renderSkillList() {
            const tableBody = document.getElementById('skillTableBody');
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">加载中...</td></tr>';
            
            const searchTerm = document.getElementById('skillSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            // 构建查询参数
            const params = new URLSearchParams();
            if (categoryFilter !== 'all') params.append('category', categoryFilter);
            if (statusFilter !== 'all') params.append('status', statusFilter);
            const queryString = params.toString();
            
            // 调用API获取市场技能列表
            fetch(`${API_BASE_URL}/market/skills${queryString ? '?' + queryString : ''}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        let skills = data.data.items || [];
                        
                        // 客户端搜索过滤
                        if (searchTerm) {
                            skills = skills.filter(skill => 
                                skill.name.toLowerCase().includes(searchTerm) || 
                                skill.id.toLowerCase().includes(searchTerm)
                            );
                        }
                        
                        tableBody.innerHTML = '';
                        
                        skills.forEach(skill => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${skill.id}</td>
                                <td>${skill.name}</td>
                                <td>${skill.category}</td>
                                <td><span class="skill-status status-${skill.status}">${getStatusText(skill.status)}</span></td>
                                <td>${skill.downloads || 0}</td>
                                <td>
                                    <div class="rating">
                                        ${getRatingStars(skill.rating || 0)}
                                        <span>${skill.rating || 0}</span>
                                    </div>
                                </td>
                                <td>${skill.createdAt ? new Date(skill.createdAt).toLocaleString() : ''}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-secondary" onclick="editMarketSkill('${skill.id}')">
                                            <i class="ri-edit-line"></i> 编辑
                                        </button>
                                        <button class="btn btn-danger" onclick="removeMarketSkill('${skill.id}')">
                                            <i class="ri-delete-line"></i> 移除
                                        </button>
                                    </div>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: red;">获取市场技能列表失败</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching market skills:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: red;">获取市场技能列表失败</td></tr>';
                });
        }
        
        // 获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'active': return '活跃';
                case 'pending': return '待审核';
                case 'inactive': return ' inactive';
                default: return status;
            }
        }
        
        // 获取评分星星
        function getRatingStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '★';
            }
            if (hasHalfStar) {
                stars += '½';
            }
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                stars += '☆';
            }
            
            return stars;
        }
        
        // 打开添加市场技能模态框
        function openAddMarketSkillModal() {
            document.getElementById('modalTitle').textContent = '添加市场技能';
            document.getElementById('skillId').value = '';
            document.getElementById('skillName').value = '';
            document.getElementById('skillDescription').value = '';
            document.getElementById('skillCategory').value = 'text-processing';
            document.getElementById('skillStatus').value = 'active';
            document.getElementById('skillVersion').value = '1.0.0';
            document.getElementById('skillAuthor').value = 'System';
            document.getElementById('skillModal').style.display = 'block';
        }
        
        // 打开编辑市场技能模态框
        function editMarketSkill(skillId) {
            // 调用API获取技能详情
            fetch(`${API_BASE_URL}/market/skills/${skillId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const skill = data.data;
                        document.getElementById('modalTitle').textContent = '编辑市场技能';
                        document.getElementById('skillId').value = skill.id;
                        document.getElementById('skillName').value = skill.name;
                        document.getElementById('skillDescription').value = skill.description || '';
                        document.getElementById('skillCategory').value = skill.category || 'text-processing';
                        document.getElementById('skillStatus').value = skill.status || 'active';
                        document.getElementById('skillVersion').value = skill.version || '1.0.0';
                        document.getElementById('skillAuthor').value = skill.author || 'System';
                        document.getElementById('skillModal').style.display = 'block';
                    } else {
                        alert('获取技能详情失败');
                    }
                })
                .catch(error => {
                    console.error('Error fetching skill details:', error);
                    alert('获取技能详情失败');
                });
        }
        
        // 关闭技能模态框
        function closeSkillModal() {
            document.getElementById('skillModal').style.display = 'none';
        }
        
        // 提交技能表单
        document.getElementById('skillForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const skillId = document.getElementById('skillId').value;
            const skillName = document.getElementById('skillName').value;
            const skillDescription = document.getElementById('skillDescription').value;
            const skillCategory = document.getElementById('skillCategory').value;
            const skillStatus = document.getElementById('skillStatus').value;
            const skillVersion = document.getElementById('skillVersion').value;
            const skillAuthor = document.getElementById('skillAuthor').value;
            
            const skillData = {
                name: skillName,
                description: skillDescription,
                category: skillCategory,
                status: skillStatus,
                version: skillVersion,
                author: skillAuthor
            };
            
            let url = `${API_BASE_URL}/market/skills`;
            let method = 'POST';
            
            if (skillId) {
                // 编辑现有技能
                url = `${API_BASE_URL}/market/skills/${skillId}`;
                method = 'PUT';
            }
            
            // 调用API保存技能
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(skillData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderSkillList();
                    closeSkillModal();
                    alert('技能保存成功！');
                } else {
                    alert('技能保存失败');
                }
            })
            .catch(error => {
                console.error('Error saving skill:', error);
                alert('技能保存失败');
            });
        }
        
        // 移除市场技能
        function removeMarketSkill(skillId) {
            if (confirm('确定要从市场中移除这个技能吗？')) {
                // 调用API移除技能
                fetch(`${API_BASE_URL}/market/skills/${skillId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderSkillList();
                        alert('技能移除成功！');
                    } else {
                        alert('技能移除失败');
                    }
                })
                .catch(error => {
                    console.error('Error removing skill:', error);
                    alert('技能移除失败');
                });
            }
        }
        
        // 搜索和筛选事件
        document.getElementById('skillSearch').addEventListener('input', renderSkillList);
        document.getElementById('categoryFilter').addEventListener('change', renderSkillList);
        document.getElementById('statusFilter').addEventListener('change', renderSkillList);
    </script>
</body>
</html>