<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同步状态 - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/styles.css">
    <link rel="stylesheet" href="/console/css/llm-integration.css">
    <script src="/console/js/menu-loader.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        <main class="main-content">
            <div class="content-header">
                <h1>同步状态</h1>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="refreshSyncStatus()">
                        <i class="ri-refresh-line"></i>
                        刷新
                    </button>
                    <button class="btn btn-secondary" onclick="cancelAllSync()">
                        <i class="ri-close-line"></i>
                        取消全部
                    </button>
                </div>
            </div>
            <div class="sync-status-list" id="sync-status-list">
                <div class="loading">加载中...</div>
            </div>
        </main>
    </div>

    <script src="/console/js/common/ApiClient.js"></script>
    <script src="/console/js/skillcenter-sync-api.js"></script>
    <script>
        class SyncStatusPage {
            constructor() {
                this.syncAPI = new SkillCenterSyncAPI();
                this.syncStatus = null;
            }

            async init() {
                try {
                    await this.loadSyncStatus();
                    this.bindEvents();
                } catch (error) {
                    console.error('初始化错误:', error);
                    this.showError('初始化失败');
                }
            }

            async loadSyncStatus() {
                try {
                    const response = await this.syncAPI.getSyncStatus();
                    if (response.success) {
                        this.syncStatus = response.data;
                        this.renderSyncStatus();
                    } else {
                        this.showError(response.message || '加载同步状态失败');
                        document.getElementById('sync-status-list').innerHTML = '<div class="empty-state">加载失败</div>';
                    }
                } catch (error) {
                    console.error('加载同步状态错误:', error);
                    this.showError('加载同步状态失败');
                    document.getElementById('sync-status-list').innerHTML = '<div class="empty-state">加载失败</div>';
                }
            }

            renderSyncStatus() {
                const syncStatusList = document.getElementById('sync-status-list');
                let html = '';

                if (!this.syncStatus || !this.syncStatus.tasks || this.syncStatus.tasks.length === 0) {
                    syncStatusList.innerHTML = '<div class="empty-state">暂无同步任务</div>';
                    return;
                }

                html += `<div class="sync-summary">`;
                html += `<div class="summary-item">`;
                html += `<span class="summary-label">总任务数：</span>`;
                html += `<span class="summary-value">${this.syncStatus.totalSkills}</span>`;
                html += `</div>`;
                html += `<div class="summary-item">`;
                html += `<span class="summary-label">已完成：</span>`;
                html += `<span class="summary-value success">${this.syncStatus.completedSkills}</span>`;
                html += `</div>`;
                html += `<div class="summary-item">`;
                html += `<span class="summary-label">失败：</span>`;
                html += `<span class="summary-value error">${this.syncStatus.failedSkills}</span>`;
                html += `</div>`;
                html += `<div class="summary-item">`;
                html += `<span class="summary-label">状态：</span>`;
                html += `<span class="summary-value ${this.getStateClass(this.syncStatus.state)}">${this.getStateText(this.syncStatus.state)}</span>`;
                html += `</div>`;
                html += `</div>`;

                html += `<h3>同步任务详情</h3>`;
                this.syncStatus.tasks.forEach(task => {
                    html += `<div class="sync-task-item">`;
                    html += `<div class="task-header">`;
                    html += `<span class="task-name">${task.skillName || task.skillId}</span>`;
                    html += `<span class="task-status ${this.getTaskStateClass(task.state)}">${this.getTaskStateText(task.state)}</span>`;
                    html += `</div>`;
                    if (task.errorMessage) {
                        html += `<div class="task-error">`;
                        html += `<strong>错误信息：</strong>${task.errorMessage}`;
                        html += `</div>`;
                    }
                    html += `<div class="task-time">`;
                    html += `<span>开始时间：${new Date(task.startTime).toLocaleString('zh-CN')}</span>`;
                    if (task.endTime) {
                        html += `<span>结束时间：${new Date(task.endTime).toLocaleString('zh-CN')}</span>`;
                    }
                    html += `</div>`;
                    html += `</div>`;
                });

                syncStatusList.innerHTML = html;
            }

            getStateText(state) {
                const stateMap = {
                    'PENDING': '等待中',
                    'IN_PROGRESS': '进行中',
                    'COMPLETED': '已完成',
                    'FAILED': '失败',
                    'CANCELLED': '已取消'
                };
                return stateMap[state] || state;
            }

            getStateClass(state) {
                const classMap = {
                    'PENDING': 'pending',
                    'IN_PROGRESS': 'in-progress',
                    'COMPLETED': 'completed',
                    'FAILED': 'failed',
                    'CANCELLED': 'cancelled'
                };
                return classMap[state] || '';
            }

            getTaskStateText(state) {
                const stateMap = {
                    'PENDING': '等待中',
                    'IN_PROGRESS': '进行中',
                    'COMPLETED': '已完成',
                    'FAILED': '失败',
                    'CANCELLED': '已取消'
                };
                return stateMap[state] || state;
            }

            getTaskStateClass(state) {
                const classMap = {
                    'PENDING': 'pending',
                    'IN_PROGRESS': 'in-progress',
                    'COMPLETED': 'completed',
                    'FAILED': 'failed',
                    'CANCELLED': 'cancelled'
                };
                return classMap[state] || '';
            }

            bindEvents() {
                // 菜单事件由menu-loader.js处理
            }

            showSuccess(message) {
                this.showNotification(message, 'success');
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        }

        const syncStatusPage = new SyncStatusPage();
        syncStatusPage.init();

        async function refreshSyncStatus() {
            document.getElementById('sync-status-list').innerHTML = '<div class="loading">加载中...</div>';
            await syncStatusPage.loadSyncStatus();
        }

        async function cancelAllSync() {
            try {
                alert('取消全部同步功能开发中...');
            } catch (error) {
                console.error('取消同步错误:', error);
                syncStatusPage.showError('取消同步失败');
            }
        }
    </script>
    <script>
        window.onload = function() {
            initMenu();
        };
    </script>
</body>
</html>
