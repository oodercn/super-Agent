<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>存储管理 - Nexus SkillCenter</title>
    <link rel="stylesheet" href="/console/css/styles.css">
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <script src="/console/js/menu-loader.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        <main class="main-content">
            <header class="header">
                <h1>存储管理</h1>
            </header>
            <div class="content">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('status')">存储状态</button>
                    <button class="tab-btn" onclick="switchTab('backup')">存储备份</button>
                    <button class="tab-btn" onclick="switchTab('restore')">存储恢复</button>
                    <button class="tab-btn" onclick="switchTab('clean')">存储清理</button>
                    <button class="tab-btn" onclick="switchTab('settings')">存储设置</button>
                </div>
                
                <div class="tab-content" id="status-tab">
                    <div class="storage-status" id="storage-status">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
                
                <div class="tab-content" id="backup-tab" style="display: none;">
                    <div class="backup-list" id="backup-list">
                        <div class="loading">加载中...</div>
                    </div>
                    <div class="backup-actions">
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="ri-save-line"></i> 创建备份
                        </button>
                    </div>
                </div>
                
                <div class="tab-content" id="restore-tab" style="display: none;">
                    <div class="restore-list" id="restore-list">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
                
                <div class="tab-content" id="clean-tab" style="display: none;">
                    <div class="clean-options">
                        <h3>清理选项</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clean-temp"> 清理临时文件
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clean-cache"> 清理缓存
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clean-logs"> 清理日志文件
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clean-old-backups"> 清理旧备份
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="performClean()">
                            <i class="ri-delete-bin-line"></i> 执行清理
                        </button>
                    </div>
                </div>
                
                <div class="tab-content" id="settings-tab" style="display: none;">
                    <div class="storage-settings">
                        <h3>存储设置</h3>
                        <form id="storage-settings-form">
                            <div class="form-group">
                                <label>存储路径</label>
                                <input type="text" id="storage-path" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>最大存储空间 (GB)</label>
                                <input type="number" id="max-storage" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>备份保留天数</label>
                                <input type="number" id="backup-retention" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>自动备份</label>
                                <select id="auto-backup" class="form-control">
                                    <option value="disabled">禁用</option>
                                    <option value="daily">每天</option>
                                    <option value="weekly">每周</option>
                                    <option value="monthly">每月</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <i class="ri-save-line"></i> 保存设置
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        window.onload = function() {
            initMenu();
            loadStorageStatus();
            loadBackupList();
            loadRestoreList();
            loadSettings();
        };

        async function loadStorageStatus() {
            try {
                const response = await fetch('/api/admin/storage/status');
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    renderStorageStatus(result.data);
                } else {
                    showError('加载存储状态失败');
                }
            } catch (error) {
                console.error('加载存储状态错误:', error);
                showError('加载存储状态失败');
            }
        }

        function renderStorageStatus(status) {
            const statusDiv = document.getElementById('storage-status');
            statusDiv.innerHTML = `
                <div class="storage-overview">
                    <div class="storage-card">
                        <h4>总空间</h4>
                        <p class="storage-value">${formatSize(status.totalSpace)}</p>
                    </div>
                    <div class="storage-card">
                        <h4>已使用</h4>
                        <p class="storage-value">${formatSize(status.usedSpace)}</p>
                    </div>
                    <div class="storage-card">
                        <h4>可用空间</h4>
                        <p class="storage-value">${formatSize(status.freeSpace)}</p>
                    </div>
                    <div class="storage-card">
                        <h4>使用率</h4>
                        <p class="storage-value">${status.usagePercent}%</p>
                    </div>
                </div>
                <div class="storage-details">
                    <h4>存储详情</h4>
                    <ul>
                        <li><strong>技能文件:</strong> ${formatSize(status.skillFiles)}</li>
                        <li><strong>备份文件:</strong> ${formatSize(status.backupFiles)}</li>
                        <li><strong>日志文件:</strong> ${formatSize(status.logFiles)}</li>
                        <li><strong>临时文件:</strong> ${formatSize(status.tempFiles)}</li>
                        <li><strong>其他文件:</strong> ${formatSize(status.otherFiles)}</li>
                    </ul>
                </div>
            `;
        }

        async function loadBackupList() {
            try {
                const response = await fetch('/api/admin/storage/backups');
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    renderBackupList(result.data);
                } else {
                    showError('加载备份列表失败');
                }
            } catch (error) {
                console.error('加载备份列表错误:', error);
                showError('加载备份列表失败');
            }
        }

        function renderBackupList(backups) {
            const backupList = document.getElementById('backup-list');
            backupList.innerHTML = '';
            
            backups.forEach(backup => {
                const backupItem = document.createElement('div');
                backupItem.className = 'backup-item';
                backupItem.innerHTML = `
                    <div class="backup-info">
                        <h3>${backup.name}</h3>
                        <p><strong>大小:</strong> ${formatSize(backup.size)}</p>
                        <p><strong>创建时间:</strong> ${formatTime(backup.createdAt)}</p>
                        <p><strong>描述:</strong> ${backup.description || '无'}</p>
                    </div>
                    <div class="backup-actions">
                        <button class="btn btn-secondary" onclick="downloadBackup('${backup.id}')">
                            <i class="ri-download-line"></i> 下载
                        </button>
                        <button class="btn btn-primary" onclick="restoreFromBackup('${backup.id}')">
                            <i class="ri-refresh-line"></i> 恢复
                        </button>
                        <button class="btn btn-danger" onclick="deleteBackup('${backup.id}')">
                            <i class="ri-delete-line"></i> 删除
                        </button>
                    </div>
                `;
                backupList.appendChild(backupItem);
            });
        }

        async function loadRestoreList() {
            try {
                const response = await fetch('/api/admin/storage/backups');
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    renderRestoreList(result.data);
                } else {
                    showError('加载恢复列表失败');
                }
            } catch (error) {
                console.error('加载恢复列表错误:', error);
                showError('加载恢复列表失败');
            }
        }

        function renderRestoreList(backups) {
            const restoreList = document.getElementById('restore-list');
            restoreList.innerHTML = '';
            
            backups.forEach(backup => {
                const backupItem = document.createElement('div');
                backupItem.className = 'backup-item';
                backupItem.innerHTML = `
                    <div class="backup-info">
                        <h3>${backup.name}</h3>
                        <p><strong>大小:</strong> ${formatSize(backup.size)}</p>
                        <p><strong>创建时间:</strong> ${formatTime(backup.createdAt)}</p>
                    </div>
                    <div class="backup-actions">
                        <button class="btn btn-primary" onclick="restoreFromBackup('${backup.id}')">
                            <i class="ri-refresh-line"></i> 恢复
                        </button>
                    </div>
                `;
                restoreList.appendChild(backupItem);
            });
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/storage/settings');
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    const settings = result.data;
                    document.getElementById('storage-path').value = settings.storagePath || '';
                    document.getElementById('max-storage').value = settings.maxStorage || '';
                    document.getElementById('backup-retention').value = settings.backupRetention || '';
                    document.getElementById('auto-backup').value = settings.autoBackup || 'disabled';
                }
            } catch (error) {
                console.error('加载设置错误:', error);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').style.display = 'block';
        }

        async function createBackup() {
            try {
                const response = await fetch('/api/admin/storage/backup', {
                    method: 'POST'
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess('备份创建成功');
                    loadBackupList();
                    loadRestoreList();
                } else {
                    showError('备份创建失败');
                }
            } catch (error) {
                console.error('创建备份错误:', error);
                showError('备份创建失败');
            }
        }

        async function downloadBackup(backupId) {
            try {
                const response = await fetch(`/api/admin/storage/backups/${backupId}/download`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup-${backupId}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    showError('下载备份失败');
                }
            } catch (error) {
                console.error('下载备份错误:', error);
                showError('下载备份失败');
            }
        }

        async function restoreFromBackup(backupId) {
            if (!confirm('确定要从此备份恢复吗？此操作将覆盖当前数据。')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/storage/backups/${backupId}/restore`, {
                    method: 'POST'
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess('数据恢复成功');
                    loadStorageStatus();
                } else {
                    showError('数据恢复失败');
                }
            } catch (error) {
                console.error('恢复数据错误:', error);
                showError('数据恢复失败');
            }
        }

        async function deleteBackup(backupId) {
            if (!confirm('确定要删除此备份吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/storage/backups/${backupId}`, {
                    method: 'DELETE'
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess('备份删除成功');
                    loadBackupList();
                    loadRestoreList();
                } else {
                    showError('备份删除失败');
                }
            } catch (error) {
                console.error('删除备份错误:', error);
                showError('备份删除失败');
            }
        }

        async function performClean() {
            const cleanTemp = document.getElementById('clean-temp').checked;
            const cleanCache = document.getElementById('clean-cache').checked;
            const cleanLogs = document.getElementById('clean-logs').checked;
            const cleanOldBackups = document.getElementById('clean-old-backups').checked;
            
            if (!cleanTemp && !cleanCache && !cleanLogs && !cleanOldBackups) {
                showError('请至少选择一个清理选项');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/storage/clean', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cleanTemp: cleanTemp,
                        cleanCache: cleanCache,
                        cleanLogs: cleanLogs,
                        cleanOldBackups: cleanOldBackups
                    })
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess(`清理完成，释放空间: ${formatSize(result.data.freedSpace)}`);
                    loadStorageStatus();
                } else {
                    showError('清理失败');
                }
            } catch (error) {
                console.error('清理错误:', error);
                showError('清理失败');
            }
        }

        async function saveSettings() {
            const storagePath = document.getElementById('storage-path').value;
            const maxStorage = document.getElementById('max-storage').value;
            const backupRetention = document.getElementById('backup-retention').value;
            const autoBackup = document.getElementById('auto-backup').value;
            
            try {
                const response = await fetch('/api/admin/storage/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        storagePath: storagePath,
                        maxStorage: maxStorage,
                        backupRetention: backupRetention,
                        autoBackup: autoBackup
                    })
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`非JSON响应: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess('设置保存成功');
                } else {
                    showError('设置保存失败');
                }
            } catch (error) {
                console.error('保存设置错误:', error);
                showError('设置保存失败');
            }
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>
