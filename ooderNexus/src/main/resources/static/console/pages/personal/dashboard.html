<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人仪表盘 - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/styles.css">
    <link rel="stylesheet" href="/console/css/llm-integration.css">
    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/personal-api.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        <main class="main-content">
            <div class="content-header">
                <h1>个人仪表盘</h1>
                <div class="content-actions">
                    <div class="user-info">
                        <span class="user-name" id="username">用户</span>
                        <i class="ri-user-line"></i>
                    </div>
                </div>
            </div>
            <div class="dashboard-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon ri-lightbulb-line"></div>
                        <div class="stat-info">
                            <h3>我的技能</h3>
                            <p class="stat-value" id="skill-count">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon ri-play-circle-line"></div>
                        <div class="stat-info">
                            <h3>执行次数</h3>
                            <p class="stat-value" id="execution-count">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon ri-share-line"></div>
                        <div class="stat-info">
                            <h3>分享技能</h3>
                            <p class="stat-value" id="shared-count">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon ri-group-line"></div>
                        <div class="stat-info">
                            <h3>我的群组</h3>
                            <p class="stat-value" id="group-count">0</p>
                        </div>
                    </div>
                </div>
                <div class="recent-activities">
                    <h2>最近活动</h2>
                    <div class="activity-list" id="activity-list">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
                <div class="skill-progress">
                    <h2>技能执行统计</h2>
                    <canvas id="execution-chart" width="400" height="200"></canvas>
                </div>
            </div>
        </main>
    </div>
    <script>
        async function initDashboard() {
            try {
                await window.initMenu();
                
                const api = window.personalAPI;
                const stats = await api.getDashboardStats();
                
                if (stats.success && stats.data) {
                    const data = stats.data;
                    
                    document.getElementById('skill-count').textContent = data.totalSkills || 0;
                    document.getElementById('execution-count').textContent = data.totalExecutions || 0;
                    document.getElementById('shared-count').textContent = data.sharedSkills || 0;
                    document.getElementById('group-count').textContent = data.myGroups || 0;
                    
                    if (data.recentActivities && data.recentActivities.length > 0) {
                        const activityList = document.getElementById('activity-list');
                        activityList.innerHTML = data.recentActivities.map(activity => `
                            <div class="activity-item">
                                <div class="activity-icon ri-${getActivityIcon(activity.type)}"></div>
                                <div class="activity-content">
                                    <p>${getActivityText(activity)}</p>
                                    <span class="activity-time">${formatTime(activity.timestamp)}</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('activity-list').innerHTML = '<div class="empty-state">暂无活动记录</div>';
                    }
                    
                    drawExecutionChart(data);
                } else {
                    document.getElementById('activity-list').innerHTML = '<div class="empty-state">加载失败</div>';
                }
                
                try {
                    const identity = await api.getPersonalIdentity();
                    if (identity.success && identity.data) {
                        document.getElementById('username').textContent = identity.data.username || '用户';
                    }
                } catch (error) {
                    console.error('获取用户信息失败:', error);
                }
                
            } catch (error) {
                console.error('初始化仪表盘失败:', error);
                document.getElementById('activity-list').innerHTML = '<div class="empty-state">加载失败</div>';
                showError('加载仪表盘数据失败');
            }
        }
        
        function getActivityIcon(type) {
            const icons = {
                'execution': 'play-circle-line',
                'publish': 'upload-line',
                'share': 'share-line',
                'delete': 'delete-bin-line'
            };
            return icons[type] || 'clock-line';
        }
        
        function getActivityText(activity) {
            if (activity.type === 'execution') {
                return `执行了技能 <span class="activity-skill">${activity.skillName}</span>`;
            } else if (activity.type === 'publish') {
                return `发布了新技能 <span class="activity-skill">${activity.skillName}</span>`;
            } else if (activity.type === 'share') {
                return `分享了技能 <span class="activity-skill">${activity.skillName}</span>`;
            }
            return '未知活动';
        }
        
        function formatTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);
            
            if (diff < 60) {
                return `${diff}秒前`;
            } else if (diff < 3600) {
                return `${Math.floor(diff / 60)}分钟前`;
            } else if (diff < 86400) {
                return `${Math.floor(diff / 3600)}小时前`;
            } else {
                return `${Math.floor(diff / 86400)}天前`;
            }
        }
        
        function drawExecutionChart(data) {
            const canvas = document.getElementById('execution-chart');
            const ctx = canvas.getContext('2d');
            
            const chartData = data.executionStats || [5, 8, 3, 7, 4, 9];
            const labels = ['周一', '周二', '周三', '周四', '周五', '周六'];
            const barWidth = 30;
            const barSpacing = 10;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.beginPath();
            ctx.moveTo(50, 10);
            ctx.lineTo(50, 190);
            ctx.lineTo(390, 190);
            ctx.strokeStyle = '#333';
            ctx.stroke();
            
            chartData.forEach((value, index) => {
                const x = 50 + (barWidth + barSpacing) * index + barSpacing;
                const height = value * 15;
                const y = 190 - height;
                
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(x, y, barWidth, height);
                
                ctx.fillStyle = '#e0e0e0';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(labels[index], x + barWidth / 2, 205);
            });
        }
        
        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'notification notification-error';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
    <script>
        window.onload = function() {
            initMenu();
        };
    </script>
</body>
</html>
