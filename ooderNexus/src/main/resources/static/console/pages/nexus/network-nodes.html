<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络节点管理 - Nexus</title>
    <link rel="stylesheet" href="../../css/remixicon/remixicon.css">
    <link rel="stylesheet" href="../../css/mcpagent/common.css">
    <script src="../../js/theme-manager.js"></script>
</head>
<body class="nexus-page">
    <div class="nexus-container">
        <!-- 侧边导航栏 -->
        <div class="nexus-sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="nexus-main-content">
            <div class="nexus-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h1><i class="ri-node-tree-line"></i> 网络节点管理</h1>
                    <button class="theme-toggle-btn nexus-btn nexus-btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                        <i class="ri-sun-line"></i> 浅色模式
                    </button>
                </div>
                <div class="subtitle">
                    <span class="badge nexus-badge">Nexus</span>
                    <span>管理和监控Nexus网络节点</span>
                </div>
            </div>

            <!-- 节点操作区 -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>节点操作</h3>
                    <button class="nexus-btn nexus-btn-primary" onclick="showAddNodeModal()">
                        <i class="ri-add-circle-line"></i>
                        注册节点
                    </button>
                </div>
                <div class="nexus-card">
                    <div class="nexus-form-container">
                        <div class="nexus-form-row">
                            <div class="nexus-form-group">
                                <label for="nodeId">节点ID</label>
                                <input type="text" id="nodeId" placeholder="输入节点ID" class="nexus-form-input">
                            </div>
                            <div class="nexus-form-group">
                                <label for="nodeName">节点名称</label>
                                <input type="text" id="nodeName" placeholder="输入节点名称" class="nexus-form-input">
                            </div>
                        </div>
                        <div class="nexus-form-row">
                            <div class="nexus-form-group">
                                <label for="nodeType">节点类型</label>
                                <select id="nodeType" class="nexus-form-select">
                                    <option value="mcp">Nexus</option>
                                    <option value="route">Route Agent</option>
                                    <option value="end">End Agent</option>
                                    <option value="gateway">Gateway</option>
                                </select>
                            </div>
                            <div class="nexus-form-group">
                                <label for="nodeDescription">节点描述</label>
                                <textarea id="nodeDescription" placeholder="输入节点描述" class="nexus-form-textarea"></textarea>
                            </div>
                        </div>
                        <div class="nexus-form-actions">
                            <button class="nexus-btn nexus-btn-primary" onclick="registerNetworkNode()">注册节点</button>
                            <button class="nexus-btn nexus-btn-secondary" onclick="removeNetworkNode()">移除节点</button>
                            <button class="nexus-btn nexus-btn-secondary" onclick="refreshNetworkNodes()">刷新列表</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 网络连接操作 -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>网络连接</h3>
                    <button class="nexus-btn nexus-btn-primary" onclick="showAddConnectionModal()">
                        <i class="ri-link-add-line"></i>
                        创建连接
                    </button>
                </div>
                <div class="nexus-card">
                    <div class="nexus-form-container">
                        <div class="nexus-form-row">
                            <div class="nexus-form-group">
                                <label for="sourceNodeId">源节点ID</label>
                                <input type="text" id="sourceNodeId" placeholder="输入源节点ID" class="nexus-form-input">
                            </div>
                            <div class="nexus-form-group">
                                <label for="targetNodeId">目标节点ID</label>
                                <input type="text" id="targetNodeId" placeholder="输入目标节点ID" class="nexus-form-input">
                            </div>
                        </div>
                        <div class="nexus-form-row">
                            <div class="nexus-form-group">
                                <label for="connectionType">连接类型</label>
                                <select id="connectionType" class="nexus-form-select">
                                    <option value="direct">直接连接</option>
                                    <option value="indirect">间接连接</option>
                                </select>
                            </div>
                        </div>
                        <div class="nexus-form-actions">
                            <button class="nexus-btn nexus-btn-primary" onclick="createNetworkConnection()">创建连接</button>
                            <button class="nexus-btn nexus-btn-secondary" onclick="disconnectNetworkConnection()">断开连接</button>
                            <button class="nexus-btn nexus-btn-secondary" onclick="refreshConnections()">刷新连接</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 节点列表 -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>节点列表</h3>
                    <div class="nexus-search-box">
                        <input type="text" id="nodeSearch" placeholder="搜索节点..." class="nexus-search-input">
                        <button onclick="searchNodes()" class="nexus-btn nexus-btn-secondary"><i class="ri-search-line"></i></button>
                    </div>
                </div>
                <div class="nexus-card">
                    <table class="nexus-data-table">
                        <thead>
                            <tr>
                                <th>节点ID</th>
                                <th>节点名称</th>
                                <th>节点类型</th>
                                <th>节点描述</th>
                                <th>注册时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="nodeTableBody">
                            <!-- 节点数据将通过JS动态填充 -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 连接列表 -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>连接列表</h3>
                    <div class="nexus-search-box">
                        <input type="text" id="connectionSearch" placeholder="搜索连接..." class="nexus-search-input">
                        <button onclick="searchConnections()" class="nexus-btn nexus-btn-secondary"><i class="ri-search-line"></i></button>
                    </div>
                </div>
                <div class="nexus-card">
                    <table class="nexus-data-table">
                        <thead>
                            <tr>
                                <th>连接ID</th>
                                <th>源节点</th>
                                <th>目标节点</th>
                                <th>连接类型</th>
                                <th>创建时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="connectionTableBody">
                            <!-- 连接数据将通过JS动态填充 -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- 公共JS模块 -->
    <script src="../../js/menu-loader.js"></script>
    <script src="../../js/nexus/base.js"></script>
    <script src="../../js/nexus/api.js"></script>
    <script src="../../js/nexus/ui.js"></script>
    <script src="../../js/nexus/utils.js"></script>
    <script src="../../js/nexus/sdk-proxy.js"></script>
    <script src="../../js/nexus/common.js"></script>
    <script>
        window.onload = function() {
            // 初始化菜单
            initMenu();
            // 初始化页面
            nexusCommon.initPage('network-nodes', loadNetworkNodes);
        };

        // 模拟网络节点数据
        let networkNodes = [];
        let networkConnections = [];

        function loadNetworkNodes() {
            // 模拟加载网络节点数据
            networkNodes = [
                {
                    id: "mcp-agent-001",
                    name: "主Nexus",
                    type: "mcp",
                    description: "主Nexus节点",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "route-agent-001",
                    name: "路由代理1",
                    type: "route",
                    description: "网络路由管理代理",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "end-agent-001",
                    name: "终端代理1",
                    type: "end",
                    description: "智能终端代理",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "gateway-001",
                    name: "网关",
                    type: "gateway",
                    description: "网络网关",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                }
            ];
            renderNetworkNodes();
        }

        function loadNetworkConnections() {
            // 模拟加载网络连接数据
            networkConnections = [
                {
                    id: "conn-001",
                    sourceNodeId: "mcp-agent-001",
                    targetNodeId: "route-agent-001",
                    type: "direct",
                    createTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "conn-002",
                    sourceNodeId: "route-agent-001",
                    targetNodeId: "end-agent-001",
                    type: "direct",
                    createTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "conn-003",
                    sourceNodeId: "mcp-agent-001",
                    targetNodeId: "gateway-001",
                    type: "direct",
                    createTime: new Date().toISOString(),
                    status: "active"
                }
            ];
            renderNetworkConnections();
        }

        function renderNetworkNodes() {
            const tbody = document.getElementById('nodeTableBody');
            tbody.innerHTML = '';

            networkNodes.forEach(node => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${node.id}</td>
                    <td>${node.name}</td>
                    <td>${getNodeTypeName(node.type)}</td>
                    <td>${node.description}</td>
                    <td>${new Date(node.registeredTime).toLocaleString()}</td>
                    <td><span class="nexus-status-badge ${node.status}">${node.status === 'active' ? '活跃' : '禁用'}</span></td>
                    <td>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-primary" onclick="selectNetworkNode('${node.id}')">选择</button>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="removeNetworkNodeById('${node.id}')">移除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderNetworkConnections() {
            const tbody = document.getElementById('connectionTableBody');
            tbody.innerHTML = '';

            networkConnections.forEach(connection => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${connection.id}</td>
                    <td>${connection.sourceNodeId}</td>
                    <td>${connection.targetNodeId}</td>
                    <td>${connection.type === 'direct' ? '直接连接' : '间接连接'}</td>
                    <td>${new Date(connection.createTime).toLocaleString()}</td>
                    <td><span class="nexus-status-badge ${connection.status}">${connection.status === 'active' ? '活跃' : '断开'}</span></td>
                    <td>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="disconnectNetworkConnectionById('${connection.id}')">断开</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function registerNetworkNode() {
            const nodeId = document.getElementById('nodeId').value;
            const nodeName = document.getElementById('nodeName').value;
            const nodeType = document.getElementById('nodeType').value;
            const nodeDescription = document.getElementById('nodeDescription').value;

            if (!nodeId) {
                nexusCommon.showMessage('请输入节点ID', 'error');
                return;
            }

            // 检查节点是否已存在
            const existingNode = networkNodes.find(n => n.id === nodeId);
            if (existingNode) {
                nexusCommon.showMessage('节点ID已存在', 'error');
                return;
            }

            // 添加新节点
            const newNode = {
                id: nodeId,
                name: nodeName || nodeId,
                type: nodeType,
                description: nodeDescription || '无描述',
                registeredTime: new Date().toISOString(),
                status: 'active'
            };

            networkNodes.push(newNode);
            renderNetworkNodes();
            clearNodeForm();
            nexusCommon.showMessage('节点注册成功', 'success');
        }

        function removeNetworkNode() {
            const nodeId = document.getElementById('nodeId').value;
            if (!nodeId) {
                nexusCommon.showMessage('请输入节点ID', 'error');
                return;
            }
            removeNetworkNodeById(nodeId);
        }

        function removeNetworkNodeById(nodeId) {
            const index = networkNodes.findIndex(n => n.id === nodeId);
            if (index === -1) {
                nexusCommon.showMessage('节点不存在', 'error');
                return;
            }

            // 同时移除相关的网络连接
            networkConnections = networkConnections.filter(conn => 
                conn.sourceNodeId !== nodeId && conn.targetNodeId !== nodeId
            );

            networkNodes.splice(index, 1);
            renderNetworkNodes();
            renderNetworkConnections();
            nexusCommon.showMessage('节点移除成功', 'success');
        }

        function createNetworkConnection() {
            const sourceNodeId = document.getElementById('sourceNodeId').value;
            const targetNodeId = document.getElementById('targetNodeId').value;
            const connectionType = document.getElementById('connectionType').value;

            if (!sourceNodeId || !targetNodeId) {
                nexusCommon.showMessage('请输入源节点ID和目标节点ID', 'error');
                return;
            }

            // 检查源节点和目标节点是否存在
            const sourceNode = networkNodes.find(n => n.id === sourceNodeId);
            const targetNode = networkNodes.find(n => n.id === targetNodeId);
            if (!sourceNode || !targetNode) {
                nexusCommon.showMessage('源节点或目标节点不存在', 'error');
                return;
            }

            // 检查连接是否已存在
            const existingConnection = networkConnections.find(conn => 
                (conn.sourceNodeId === sourceNodeId && conn.targetNodeId === targetNodeId) ||
                (conn.sourceNodeId === targetNodeId && conn.targetNodeId === sourceNodeId)
            );
            if (existingConnection) {
                nexusCommon.showMessage('连接已存在', 'error');
                return;
            }

            // 创建新连接
            const newConnection = {
                id: 'conn-' + Date.now(),
                sourceNodeId: sourceNodeId,
                targetNodeId: targetNodeId,
                type: connectionType,
                createTime: new Date().toISOString(),
                status: 'active'
            };

            networkConnections.push(newConnection);
            renderNetworkConnections();
            clearConnectionForm();
            nexusCommon.showMessage('连接创建成功', 'success');
        }

        function disconnectNetworkConnection() {
            const connectionId = prompt('请输入要断开的连接ID:');
            if (!connectionId) {
                return;
            }
            disconnectNetworkConnectionById(connectionId);
        }

        function disconnectNetworkConnectionById(connectionId) {
            const index = networkConnections.findIndex(conn => conn.id === connectionId);
            if (index === -1) {
                nexusCommon.showMessage('连接不存在', 'error');
                return;
            }

            networkConnections.splice(index, 1);
            renderNetworkConnections();
            nexusCommon.showMessage('连接断开成功', 'success');
        }

        function selectNetworkNode(nodeId) {
            const node = networkNodes.find(n => n.id === nodeId);
            if (node) {
                document.getElementById('nodeId').value = node.id;
                document.getElementById('nodeName').value = node.name;
                document.getElementById('nodeType').value = node.type;
                document.getElementById('nodeDescription').value = node.description;
            }
        }

        function refreshNetworkNodes() {
            loadNetworkNodes();
            nexusCommon.showMessage('节点列表已刷新', 'success');
        }

        function refreshConnections() {
            loadNetworkConnections();
            nexusCommon.showMessage('连接列表已刷新', 'success');
        }

        function searchNodes() {
            const searchTerm = document.getElementById('nodeSearch').value.toLowerCase();
            const filteredNodes = networkNodes.filter(n => 
                n.id.toLowerCase().includes(searchTerm) ||
                n.name.toLowerCase().includes(searchTerm) ||
                n.description.toLowerCase().includes(searchTerm)
            );

            const tbody = document.getElementById('nodeTableBody');
            tbody.innerHTML = '';

            filteredNodes.forEach(node => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${node.id}</td>
                    <td>${node.name}</td>
                    <td>${getNodeTypeName(node.type)}</td>
                    <td>${node.description}</td>
                    <td>${new Date(node.registeredTime).toLocaleString()}</td>
                    <td><span class="nexus-status-badge ${node.status}">${node.status === 'active' ? '活跃' : '禁用'}</span></td>
                    <td>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-primary" onclick="selectNetworkNode('${node.id}')">选择</button>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="removeNetworkNodeById('${node.id}')">移除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchConnections() {
            const searchTerm = document.getElementById('connectionSearch').value.toLowerCase();
            const filteredConnections = networkConnections.filter(conn => 
                conn.id.toLowerCase().includes(searchTerm) ||
                conn.sourceNodeId.toLowerCase().includes(searchTerm) ||
                conn.targetNodeId.toLowerCase().includes(searchTerm)
            );

            const tbody = document.getElementById('connectionTableBody');
            tbody.innerHTML = '';

            filteredConnections.forEach(connection => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${connection.id}</td>
                    <td>${connection.sourceNodeId}</td>
                    <td>${connection.targetNodeId}</td>
                    <td>${connection.type === 'direct' ? '直接连接' : '间接连接'}</td>
                    <td>${new Date(connection.createTime).toLocaleString()}</td>
                    <td><span class="nexus-status-badge ${connection.status}">${connection.status === 'active' ? '活跃' : '断开'}</span></td>
                    <td>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="disconnectNetworkConnectionById('${connection.id}')">断开</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function clearNodeForm() {
            document.getElementById('nodeId').value = '';
            document.getElementById('nodeName').value = '';
            document.getElementById('nodeType').value = 'mcp';
            document.getElementById('nodeDescription').value = '';
        }

        function clearConnectionForm() {
            document.getElementById('sourceNodeId').value = '';
            document.getElementById('targetNodeId').value = '';
            document.getElementById('connectionType').value = 'direct';
        }

        function getNodeTypeName(nodeType) {
            const typeMap = {
                'mcp': 'Nexus',
                'route': 'Route Agent',
                'end': 'End Agent',
                'gateway': 'Gateway'
            };
            return typeMap[nodeType] || nodeType;
        }

        function showAddNodeModal() {
            // 这里可以实现模态框逻辑
            nexusCommon.showMessage('注册节点功能', 'info');
        }

        function showAddConnectionModal() {
            // 这里可以实现模态框逻辑
            nexusCommon.showMessage('创建连接功能', 'info');
        }

        function loadNetworkNodes() {
            // 模拟加载网络节点数据
            networkNodes = [
                {
                    id: "mcp-agent-001",
                    name: "主Nexus",
                    type: "mcp",
                    description: "主Nexus节点",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "route-agent-001",
                    name: "路由代理1",
                    type: "route",
                    description: "网络路由管理代理",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "end-agent-001",
                    name: "终端代理1",
                    type: "end",
                    description: "智能终端代理",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "gateway-001",
                    name: "网关",
                    type: "gateway",
                    description: "网络网关",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                }
            ];
            renderNetworkNodes();
        }

        function loadNetworkConnections() {
            // 模拟加载网络连接数据
            networkConnections = [
                {
                    id: "conn-001",
                    sourceNodeId: "mcp-agent-001",
                    targetNodeId: "route-agent-001",
                    type: "direct",
                    createTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "conn-002",
                    sourceNodeId: "route-agent-001",
                    targetNodeId: "end-agent-001",
                    type: "direct",
                    createTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    id: "conn-003",
                    sourceNodeId: "mcp-agent-001",
                    targetNodeId: "gateway-001",
                    type: "direct",
                    createTime: new Date().toISOString(),
                    status: "active"
                }
            ];
            renderNetworkConnections();
        }
    </script>
</body>
</html>
