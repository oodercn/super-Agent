<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全管理 - Nexus - Nexus</title>
    <link rel="stylesheet" href="../../css/remixicon/remixicon.css">
    <link rel="stylesheet" href="../../css/dashboard.css">
    <link rel="stylesheet" href="../../css/mcpagent/common.css">
    <script src="../../js/theme-manager.js"></script>
    <script src="../../js/nexus/base.js"></script>
    <script src="../../js/nexus/api.js"></script>
    <script src="../../js/nexus/ui.js"></script>
    <script src="../../js/nexus/utils.js"></script>
    <script src="../../js/nexus/sdk-proxy.js"></script>
    <script src="../../js/nexus/common.js"></script>
</head>
<body class="nexus-page">
    <div class="nexus-container">
        <!-- 侧边导航栏 -->
        <div class="nexus-sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="nexus-main-content">
            <div class="nexus-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h1><i class="ri-shield-check-line"></i> 安全管理</h1>
                    <button class="theme-toggle-btn nexus-btn nexus-btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                        <i class="ri-sun-line"></i> 浅色模式
                    </button>
                </div>
                <div class="subtitle">
                    <span class="badge dashboard-badge" style="background-color: var(--nexus-primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-right: 16px;">Nexus</span>
                    <span>管理Nexus系统安全设置</span>
                </div>
            </div>

            <!-- 安全状态概览 -->
            <section class="nexus-section">
                <div class="nexus-section-header">
                    <h3>安全状态</h3>
                    <button class="nexus-btn nexus-btn-secondary" onclick="refreshSecurityStatus()">
                        <i class="ri-refresh-line"></i>
                        刷新
                    </button>
                </div>
                <div class="nexus-status-grid">
                    <div class="nexus-status-card">
                        <div class="nexus-status-icon">
                            <i class="ri-shield-check-line"></i>
                        </div>
                        <div class="nexus-status-info">
                            <h3>安全状态</h3>
                            <p class="nexus-status-value" id="securityStatus">安全</p>
                        </div>
                    </div>
                    <div class="nexus-status-card">
                        <div class="nexus-status-icon">
                            <i class="ri-user-line"></i>
                        </div>
                        <div class="nexus-status-info">
                            <h3>用户数</h3>
                            <p class="nexus-status-value" id="userCount">5</p>
                        </div>
                    </div>
                    <div class="nexus-status-card">
                        <div class="nexus-status-icon">
                            <i class="ri-lock-line"></i>
                        </div>
                        <div class="nexus-status-info">
                            <h3>活跃会话</h3>
                            <p class="nexus-status-value" id="activeSessions">2</p>
                        </div>
                    </div>
                    <div class="nexus-status-card">
                        <div class="nexus-status-icon">
                            <i class="ri-alert-line"></i>
                        </div>
                        <div class="nexus-status-info">
                            <h3>安全事件</h3>
                            <p class="nexus-status-value" id="securityEvents">0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 用户管理 -->
            <section class="nexus-section">
                <div class="nexus-section-header">
                    <h3>用户管理</h3>
                    <button class="nexus-btn nexus-btn-primary" onclick="addUser()">
                        <i class="ri-user-add-line"></i>
                        添加用户
                    </button>
                </div>
                <div class="nexus-card">
                    <table class="nexus-data-table">
                        <thead>
                            <tr>
                                <th>用户名</th>
                                <th>角色</th>
                                <th>状态</th>
                                <th>最后登录</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- 用户数据将通过JS动态填充 -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 权限管理 -->
            <section class="nexus-section">
                <div class="nexus-section-header">
                    <h3>权限管理</h3>
                </div>
                <div class="nexus-card">
                    <div class="nexus-stats-grid">
                        <div class="nexus-stats-card">
                            <h4>个人用户</h4>
                            <ul class="nexus-permission-list">
                                <li><input type="checkbox" checked> 查看仪表盘</li>
                                <li><input type="checkbox" checked> 管理终端</li>
                                <li><input type="checkbox" checked> 查看网络状态</li>
                                <li><input type="checkbox"> 管理用户</li>
                                <li><input type="checkbox"> 修改系统配置</li>
                            </ul>
                        </div>
                        <div class="nexus-stats-card">
                            <h4>家庭用户</h4>
                            <ul class="nexus-permission-list">
                                <li><input type="checkbox" checked> 查看仪表盘</li>
                                <li><input type="checkbox" checked> 管理终端</li>
                                <li><input type="checkbox" checked> 查看网络状态</li>
                                <li><input type="checkbox" checked> 管理网络设置</li>
                                <li><input type="checkbox"> 管理用户</li>
                                <li><input type="checkbox"> 修改系统配置</li>
                            </ul>
                        </div>
                        <div class="nexus-stats-card">
                            <h4>企业用户</h4>
                            <ul class="nexus-permission-list">
                                <li><input type="checkbox" checked> 查看仪表盘</li>
                                <li><input type="checkbox" checked> 管理终端</li>
                                <li><input type="checkbox" checked> 查看网络状态</li>
                                <li><input type="checkbox" checked> 管理网络设置</li>
                                <li><input type="checkbox" checked> 管理用户</li>
                                <li><input type="checkbox" checked> 修改系统配置</li>
                                <li><input type="checkbox" checked> 查看系统日志</li>
                            </ul>
                        </div>
                    </div>
                    <button class="nexus-btn nexus-btn-primary" onclick="savePermissions()" style="margin-top: 16px;">
                        <i class="ri-save-line"></i>
                        保存权限设置
                    </button>
                </div>
            </section>

            <!-- 安全设置 -->
            <section class="nexus-section">
                <div class="nexus-section-header">
                    <h3>安全设置</h3>
                </div>
                <div class="nexus-card">
                    <div class="nexus-form-container">
                        <div class="nexus-form-group">
                            <label for="passwordPolicy">密码策略</label>
                            <select id="passwordPolicy">
                                <option value="weak">弱（6位以上）</option>
                                <option value="medium" selected>中等（8位以上，包含字母数字）</option>
                                <option value="strong">强（10位以上，包含字母数字特殊字符）</option>
                            </select>
                        </div>
                        <div class="nexus-form-group">
                            <label for="sessionTimeout">会话超时 (分钟)</label>
                            <input type="number" id="sessionTimeout" value="30">
                        </div>
                        <div class="nexus-form-group">
                            <label for="maxLoginAttempts">最大登录尝试次数</label>
                            <input type="number" id="maxLoginAttempts" value="5">
                        </div>
                        <div class="nexus-form-group">
                            <label for="blockDuration">锁定时长 (分钟)</label>
                            <input type="number" id="blockDuration" value="15">
                        </div>
                        <div class="nexus-form-group">
                            <label>
                                <input type="checkbox" id="enableTwoFactor" checked>
                                启用双因素认证
                            </label>
                        </div>
                        <div class="nexus-form-group">
                            <label>
                                <input type="checkbox" id="enableIpRestriction">
                                启用IP限制
                            </label>
                        </div>
                    </div>
                    <button class="nexus-btn nexus-btn-primary" onclick="saveSecuritySettings()" style="margin-top: 16px;">
                        <i class="ri-save-line"></i>
                        保存安全设置
                    </button>
                </div>
            </section>

            <!-- 安全日志 -->
            <section class="nexus-section">
                <div class="nexus-section-header">
                    <h3>安全日志</h3>
                </div>
                <div class="nexus-card">
                    <div class="nexus-log-container" id="securityLogContainer">
                        <!-- 安全日志将通过JS动态填充 -->
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- 公共JS模块 -->
    <script src="../../js/menu-loader.js"></script>
    <script>
        window.onload = function() {
            // 初始化菜单
            initMenu();
            // 初始化页面
            nexusCommon.initPage('security-management', function() {
                loadUserData();
                loadSecurityLogs();
            });
        };

        // 模拟用户数据
        let users = [
            {
                id: 1,
                username: "admin",
                role: "enterprise",
                status: "active",
                lastLogin: new Date(Date.now() - 3600000).toISOString()
            },
            {
                id: 2,
                username: "user1",
                role: "personal",
                status: "active",
                lastLogin: new Date(Date.now() - 7200000).toISOString()
            },
            {
                id: 3,
                username: "user2",
                role: "home",
                status: "inactive",
                lastLogin: new Date(Date.now() - 86400000).toISOString()
            },
            {
                id: 4,
                username: "user3",
                role: "personal",
                status: "active",
                lastLogin: new Date(Date.now() - 172800000).toISOString()
            },
            {
                id: 5,
                username: "user4",
                role: "home",
                status: "active",
                lastLogin: new Date(Date.now() - 259200000).toISOString()
            }
        ];

        // 模拟安全日志
        let securityLogs = [
            {
                timestamp: new Date(Date.now() - 3600000).toISOString(),
                event: "登录成功",
                user: "admin",
                ip: "192.168.1.100"
            },
            {
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                event: "登录成功",
                user: "user1",
                ip: "192.168.1.101"
            },
            {
                timestamp: new Date(Date.now() - 86400000).toISOString(),
                event: "密码修改",
                user: "admin",
                ip: "192.168.1.100"
            }
        ];

        function loadUserData() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role === 'personal' ? '个人' : user.role === 'home' ? '家庭' : '企业'}</td>
                    <td><span class="nexus-status-badge ${user.status === 'active' ? 'nexus-status-active' : 'nexus-status-inactive'}">${user.status === 'active' ? '活跃' : '禁用'}</span></td>
                    <td>${nexusCommon.formatTimestamp(new Date(user.lastLogin).getTime())}</td>
                    <td>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-primary" onclick="editUser(${user.id})">编辑</button>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-secondary" onclick="${user.status === 'active' ? 'disableUser' : 'enableUser'}(${user.id})">${user.status === 'active' ? '禁用' : '启用'}</button>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="deleteUser(${user.id})">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadSecurityLogs() {
            const logContainer = document.getElementById('securityLogContainer');
            logContainer.innerHTML = '';

            securityLogs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'nexus-log-item';
                logItem.innerHTML = `
                    <div class="nexus-log-header">
                        <span class="nexus-log-timestamp">${nexusCommon.formatTimestamp(new Date(log.timestamp).getTime())}</span>
                        <span class="nexus-log-level">${log.event}</span>
                    </div>
                    <div class="nexus-log-message">用户: ${log.user} | IP: ${log.ip}</div>
                `;
                logContainer.appendChild(logItem);
            });
        }

        async function refreshSecurityStatus() {
            try {
                nexusCommon.showMessage('刷新安全状态...', 'info');
                // 模拟刷新
                setTimeout(() => {
                    nexusCommon.showMessage('安全状态已刷新', 'success');
                }, 1000);
            } catch (error) {
                nexusCommon.handleApiError(error, '刷新安全状态失败');
            }
        }

        function addUser() {
            nexusCommon.showMessage('添加用户功能开发中', 'info');
        }

        function editUser(userId) {
            nexusCommon.showMessage('编辑用户功能开发中', 'info');
        }

        function enableUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.status = 'active';
                loadUserData();
                nexusCommon.showMessage('用户已启用', 'success');
            }
        }

        function disableUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.status = 'inactive';
                loadUserData();
                nexusCommon.showMessage('用户已禁用', 'success');
            }
        }

        function deleteUser(userId) {
            if (confirm('确定要删除该用户吗？')) {
                users = users.filter(u => u.id !== userId);
                loadUserData();
                nexusCommon.showMessage('用户已删除', 'success');
            }
        }

        function savePermissions() {
            nexusCommon.showMessage('权限设置已保存', 'success');
        }

        function saveSecuritySettings() {
            nexusCommon.showMessage('安全设置已保存', 'success');
        }
    </script>
</body>
</html>
