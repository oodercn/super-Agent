<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>终端代理管理 - Nexus - Nexus</title>
    <link rel="stylesheet" href="../../css/remixicon/remixicon.css">
    <link rel="stylesheet" href="../../css/mcpagent/common.css">
    <script src="../../js/theme-manager.js"></script>
    <script src="../../js/nexus/base.js"></script>
    <script src="../../js/nexus/api.js"></script>
    <script src="../../js/nexus/ui.js"></script>
    <script src="../../js/nexus/utils.js"></script>
    <script src="../../js/nexus/sdk-proxy.js"></script>
</head>
<body class="nexus-page">
    <div class="nexus-container">
        <!-- 侧边导航栏 -->
        <div class="nexus-sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="nexus-main-content">
            <div class="nexus-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h1><i class="ri-computer-line"></i> 终端代理管理</h1>
                    <button class="theme-toggle-btn nexus-btn nexus-btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                        <i class="ri-sun-line"></i> 浅色模式
                    </button>
                </div>
                <div class="subtitle">
                    <span class="badge nexus-badge">Nexus</span>
                    <span>管理和监控Nexus终端设备</span>
                </div>
            </div>

            <!-- 终端操作区 -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>终端操作</h3>
                    <button class="nexus-btn nexus-btn-primary" onclick="showAddEndAgentModal()">
                        <i class="ri-add-circle-line"></i>
                        添加终端
                    </button>
                </div>
                <div class="nexus-operation-card">
                    <div class="nexus-form-group">
                        <label for="endAgentId">终端ID</label>
                        <input type="text" id="endAgentId" placeholder="输入终端ID">
                    </div>
                    <div class="nexus-form-group">
                        <label for="endAgentName">终端名称</label>
                        <input type="text" id="endAgentName" placeholder="输入终端名称">
                    </div>
                    <div class="nexus-form-group">
                        <label for="endAgentType">终端类型</label>
                        <select id="endAgentType">
                            <option value="light">智能灯泡</option>
                            <option value="socket">智能插座</option>
                            <option value="camera">摄像头</option>
                            <option value="speaker">智能音箱</option>
                            <option value="thermostat">温控器</option>
                            <option value="doorlock">智能门锁</option>
                            <option value="other">其他设备</option>
                        </select>
                    </div>
                    <div class="nexus-form-group">
                        <label for="endAgentIp">IP地址</label>
                        <input type="text" id="endAgentIp" placeholder="输入IP地址">
                    </div>
                    <div class="nexus-form-group">
                        <label for="endAgentMac">MAC地址</label>
                        <input type="text" id="endAgentMac" placeholder="输入MAC地址">
                    </div>
                    <div class="nexus-operation-buttons">
                        <button class="nexus-btn nexus-btn-primary" onclick="addEndAgent()">添加终端</button>
                        <button class="nexus-btn nexus-btn-secondary" onclick="removeEndAgent()">移除终端</button>
                        <button class="nexus-btn nexus-btn-secondary" onclick="getEndAgentDetails()">查看详情</button>
                        <button class="nexus-btn nexus-btn-secondary" onclick="refreshEndAgents()">刷新列表</button>
                    </div>
                </div>
            </section>

            <!-- 终端列表 -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>终端列表</h3>
                    <div class="search-box">
                        <input type="text" id="endAgentSearch" placeholder="搜索终端...">
                        <button class="nexus-btn nexus-btn-secondary" onclick="searchEndAgents()"><i class="ri-search-line"></i></button>
                    </div>
                </div>
                <div class="nexus-card">
                    <table class="nexus-data-table">
                        <thead>
                            <tr>
                                <th>终端ID</th>
                                <th>终端名称</th>
                                <th>终端类型</th>
                                <th>IP地址</th>
                                <th>MAC地址</th>
                                <th>状态</th>
                                <th>最后更新</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="endAgentTableBody">
                            <!-- 终端数据将通过JS动态填充 -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 终端详情 -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>终端详情</h3>
                </div>
                <div class="nexus-card">
                    <div id="endAgentDetailsContent">
                        <p>选择终端查看详情...</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- 公共JS模块 -->
    <script src="../../js/menu-loader.js"></script>
    <script src="../../js/nexus/common.js"></script>
    <script>
        window.onload = function() {
            // 初始化菜单
            initMenu();
            // 初始化页面
            nexusCommon.initPage('endagent-management', loadEndAgents);
        };

        // 模拟终端代理数据
        let endAgents = [];

        async function loadEndAgents() {
            try {
                // 模拟API请求
                const mockResponse = {
                    status: 'success',
                    message: '获取终端列表成功',
                    data: [
                        {
                            id: "endagent-001",
                            name: "智能灯泡1",
                            type: "light",
                            ip: "192.168.1.100",
                            mac: "AA:BB:CC:DD:EE:FF",
                            status: "active",
                            brightness: 80,
                            color: "#FFFFFF",
                            lastUpdate: new Date().toISOString()
                        },
                        {
                            id: "endagent-002",
                            name: "智能插座1",
                            type: "socket",
                            ip: "192.168.1.101",
                            mac: "AA:BB:CC:DD:EE:GG",
                            status: "active",
                            power: "on",
                            voltage: 220,
                            lastUpdate: new Date().toISOString()
                        },
                        {
                            id: "endagent-003",
                            name: "摄像头1",
                            type: "camera",
                            ip: "192.168.1.102",
                            mac: "AA:BB:CC:DD:EE:HH",
                            status: "inactive",
                            resolution: "1080p",
                            storage: "128GB",
                            lastUpdate: new Date().toISOString()
                        },
                        {
                            id: "endagent-004",
                            name: "智能音箱1",
                            type: "speaker",
                            ip: "192.168.1.103",
                            mac: "AA:BB:CC:DD:EE:II",
                            status: "active",
                            volume: 50,
                            lastUpdate: new Date().toISOString()
                        },
                        {
                            id: "endagent-005",
                            name: "温控器1",
                            type: "thermostat",
                            ip: "192.168.1.104",
                            mac: "AA:BB:CC:DD:EE:JJ",
                            status: "active",
                            temperature: 25,
                            humidity: 45,
                            lastUpdate: new Date().toISOString()
                        },
                        {
                            id: "endagent-006",
                            name: "智能门锁1",
                            type: "doorlock",
                            ip: "192.168.1.105",
                            mac: "AA:BB:CC:DD:EE:KK",
                            status: "active",
                            lockStatus: "locked",
                            battery: 80,
                            lastUpdate: new Date().toISOString()
                        }
                    ],
                    timestamp: new Date().getTime()
                };

                // 验证API返回格式
                const validatedResponse = nexusCommon.validateApiResponse(mockResponse);

                if (validatedResponse.status === 'success' && validatedResponse.data) {
                    endAgents = validatedResponse.data;
                    renderEndAgents();
                }
            } catch (error) {
                console.error('加载终端列表失败:', error);
                nexusCommon.showMessage('加载终端列表失败', 'error');
            }
        }

        function renderEndAgents() {
            const tbody = document.getElementById('endAgentTableBody');
            tbody.innerHTML = '';

            endAgents.forEach(endAgent => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${endAgent.id}</td>
                    <td>${endAgent.name}</td>
                    <td>${getEndAgentTypeName(endAgent.type)}</td>
                    <td>${endAgent.ip}</td>
                    <td>${endAgent.mac}</td>
                    <td><span class="nexus-status-badge nexus-status-${endAgent.status === 'active' ? 'active' : 'inactive'}">${endAgent.status === 'active' ? '活跃' : '离线'}</span></td>
                    <td>${new Date(endAgent.lastUpdate).toLocaleString()}</td>
                    <td>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-primary" onclick="selectEndAgent('${endAgent.id}')">选择</button>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="removeEndAgentById('${endAgent.id}')">移除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function addEndAgent() {
            try {
                const endAgentId = document.getElementById('endAgentId').value;
                const endAgentName = document.getElementById('endAgentName').value;
                const endAgentType = document.getElementById('endAgentType').value;
                const endAgentIp = document.getElementById('endAgentIp').value;
                const endAgentMac = document.getElementById('endAgentMac').value;

                if (!endAgentId) {
                    nexusCommon.showMessage('请输入终端ID', 'warning');
                    return;
                }

                // 检查终端是否已存在
                const existingEndAgent = endAgents.find(e => e.id === endAgentId);
                if (existingEndAgent) {
                    nexusCommon.showMessage('终端ID已存在', 'warning');
                    return;
                }

                // 模拟API请求
                const mockResponse = {
                    status: 'success',
                    message: '添加终端成功',
                    data: {
                        id: endAgentId,
                        name: endAgentName || endAgentId,
                        type: endAgentType,
                        ip: endAgentIp || '192.168.1.100',
                        mac: endAgentMac || 'AA:BB:CC:DD:EE:FF',
                        status: 'active',
                        lastUpdate: new Date().toISOString()
                    },
                    timestamp: new Date().getTime()
                };

                // 根据终端类型添加特定属性
                switch (endAgentType) {
                    case 'light':
                        mockResponse.data.brightness = 50;
                        mockResponse.data.color = '#FFFFFF';
                        break;
                    case 'socket':
                        mockResponse.data.power = 'off';
                        mockResponse.data.voltage = 220;
                        break;
                    case 'camera':
                        mockResponse.data.resolution = '720p';
                        mockResponse.data.storage = '64GB';
                        break;
                    case 'speaker':
                        mockResponse.data.volume = 30;
                        break;
                    case 'thermostat':
                        mockResponse.data.temperature = 24;
                        mockResponse.data.humidity = 50;
                        break;
                    case 'doorlock':
                        mockResponse.data.lockStatus = 'locked';
                        mockResponse.data.battery = 100;
                        break;
                }

                // 验证API返回格式
                const validatedResponse = nexusCommon.validateApiResponse(mockResponse);

                if (validatedResponse.status === 'success' && validatedResponse.data) {
                    endAgents.push(validatedResponse.data);
                    renderEndAgents();
                    clearEndAgentForm();
                    nexusCommon.handleApiSuccess(validatedResponse);
                }
            } catch (error) {
                console.error('添加终端失败:', error);
                nexusCommon.handleApiError(error, '添加终端失败');
            }
        }

        function removeEndAgent() {
            const endAgentId = document.getElementById('endAgentId').value;
            if (!endAgentId) {
                nexusCommon.showMessage('请输入终端ID', 'warning');
                return;
            }
            removeEndAgentById(endAgentId);
        }

        async function removeEndAgentById(endAgentId) {
            try {
                const index = endAgents.findIndex(e => e.id === endAgentId);
                if (index === -1) {
                    nexusCommon.showMessage('终端不存在', 'warning');
                    return;
                }

                // 模拟API请求
                const mockResponse = {
                    status: 'success',
                    message: '移除终端成功',
                    timestamp: new Date().getTime()
                };

                // 验证API返回格式
                const validatedResponse = nexusCommon.validateApiResponse(mockResponse);

                if (validatedResponse.status === 'success') {
                    endAgents.splice(index, 1);
                    renderEndAgents();
                    nexusCommon.handleApiSuccess(validatedResponse);
                }
            } catch (error) {
                console.error('移除终端失败:', error);
                nexusCommon.handleApiError(error, '移除终端失败');
            }
        }

        async function getEndAgentDetails() {
            try {
                const endAgentId = document.getElementById('endAgentId').value;
                if (!endAgentId) {
                    nexusCommon.showMessage('请输入终端ID', 'warning');
                    return;
                }

                const endAgent = endAgents.find(e => e.id === endAgentId);
                if (!endAgent) {
                    nexusCommon.showMessage('终端不存在', 'warning');
                    return;
                }

                // 模拟API请求
                const mockResponse = {
                    status: 'success',
                    message: '获取终端详情成功',
                    data: endAgent,
                    timestamp: new Date().getTime()
                };

                // 验证API返回格式
                const validatedResponse = nexusCommon.validateApiResponse(mockResponse);

                if (validatedResponse.status === 'success' && validatedResponse.data) {
                    // 显示终端详情
                    const detailsContent = document.getElementById('endAgentDetailsContent');
                    let html = `
                        <div class="nexus-stats-grid">
                            <div class="nexus-stats-card">
                                <h4>基本信息</h4>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">终端ID:</span>
                                    <span class="nexus-stat-value">${endAgent.id}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">终端名称:</span>
                                    <span class="nexus-stat-value">${endAgent.name}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">终端类型:</span>
                                    <span class="nexus-stat-value">${getEndAgentTypeName(endAgent.type)}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">IP地址:</span>
                                    <span class="nexus-stat-value">${endAgent.ip}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">MAC地址:</span>
                                    <span class="nexus-stat-value">${endAgent.mac}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">状态:</span>
                                    <span class="nexus-stat-value">${endAgent.status === 'active' ? '活跃' : '离线'}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">最后更新:</span>
                                    <span class="nexus-stat-value">${new Date(endAgent.lastUpdate).toLocaleString()}</span>
                                </div>
                    `;

                    // 添加终端类型特定属性
                    switch (endAgent.type) {
                        case 'light':
                            html += `
                                <h4>设备属性</h4>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">亮度:</span>
                                    <span class="nexus-stat-value">${endAgent.brightness}%</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">颜色:</span>
                                    <span class="nexus-stat-value">${endAgent.color}</span>
                                </div>
                            `;
                            break;
                        case 'socket':
                            html += `
                                <h4>设备属性</h4>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">电源状态:</span>
                                    <span class="nexus-stat-value">${endAgent.power === 'on' ? '开启' : '关闭'}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">电压:</span>
                                    <span class="nexus-stat-value">${endAgent.voltage}V</span>
                                </div>
                            `;
                            break;
                        case 'camera':
                            html += `
                                <h4>设备属性</h4>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">分辨率:</span>
                                    <span class="nexus-stat-value">${endAgent.resolution}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">存储容量:</span>
                                    <span class="nexus-stat-value">${endAgent.storage}</span>
                                </div>
                            `;
                            break;
                        case 'speaker':
                            html += `
                                <h4>设备属性</h4>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">音量:</span>
                                    <span class="nexus-stat-value">${endAgent.volume}%</span>
                                </div>
                            `;
                            break;
                        case 'thermostat':
                            html += `
                                <h4>设备属性</h4>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">温度:</span>
                                    <span class="nexus-stat-value">${endAgent.temperature}°C</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">湿度:</span>
                                    <span class="nexus-stat-value">${endAgent.humidity}%</span>
                                </div>
                            `;
                            break;
                        case 'doorlock':
                            html += `
                                <h4>设备属性</h4>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">锁状态:</span>
                                    <span class="nexus-stat-value">${endAgent.lockStatus === 'locked' ? '已锁' : '未锁'}</span>
                                </div>
                                <div class="nexus-stat-item">
                                    <span class="nexus-stat-label">电池电量:</span>
                                    <span class="nexus-stat-value">${endAgent.battery}%</span>
                                </div>
                            `;
                            break;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                    detailsContent.innerHTML = html;
                }
            } catch (error) {
                console.error('获取终端详情失败:', error);
                nexusCommon.handleApiError(error, '获取终端详情失败');
            }
        }

        function selectEndAgent(endAgentId) {
            const endAgent = endAgents.find(e => e.id === endAgentId);
            if (endAgent) {
                document.getElementById('endAgentId').value = endAgent.id;
                document.getElementById('endAgentName').value = endAgent.name;
                document.getElementById('endAgentType').value = endAgent.type;
                document.getElementById('endAgentIp').value = endAgent.ip;
                document.getElementById('endAgentMac').value = endAgent.mac;
                getEndAgentDetails();
            }
        }

        async function refreshEndAgents() {
            try {
                await loadEndAgents();
                nexusCommon.showMessage('终端列表已刷新', 'success');
            } catch (error) {
                console.error('刷新终端列表失败:', error);
                nexusCommon.handleApiError(error, '刷新终端列表失败');
            }
        }

        async function searchEndAgents() {
            try {
                const searchTerm = document.getElementById('endAgentSearch').value.toLowerCase();
                const filteredEndAgents = endAgents.filter(e => 
                    e.id.toLowerCase().includes(searchTerm) ||
                    e.name.toLowerCase().includes(searchTerm) ||
                    e.ip.toLowerCase().includes(searchTerm) ||
                    e.mac.toLowerCase().includes(searchTerm)
                );

                const tbody = document.getElementById('endAgentTableBody');
                tbody.innerHTML = '';

                filteredEndAgents.forEach(endAgent => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${endAgent.id}</td>
                        <td>${endAgent.name}</td>
                        <td>${getEndAgentTypeName(endAgent.type)}</td>
                        <td>${endAgent.ip}</td>
                        <td>${endAgent.mac}</td>
                        <td><span class="nexus-status-badge nexus-status-${endAgent.status === 'active' ? 'active' : 'inactive'}">${endAgent.status === 'active' ? '活跃' : '离线'}</span></td>
                        <td>${new Date(endAgent.lastUpdate).toLocaleString()}</td>
                        <td>
                            <button class="nexus-btn nexus-btn-sm nexus-btn-primary" onclick="selectEndAgent('${endAgent.id}')">选择</button>
                            <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="removeEndAgentById('${endAgent.id}')">移除</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('搜索终端失败:', error);
                nexusCommon.handleApiError(error, '搜索终端失败');
            }
        }

        function clearEndAgentForm() {
            document.getElementById('endAgentId').value = '';
            document.getElementById('endAgentName').value = '';
            document.getElementById('endAgentType').value = 'light';
            document.getElementById('endAgentIp').value = '';
            document.getElementById('endAgentMac').value = '';
        }

        function getEndAgentTypeName(endAgentType) {
            const typeMap = {
                'light': '智能灯泡',
                'socket': '智能插座',
                'camera': '摄像头',
                'speaker': '智能音箱',
                'thermostat': '温控器',
                'doorlock': '智能门锁',
                'other': '其他设备'
            };
            return typeMap[endAgentType] || endAgentType;
        }

        function showAddEndAgentModal() {
            // 这里可以实现模态框逻辑
            nexusCommon.showMessage('添加终端功能', 'info');
        }
    </script>
</body>
</html>
