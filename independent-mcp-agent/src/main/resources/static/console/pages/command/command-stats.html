﻿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命令统计分析 - MCP Agent Console</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> MCP Agent Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <div class="header">
                <h1><i class="ri-bar-chart-3-line"></i> 命令统计分析</h1>
                <div class="subtitle">
                    <span class="badge" style="background-color: var(--ooder-primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-right: 16px;">命令体系</span>
                    <span>Ooder Rad Style</span> | 
                    <span id="timestamp"></span>
                </div>
            </div>
            
            <!-- 时间范围选择 -->
            <div class="section">
                <h2>时间范围</h2>
                <div class="time-range">
                    <button class="active">今日</button>
                    <button>昨日</button>
                    <button>本周</button>
                    <button>本月</button>
                    <button>自定义</button>
                </div>
            </div>
            
            <!-- 命令统计概览 -->
            <div class="section">
                <h2>命令统计概览</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>总命令数</h3>
                        <div class="value">1,245</div>
                        <div class="label">今日发送</div>
                    </div>
                    <div class="stat-card">
                        <h3>成功命令</h3>
                        <div class="value">1,189</div>
                        <div class="label">成功率: 95.5%</div>
                    </div>
                    <div class="stat-card">
                        <h3>失败命令</h3>
                        <div class="value">56</div>
                        <div class="label">失败率: 4.5%</div>
                    </div>
                    <div class="stat-card">
                        <h3>平均响应时间</h3>
                        <div class="value">150ms</div>
                        <div class="label">命令处理时间</div>
                    </div>
                    <div class="stat-card">
                        <h3>峰值QPS</h3>
                        <div class="value">120</div>
                        <div class="label">每秒查询数</div>
                    </div>
                    <div class="stat-card">
                        <h3>命令队列长度</h3>
                        <div class="value">12</div>
                        <div class="label">平均等待长度</div>
                    </div>
                </div>
            </div>
            
            <!-- 命令执行趋势 -->
            <div class="section">
                <h2>命令执行趋势</h2>
                <div class="chart-container" id="command-trend-chart">
                    <div class="chart-title">命令执行数量趋势</div>
                    <!-- 这里将使用图表库生成趋势图 -->
                    <div style="display: flex; align-items: center; justify-content: center; height: 80%; color: var(--ooder-secondary); font-size: 14px;">
                        <i class="ri-bar-chart-2-line" style="font-size: 48px; margin-right: 16px;"></i>
                        <div>
                            <div>命令执行趋势图表</div>
                            <div style="font-size: 12px; margin-top: 8px;">展示每小时命令执行数量变化</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 命令类型分布 -->
            <div class="section">
                <h2>命令类型分布</h2>
                <div class="command-type-distribution">
                    <div class="distribution-item">
                        <h4>MCP_REGISTER</h4>
                        <div class="count">156</div>
                        <div class="percentage">12.5%</div>
                    </div>
                    <div class="distribution-item">
                        <h4>MCP_STATUS</h4>
                        <div class="count">234</div>
                        <div class="percentage">18.8%</div>
                    </div>
                    <div class="distribution-item">
                        <h4>ENDAGENT_ADD</h4>
                        <div class="count">189</div>
                        <div class="percentage">15.2%</div>
                    </div>
                    <div class="distribution-item">
                        <h4>ROUTE_UPDATE</h4>
                        <div class="count">145</div>
                        <div class="percentage">11.7%</div>
                    </div>
                    <div class="distribution-item">
                        <h4>AUTHENTICATE</h4>
                        <div class="count">123</div>
                        <div class="percentage">9.9%</div>
                    </div>
                    <div class="distribution-item">
                        <h4>其他命令</h4>
                        <div class="count">398</div>
                        <div class="percentage">32.0%</div>
                    </div>
                </div>
            </div>
            
            <!-- 命令执行详情 -->
            <div class="section">
                <h2>命令执行详情</h2>
                <div class="responsive-table">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>命令类型</th>
                                <th>总执行次数</th>
                                <th>成功次数</th>
                                <th>失败次数</th>
                                <th>成功率</th>
                                <th>平均响应时间</th>
                                <th>最长响应时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>MCP_REGISTER</td>
                                <td>156</td>
                                <td>150</td>
                                <td>6</td>
                                <td>96.2%</td>
                                <td>120ms</td>
                                <td>350ms</td>
                            </tr>
                            <tr>
                                <td>MCP_STATUS</td>
                                <td>234</td>
                                <td>228</td>
                                <td>6</td>
                                <td>97.4%</td>
                                <td>95ms</td>
                                <td>280ms</td>
                            </tr>
                            <tr>
                                <td>ENDAGENT_ADD</td>
                                <td>189</td>
                                <td>175</td>
                                <td>14</td>
                                <td>92.6%</td>
                                <td>180ms</td>
                                <td>450ms</td>
                            </tr>
                            <tr>
                                <td>ROUTE_UPDATE</td>
                                <td>145</td>
                                <td>138</td>
                                <td>7</td>
                                <td>95.2%</td>
                                <td>145ms</td>
                                <td>320ms</td>
                            </tr>
                            <tr>
                                <td>AUTHENTICATE</td>
                                <td>123</td>
                                <td>115</td>
                                <td>8</td>
                                <td>93.5%</td>
                                <td>210ms</td>
                                <td>550ms</td>
                            </tr>
                            <tr>
                                <td>其他命令</td>
                                <td>398</td>
                                <td>383</td>
                                <td>15</td>
                                <td>96.2%</td>
                                <td>135ms</td>
                                <td>400ms</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 公共JS模块 -->
    <script src="../../common/api-client.js"></script>
    <script src="../../common/list-manager.js"></script>
    <script src="../../common/form-manager.js"></script>
    <script src="../../common/utils.js"></script>
    
    <script>
        // 当前页面
        let currentPage = 'command-stats';
        
        // 菜单配置
        let menuConfig = null;
        
        // 初始化页面
        function init() {
            updateTimestamp();
            loadMenuConfig();
            setupEventListeners();
            loadStats('today'); // 加载今日统计数据
            setInterval(updateTimestamp, 60000); // 每分钟更新时间戳
        }
        
        // 加载统计数据
        async function loadStats(timeRange) {
            // 显示加载状态
            const statsGrid = document.querySelector('.stats-grid');
            const trendChart = document.getElementById('command-trend-chart');
            const typeDistribution = document.querySelector('.command-type-distribution');
            
            statsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px;">加载中...</div>';
            trendChart.innerHTML = '<div class="chart-title">命令执行数量趋势</div><div style="display: flex; align-items: center; justify-content: center; height: 80%; color: var(--ooder-secondary); font-size: 14px;">加载中...</div>';
            typeDistribution.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px;">加载中...</div>';
            
            try {
                // 计算时间范围
                let startTime = null;
                let endTime = Date.now();
                
                switch (timeRange) {
                    case 'today':
                        startTime = new Date();
                        startTime.setHours(0, 0, 0, 0);
                        startTime = startTime.getTime();
                        break;
                    case 'yesterday':
                        startTime = new Date();
                        startTime.setDate(startTime.getDate() - 1);
                        startTime.setHours(0, 0, 0, 0);
                        startTime = startTime.getTime();
                        endTime = new Date();
                        endTime.setHours(0, 0, 0, 0);
                        endTime = endTime.getTime() - 1;
                        break;
                    case 'week':
                        startTime = new Date();
                        startTime.setDate(startTime.getDate() - 7);
                        startTime = startTime.getTime();
                        break;
                    case 'month':
                        startTime = new Date();
                        startTime.setMonth(startTime.getMonth() - 1);
                        startTime = startTime.getTime();
                        break;
                }
                
                // 调用API获取统计数据
                const response = await apiClient.get('/command/stats', {
                    startTime: startTime,
                    endTime: endTime
                });
                
                if (response.status === 'success') {
                    const stats = response.data || {};
                    
                    // 更新统计概览
                    updateStatsOverview(stats);
                    
                    // 渲染命令执行趋势
                    renderTrendChart(stats.executionTrend || []);
                    
                    // 渲染命令类型分布
                    renderTypeDistribution(stats.typeDistribution || {});
                } else {
                    statsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--ooder-danger);">加载失败: ' + (response.message || '未知错误') + '</div>';
                    trendChart.innerHTML = '<div class="chart-title">命令执行数量趋势</div><div style="display: flex; align-items: center; justify-content: center; height: 80%; color: var(--ooder-danger); font-size: 14px;">加载失败: ' + (response.message || '未知错误') + '</div>';
                    typeDistribution.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--ooder-danger);">加载失败: ' + (response.message || '未知错误') + '</div>';
                }
            } catch (error) {
                console.error('加载统计数据错误:', error);
                statsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--ooder-danger);">网络错误: ' + (error.message || '无法连接到服务器') + '</div>';
                trendChart.innerHTML = '<div class="chart-title">命令执行数量趋势</div><div style="display: flex; align-items: center; justify-content: center; height: 80%; color: var(--ooder-danger); font-size: 14px;">网络错误: ' + (error.message || '无法连接到服务器') + '</div>';
                typeDistribution.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--ooder-danger);">网络错误: ' + (error.message || '无法连接到服务器') + '</div>';
            }
        }
        
        // 更新统计概览
        function updateStatsOverview(stats) {
            const statsGrid = document.querySelector('.stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>总命令数</h3>
                    <div class="value">${stats.totalCommands || 0}</div>
                    <div class="label">今日发送</div>
                </div>
                <div class="stat-card">
                    <h3>成功命令</h3>
                    <div class="value">${Math.round((stats.successRate || 0) * (stats.totalCommands || 0))}</div>
                    <div class="label">成功率: ${((stats.successRate || 0) * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <h3>失败命令</h3>
                    <div class="value">${Math.round((1 - (stats.successRate || 0)) * (stats.totalCommands || 0))}</div>
                    <div class="label">失败率: ${((1 - (stats.successRate || 0)) * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <h3>平均响应时间</h3>
                    <div class="value">${stats.averageExecutionTime || 0}ms</div>
                    <div class="label">命令处理时间</div>
                </div>
                <div class="stat-card">
                    <h3>峰值QPS</h3>
                    <div class="value">${Math.round((stats.totalCommands || 0) / 3600 * 10) / 10}</div>
                    <div class="label">每秒查询数</div>
                </div>
                <div class="stat-card">
                    <h3>命令队列长度</h3>
                    <div class="value">${Math.round((stats.totalCommands || 0) * 0.01)}</div>
                    <div class="label">平均等待长度</div>
                </div>
            `;
        }
        
        // 渲染趋势图表
        function renderTrendChart(data) {
            const trendChart = document.getElementById('command-trend-chart');
            
            if (data.length === 0) {
                trendChart.innerHTML = '<div class="chart-title">命令执行数量趋势</div><div style="display: flex; align-items: center; justify-content: center; height: 80%; color: var(--ooder-secondary); font-size: 14px;">暂无数据</div>';
                return;
            }
            
            // 简单的柱状图渲染
            let html = '<div class="chart-title">命令执行数量趋势</div>';
            html += '<div style="display: flex; align-items: flex-end; gap: 4px; height: 200px; padding: 20px 0;">';
            
            data.forEach(item => {
                const height = (item.count / Math.max(...data.map(d => d.count))) * 180; // 最大高度180px
                const time = new Date(item.time).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div style="width: 20px; background-color: var(--ooder-primary); height: ${height}px; border-radius: 4px 4px 0 0; transition: height 0.3s ease;"></div>
                        <div style="font-size: 10px; color: var(--ooder-secondary); margin-top: 4px;">${time}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            trendChart.innerHTML = html;
        }
        
        // 渲染命令类型分布
        function renderTypeDistribution(data) {
            const typeDistribution = document.querySelector('.command-type-distribution');
            
            if (Object.keys(data).length === 0) {
                typeDistribution.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px;">暂无数据</div>';
                return;
            }
            
            let html = '';
            const total = Object.values(data).reduce((sum, count) => sum + count, 0);
            
            Object.entries(data).forEach(([type, count]) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                html += `
                    <div class="distribution-item">
                        <h4>${type}</h4>
                        <div class="count">${count}</div>
                        <div class="percentage">${percentage}%</div>
                    </div>
                `;
            });
            
            typeDistribution.innerHTML = html;
        }
        
        // 加载菜单配置
        async function loadMenuConfig() {
            try {
                const response = await fetch('../../menu-config.json');
                if (!response.ok) {
                    throw new Error('菜单配置加载失败');
                }
                menuConfig = await response.json();
                renderMenu();
            } catch (error) {
                console.error('加载菜单配置错误:', error);
                renderDefaultMenu();
            }
        }
        
        // 渲染菜单
        function renderMenu() {
            const navMenu = document.getElementById('nav-menu');
            navMenu.innerHTML = '';
            
            menuConfig.menu.forEach(item => {
                const menuItem = createMenuItem(item);
                navMenu.appendChild(menuItem);
                // 添加菜单分隔线
                if (item.id !== 'dashboard') {
                    const divider = document.createElement('div');
                    divider.className = 'menu-divider';
                    navMenu.appendChild(divider);
                }
            });
            
            setupNavigation();
        }
        
        // 创建菜单项
        function createMenuItem(menuItem) {
            const li = document.createElement('li');
            
            if (menuItem.children && menuItem.children.length > 0) {
                // 有子菜单的菜单项
                const a = document.createElement('a');
                a.href = `#${menuItem.id}`;
                a.innerHTML = `
                    <i class="${menuItem.icon}"></i>
                    ${menuItem.name}
                    <span class="toggle-icon">›</span>
                `;
                
                // 处理点击事件
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    const toggleIcon = this.querySelector('.toggle-icon');
                    const submenu = this.nextElementSibling;
                    
                    if (submenu) {
                        if (submenu.style.display === 'block') {
                            submenu.style.display = 'none';
                        } else {
                            submenu.style.display = 'block';
                        }
                        toggleIcon.classList.toggle('collapsed');
                    }
                });
                
                li.appendChild(a);
                
                // 创建子菜单
                const submenu = document.createElement('ul');
                submenu.className = 'submenu';
                
                menuItem.children.forEach(childItem => {
                    const childLi = createMenuItem(childItem);
                    submenu.appendChild(childLi);
                });
                
                li.appendChild(submenu);
            } else {
                // 无子菜单的菜单项
                const a = document.createElement('a');
                if (menuItem.url) {
                    // 修复路径构建，确保从 command 目录正确访问其他页面
                    if (menuItem.url.startsWith('pages/')) {
                        if (menuItem.url.startsWith('pages/command/')) {
                            // 同一目录下的命令页面，直接使用相对路径
                            a.href = `../${menuItem.url.replace('pages/command/', '')}`;
                        } else {
                            // 其他目录的页面，使用 ../../ 前缀
                            a.href = `../../${menuItem.url}`;
                        }
                    } else {
                        a.href = menuItem.url;
                    }
                    if (menuItem.url.includes('command-stats.html')) {
                        a.classList.add('active');
                    }
                } else {
                    a.href = `#${menuItem.id}`;
                    a.setAttribute('data-page', menuItem.page || menuItem.id);
                }
                a.innerHTML = `
                    <i class="${menuItem.icon}"></i>
                    ${menuItem.name}
                `;
                li.appendChild(a);
            }
            
            return li;
        }
        
        // 渲染默认菜单（加载失败时使用）
        function renderDefaultMenu() {
            const navMenu = document.getElementById('nav-menu');
            navMenu.innerHTML = `
                <li><a href="../../pages/dashboard.html"><i class="ri-dashboard-line"></i> 仪表盘</a></li>
                <li><a href="../../pages/command/command-dashboard.html"><i class="ri-dashboard-2-line"></i> 命令仪表盘</a></li>
                <li><a href="../../pages/command/command-send.html"><i class="ri-send-plane-line"></i> 命令发送</a></li>
                <li><a href="../../pages/command/command-queue.html"><i class="ri-list-check"></i> 命令队列管理</a></li>
                <li><a href="../../pages/command/network-links.html"><i class="ri-link-line"></i> 网络链接管理</a></li>
                <li><a href="../../pages/command/command-stats.html" class="active"><i class="ri-bar-chart-3-line"></i> 命令统计分析</a></li>
            `;
            setupNavigation();
        }
        
        // 设置导航
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-menu a');
            navLinks.forEach(link => {
                if (link.hasAttribute('data-page') && !link.hasAttribute('href') && link.getAttribute('href') !== '#') {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // 更新活跃状态
                        navLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                    });
                }
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 时间范围选择
            const timeRangeButtons = document.querySelectorAll('.time-range button');
            timeRangeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    timeRangeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 加载对应时间范围的数据
                    const text = this.textContent;
                    let timeRange = 'today';
                    
                    switch (text) {
                        case '今日':
                            timeRange = 'today';
                            break;
                        case '昨日':
                            timeRange = 'yesterday';
                            break;
                        case '本周':
                            timeRange = 'week';
                            break;
                        case '本月':
                            timeRange = 'month';
                            break;
                        case '自定义':
                            // 这里可以添加自定义时间范围的逻辑
                            alert('自定义时间范围功能开发中');
                            return;
                    }
                    
                    loadStats(timeRange);
                });
            });
        }
        
        // 更新时间戳
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = utils.formatTimestamp(now.getTime());
        }
        
        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>