﻿﻿﻿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统服务管理 - OoderAgent 控制台</title>
    <link rel="preload" href="/console/css/remixicon/remixicon.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/console/css/remixicon/remixicon.css"></noscript>
    <link rel="stylesheet" href="../../css/main.css">
    <style>
        /* 服务管理页面特有样式 */
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .service-card {
            background-color: var(--ooder-card-bg);
            border-radius: var(--ooder-radius);
            border: 1px solid var(--ooder-border);
            padding: 24px;
            box-shadow: var(--ooder-shadow);
            transition: all 0.3s ease;
        }
        
        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
        }
        
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .service-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--ooder-text);
        }
        
        .service-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-running {
            background-color: rgba(34, 197, 94, 0.2);
            color: var(--ooder-success);
        }
        
        .status-stopped {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--ooder-danger);
        }
        
        .status-warning {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--ooder-warning);
        }
        
        .service-metrics {
            margin: 20px 0;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--ooder-border);
        }
        
        .metric-label {
            color: var(--ooder-secondary);
            font-size: 14px;
        }
        
        .metric-value {
            color: var(--ooder-text);
            font-weight: 500;
        }
        
        .service-actions {
            margin-top: 24px;
            display: flex;
            gap: 12px;
        }
        
        .service-details {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--ooder-border);
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .detail-label {
            color: var(--ooder-secondary);
        }
        
        .detail-value {
            color: var(--ooder-text);
        }
        
        .service-dashboard {
            background-color: var(--ooder-card-bg);
            border-radius: var(--ooder-radius);
            border: 1px solid var(--ooder-border);
            padding: 24px;
            box-shadow: var(--ooder-shadow);
            margin-bottom: 32px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .dashboard-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--ooder-text);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background-color: var(--ooder-light);
            border-radius: var(--ooder-radius);
            padding: 20px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--ooder-primary);
            margin-bottom: 8px;
        }
        
        .summary-label {
            font-size: 14px;
            color: var(--ooder-secondary);
        }
        
        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--ooder-border);
            border-top: 3px solid var(--ooder-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--ooder-danger);
            color: white;
            padding: 16px 24px;
            border-radius: var(--ooder-radius);
            box-shadow: var(--ooder-shadow);
            z-index: 9999;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .error-toast.active {
            opacity: 1;
            transform: translateX(0);
        }
        
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--ooder-success);
            color: white;
            padding: 16px 24px;
            border-radius: var(--ooder-radius);
            box-shadow: var(--ooder-shadow);
            z-index: 9999;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .success-toast.active {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text" style="margin-top: 16px; color: var(--ooder-secondary); font-size: 14px;">加载中...</div>
        </div>
    </div>
    
    <div class="error-toast" id="error-toast">
        <div class="message" id="error-message"></div>
        <div class="close" onclick="hideErrorToast()">&times;</div>
    </div>
    
    <div class="success-toast" id="success-toast">
        <div class="message" id="success-message"></div>
    </div>
    
    <div class="main-content">
        <div class="header">
            <h1><i class="ri-server-line"></i> 系统服务管理</h1>
            <div class="subtitle">
                <span class="badge" style="background-color: var(--ooder-primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-right: 16px;">v0.6.5</span>
                <span>Ooder Rad Style</span> | 
                <span id="timestamp"></span>
            </div>
        </div>
        
        <!-- 服务概览面板 -->
        <div class="service-dashboard">
            <div class="dashboard-header">
                <h2 class="dashboard-title"><i class="ri-dashboard-line"></i> 服务概览</h2>
                <button class="btn btn-secondary refresh-btn" onclick="refreshAllServices()">
                    <i class="ri-refresh-line"></i> 刷新所有
                </button>
            </div>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-value" id="total-services">0</div>
                    <div class="summary-label">总服务数</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="running-services">0</div>
                    <div class="summary-label">运行中</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="stopped-services">0</div>
                    <div class="summary-label">已停止</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="warning-services">0</div>
                    <div class="summary-label">警告</div>
                </div>
            </div>
        </div>
        
        <!-- 服务列表 -->
        <div class="section">
            <h2><i class="ri-server-fill"></i> 服务管理</h2>
            <div class="service-grid" id="service-grid">
                <!-- 服务卡片将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 服务操作日志 -->
        <div class="section">
            <h2><i class="ri-history-line"></i> 操作日志</h2>
            <div class="table-container">
                <table id="operation-log">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>服务</th>
                            <th>操作</th>
                            <th>状态</th>
                            <th>详情</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 日志将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="../../js/common.js"></script>
    <script src="../../js/mock-data.js"></script>
    <script>
        // 服务数据
        let services = [];
        
        // 操作日志
        let operationLogs = [];
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            loadServices();
            updateServiceSummary();
        });
        
        // 加载服务数据
        async function loadServices() {
            try {
                // 使用模拟数据服务
                services = MOCK_DATA.getData('services');
                renderServices();
            } catch (error) {
                console.error('加载服务数据错误:', error);
                // 失败时使用默认数据
                services = MOCK_DATA.getData('services');
                renderServices();
            }
        }
        
        // 渲染服务卡片
        function renderServices() {
            const serviceGrid = document.getElementById('service-grid');
            serviceGrid.innerHTML = '';
            
            services.forEach(service => {
                const serviceCard = createServiceCard(service);
                serviceGrid.appendChild(serviceCard);
            });
        }
        
        // 创建服务卡片
        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'service-card';
            
            // 状态类
            let statusClass = 'status-running';
            let statusText = '运行中';
            if (service.status === 'stopped') {
                statusClass = 'status-stopped';
                statusText = '已停止';
            } else if (service.status === 'warning') {
                statusClass = 'status-warning';
                statusText = '警告';
            }
            
            // 计算运行时间
            let uptimeText = '0s';
            if (service.uptime > 0) {
                if (service.uptime < 60) {
                    uptimeText = `${service.uptime}s`;
                } else if (service.uptime < 3600) {
                    uptimeText = `${Math.floor(service.uptime / 60)}m ${service.uptime % 60}s`;
                } else {
                    uptimeText = `${Math.floor(service.uptime / 3600)}h ${Math.floor((service.uptime % 3600) / 60)}m`;
                }
            }
            
            // 最后心跳时间
            let lastHeartbeatText = 'N/A';
            if (service.lastHeartbeat > 0) {
                const diff = Math.floor((Date.now() - service.lastHeartbeat) / 1000);
                if (diff < 60) {
                    lastHeartbeatText = `${diff}s ago`;
                } else if (diff < 3600) {
                    lastHeartbeatText = `${Math.floor(diff / 60)}m ago`;
                } else {
                    lastHeartbeatText = `${Math.floor(diff / 3600)}h ago`;
                }
            }
            
            card.innerHTML = `
                <div class="service-header">
                    <div class="service-title">
                        <i class="ri-${getServiceIcon(service.type)}"></i>
                        ${service.name}
                    </div>
                    <span class="service-status ${statusClass}">${statusText}</span>
                </div>
                
                <div class="service-metrics">
                    <div class="metric-item">
                        <span class="metric-label">版本</span>
                        <span class="metric-value">${service.version}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">运行时间</span>
                        <span class="metric-value">${uptimeText}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">CPU</span>
                        <span class="metric-value">${service.cpu}%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">内存</span>
                        <span class="metric-value">${service.memory}MB</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">网络</span>
                        <span class="metric-value">${formatBytes(service.network.bytesSent)}/s</span>
                    </div>
                </div>
                
                <div class="service-details">
                    <div class="detail-item">
                        <span class="detail-label">最后心跳</span>
                        <span class="detail-value">${lastHeartbeatText}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">服务类型</span>
                        <span class="detail-value">${getServiceTypeText(service.type)}</span>
                    </div>
                </div>
                
                <div class="service-actions">
                    ${service.status !== 'running' ? `<button class="btn btn-primary" onclick="startService('${service.id}')">
                        <i class="ri-play-line"></i> 启动
                    </button>` : ''}
                    ${service.status === 'running' ? `<button class="btn btn-danger" onclick="stopService('${service.id}')">
                        <i class="ri-stop-line"></i> 停止
                    </button>` : ''}
                    <button class="btn btn-secondary" onclick="restartService('${service.id}')">
                        <i class="ri-refresh-line"></i> 重启
                    </button>
                    <button class="btn btn-secondary" onclick="checkService('${service.id}')">
                        <i class="ri-health-line"></i> 检查
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // 获取服务图标
        function getServiceIcon(type) {
            const icons = {
                core: 'server-line',
                service: 'database-line',
                workflow: 'git-branch-line',
                storage: 'folder-line'
            };
            return icons[type] || 'server-line';
        }
        
        // 获取服务类型文本
        function getServiceTypeText(type) {
            const types = {
                core: '核心服务',
                service: '常规服务',
                workflow: '工作流服务',
                storage: '存储服务'
            };
            return types[type] || '未知类型';
        }
        

        
        // 更新服务概览
        function updateServiceSummary() {
            const total = services.length;
            const running = services.filter(s => s.status === 'running').length;
            const stopped = services.filter(s => s.status === 'stopped').length;
            const warning = services.filter(s => s.status === 'warning').length;
            
            document.getElementById('total-services').textContent = total;
            document.getElementById('running-services').textContent = running;
            document.getElementById('stopped-services').textContent = stopped;
            document.getElementById('warning-services').textContent = warning;
        }
        
        // 启动服务
        function startService(serviceId) {
            showLoading();
            
            setTimeout(() => {
                const service = services.find(s => s.id === serviceId);
                if (service) {
                    // 使用模拟数据服务更新状态
                    MOCK_DATA.updateData('services', serviceId, {
                        status: 'running',
                        uptime: 0,
                        lastHeartbeat: Date.now()
                    });
                    
                    // 重新加载数据
                    loadServices();
                    
                    addOperationLog(serviceId, '启动', '成功', '服务已成功启动');
                    updateServiceSummary();
                    showSuccessToast(`服务 ${service.name} 启动成功`);
                }
                hideLoading();
            }, 1000);
        }
        
        // 停止服务
        function stopService(serviceId) {
            showLoading();
            
            setTimeout(() => {
                const service = services.find(s => s.id === serviceId);
                if (service) {
                    // 使用模拟数据服务更新状态
                    MOCK_DATA.updateData('services', serviceId, {
                        status: 'stopped',
                        uptime: 0,
                        cpu: 0,
                        memory: 0
                    });
                    
                    // 重新加载数据
                    loadServices();
                    
                    addOperationLog(serviceId, '停止', '成功', '服务已成功停止');
                    updateServiceSummary();
                    showSuccessToast(`服务 ${service.name} 停止成功`);
                }
                hideLoading();
            }, 1000);
        }
        
        // 重启服务
        function restartService(serviceId) {
            showLoading();
            
            setTimeout(() => {
                const service = services.find(s => s.id === serviceId);
                if (service) {
                    // 使用模拟数据服务更新状态
                    MOCK_DATA.updateData('services', serviceId, {
                        status: 'running',
                        uptime: 0,
                        lastHeartbeat: Date.now()
                    });
                    
                    // 重新加载数据
                    loadServices();
                    
                    addOperationLog(serviceId, '重启', '成功', '服务已成功重启');
                    updateServiceSummary();
                    showSuccessToast(`服务 ${service.name} 重启成功`);
                }
                hideLoading();
            }, 1500);
        }
        
        // 检查服务
        function checkService(serviceId) {
            showLoading();
            
            setTimeout(() => {
                const service = services.find(s => s.id === serviceId);
                if (service) {
                    // 使用模拟数据服务更新状态
                    MOCK_DATA.updateData('services', serviceId, {
                        lastHeartbeat: Date.now()
                    });
                    
                    // 重新加载数据
                    loadServices();
                    
                    addOperationLog(serviceId, '检查', '成功', '服务健康状态正常');
                    showSuccessToast(`服务 ${service.name} 健康检查通过`);
                }
                hideLoading();
            }, 500);
        }
        
        // 刷新所有服务
        function refreshAllServices() {
            showLoading();
            
            setTimeout(() => {
                // 模拟刷新服务状态
                services.forEach(service => {
                    if (service.status === 'running') {
                        MOCK_DATA.updateData('services', service.id, {
                            uptime: service.uptime + 30,
                            lastHeartbeat: Date.now(),
                            cpu: Math.max(5, Math.min(30, service.cpu + (Math.random() - 0.5) * 5)),
                            memory: Math.max(128, Math.min(512, service.memory + (Math.random() - 0.5) * 32))
                        });
                    }
                });
                
                // 重新加载数据
                loadServices();
                
                addOperationLog('all', '刷新', '成功', '所有服务状态已刷新');
                updateServiceSummary();
                showSuccessToast('所有服务状态已刷新');
                hideLoading();
            }, 1000);
        }
        
        // 添加操作日志
        function addOperationLog(serviceId, operation, status, details) {
            const log = {
                time: new Date().toLocaleString('zh-CN'),
                service: serviceId === 'all' ? '全部' : services.find(s => s.id === serviceId)?.name || serviceId,
                operation: operation,
                status: status,
                details: details
            };
            
            operationLogs.unshift(log);
            if (operationLogs.length > 20) {
                operationLogs.pop();
            }
            
            renderOperationLog();
        }
        
        // 渲染操作日志
        function renderOperationLog() {
            const tbody = document.querySelector('#operation-log tbody');
            tbody.innerHTML = '';
            
            operationLogs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.time}</td>
                    <td>${log.service}</td>
                    <td>${log.operation}</td>
                    <td>
                        <span class="status-badge ${log.status === '成功' ? 'status-success' : 'status-error'}">
                            ${log.status}
                        </span>
                    </td>
                    <td>${log.details}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 显示加载
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }
        
        // 隐藏加载
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }
        
        // 显示错误提示
        function showErrorToast(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-toast').classList.add('active');
            setTimeout(hideErrorToast, 3000);
        }
        
        // 隐藏错误提示
        function hideErrorToast() {
            document.getElementById('error-toast').classList.remove('active');
        }
        
        // 显示成功提示
        function showSuccessToast(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-toast').classList.add('active');
            setTimeout(hideSuccessToast, 3000);
        }
        
        // 隐藏成功提示
        function hideSuccessToast() {
            document.getElementById('success-toast').classList.remove('active');
        }
        
        // 初始添加一些日志
        addOperationLog('mcp', '启动', '成功', 'MCP Agent 服务启动成功');
        addOperationLog('skillcenter', '启动', '成功', 'Skill Center 服务启动成功');
        addOperationLog('skillflow', '启动', '成功', 'Skill Flow 服务启动成功');
        addOperationLog('vfs', '停止', '成功', 'VFS 服务已停止');
    </script>
</body>
</html>

