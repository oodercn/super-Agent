# Nexus 工程重构计划 - 基于用户故事功能和 0.8.0 协议

## 1. 重构背景

### 1.1 协议升级
- **当前版本**: 基于 v0.7.3 协议
- **目标版本**: 升级到 v0.8.0 协议
- **核心变更**: CAP 驱动架构、Scene=Agent、能力驱动发现、离线优先设计

### 1.2 现有架构分析
- **当前结构**: 传统的技能管理和场景配置
- **存在问题**: 
  - 技能膨胀，重复开发
  - 版本兼容性管理复杂
  - 能力复用机制不完善
  - 离线支持不够充分
  - 场景管理缺乏智能体化设计
  - 能力发现机制单一
  - 网络拓扑管理薄弱

## 2. 重构目标

### 2.1 核心目标
- **防止技能膨胀**: 通过 CAP 标准化，避免重复开发
- **向后兼容**: CAP 版本化管理，保证驱动接口稳定
- **能力复用**: 同一 CAP 可被多个 Skill 实现，按需选择
- **AI 友好**: scene.md 和 cap.md 提供详细约束，AI 可理解扩展
- **离线优先**: 所有 CAP 必须支持离线降级实现
- **网络智能**: 多种发现方式，自适应网络拓扑
- **安全可靠**: 完善的安全认证和权限控制
- **高可用**: 场景和能力的故障转移机制

### 2.2 架构目标
- **Scene = Agent**: 场景作为特殊的智能体，具备自动启动和高可用能力
- **CAP Registry**: 标准化的能力注册表，按地址空间分类管理
- **技能层**: CAP 的具体实现，支持多种调用类型
- **基础设施层**: 统一的服务和组件，包括 SceneEngine、SkillCenter、AgentSDK 等
- **网络层**: 多种发现方式和网络拓扑管理
- **安全层**: 完善的安全认证和权限控制系统

## 3. 用户故事功能驱动的重构计划

### 3.1 个人网络场景

#### 故事 1: 早晨启动 - 智能设备发现
**用户故事**: 当我早晨来到办公室，打开电脑时，希望系统能自动启动能力雷达，发现并同步我所有设备的能力和配置，让我快速进入工作状态。

**重构任务**:
1. **实现能力雷达扫描**: 启动时自动同步 Scene 索引、CAP 注册表、Skill 索引到本地缓存
2. **个人设备网络**: 基于 UDP + mDNS + Local FS 的推荐发现组合
3. **自动配置同步**: 设备间配置自动同步机制，支持差异化配置
4. **设备状态监控**: 实时显示设备在线状态和能力可用性

#### 故事 2: 离开办公室 - 无缝能力转移
**用户故事**: 当我离开办公室时，希望系统能智能检测我的离开，自动将电脑上的工作状态和能力转移到我的手机，确保工作不中断。

**重构任务**:
1. **能力转移机制**: 检测空闲后自动广播 CAP_HANDOVER 请求
2. **状态同步**: 工作状态和上下文的无缝切换，支持断点续传
3. **智能切换策略**: 基于用户行为和设备状态的自动切换算法
4. **离线支持**: 确保转移后的能力在离线状态下仍可使用

#### 故事 3: 回家后 - 跨网络状态恢复
**用户故事**: 当我回到家，打开家用电脑时，希望能从手机自动同步并恢复之前在办公室的工作状态，继续未完成的任务。

**重构任务**:
1. **跨网络同步**: 不同网络环境下的安全能力同步
2. **状态恢复**: 工作状态的持久化和智能恢复机制
3. **设备识别**: 自动识别用户设备并建立安全信任关系
4. **网络自适应**: 根据网络环境自动选择最优发现方式

### 3.2 部门分享场景

#### 故事 4: 分享能力 - 团队协作
**用户故事**: 作为团队负责人，我希望能将团队开发的能力通过简单的操作分享给部门内的其他成员使用，并能设置精细的访问权限。

**重构任务**:
1. **能力分享机制**: 实现 CAP_SHARE 消息协议，支持按组分享能力
2. **权限控制**: 细粒度的能力访问权限管理，支持 read、execute 等不同权限
3. **分享范围**: 支持部门、项目组等不同范围的分享，可设置过期时间
4. **分享管理**: 提供分享能力的创建、查看、取消等完整生命周期管理

#### 故事 5: 创建协作场景 - 项目协同
**用户故事**: 作为项目负责人，我希望能创建一个协作场景，基于场景的能力需求自动邀请具备相应能力的团队成员加入，共同完成项目任务。

**重构任务**:
1. **场景创建**: 支持用户自定义协作场景，生成唯一的 scene-{sceneName}-{uuid} 标识
2. **成员邀请**: 基于 SCENE_CREATE 消息协议，实现基于能力需求的成员邀请机制
3. **能力汇聚**: 自动汇聚成员贡献的能力，形成场景能力池
4. **场景管理**: 支持场景的激活、停用、配置更新等完整生命周期管理

#### 故事 6: 组能力池 - 资源共享
**用户故事**: 作为团队成员，我希望能查看和使用团队共享的能力池，了解每个能力的详细信息和使用情况，避免重复开发。

**重构任务**:
1. **能力池管理**: 自动汇聚和管理组内共享能力，提供统一的访问入口
2. **权限控制**: 基于角色的能力访问控制，确保只有授权成员可以使用
3. **使用审计**: 能力使用情况的跟踪和审计，生成详细的使用报告
4. **能力对比**: 提供同一能力不同 Skill 实现的对比功能，帮助选择最优实现

### 3.3 公司管理场景

#### 故事 7: 发布官方能力 - 企业级部署
**用户故事**: 作为 IT 管理员，我希望能通过标准化的流程开发、审批和发布官方能力，确保这些能力能安全地推送给全公司员工使用。

**重构任务**:
1. **官方能力发布**: 实现基于 SkillCenter API 的官方能力发布流程
2. **审批流程**: 建立能力发布的多级审批和管理流程，确保安全性
3. **全局广播**: 通过 DHT 网络实现官方能力的自动发现和推送
4. **版本控制**: 实现官方能力的版本管理和更新机制

#### 故事 8: 部门能力授权 - 精细化管理
**用户故事**: 作为部门主管，我希望能为特定部门开发和授权专用能力，确保这些能力仅限授权部门成员使用，并能跟踪其使用情况。

**重构任务**:
1. **部门能力管理**: 实现部门级能力的开发、注册和管理
2. **权限隔离**: 基于 CAP 权限模型，确保能力仅限授权部门使用
3. **使用统计**: 实现部门能力使用情况的详细统计和分析
4. **安全审计**: 对部门能力的创建、修改、使用进行全程审计

#### 故事 9: 能力使用审计 - 合规保障
**用户故事**: 作为合规官，我希望能全面审计公司内所有能力的使用情况，包括谁在使用、何时使用、如何使用，确保所有使用行为都符合公司政策和法规要求。

**重构任务**:
1. **使用记录**: 实现详细的能力使用记录，包括调用方、时间、参数、结果等
2. **审计系统**: 建立能力使用的审计和分析系统，支持多维度查询和报告
3. **异常检测**: 实现基于规则和机器学习的异常能力使用检测和告警
4. **合规报告**: 自动生成符合法规要求的能力使用合规报告

## 4. 功能重构计划

### 4.1 核心架构重构

#### 4.1.1 Scene = Agent 实现
- **场景智能体化**: 将场景转换为特殊的智能体，生成唯一的 scene-{sceneName}-{uuid} 标识
- **场景类型**: 实现 PRIMARY / BACKUP / COLLABORATIVE 三种场景类型
- **高可用支持**: 实现场景的 HA 模式，支持主备切换和故障转移
- **离线支持**: 场景的离线运行能力，确保在网络中断时仍能正常工作
- **自动启动**: 支持场景的自动启动和自恢复能力

#### 4.1.2 CAP 注册表实现
- **地址空间划分**: 严格按照系统区 (00-3F)、通用区 (40-9F)、扩展区 (A0-FF) 划分
- **CAP 定义**: 实现标准化的能力接口定义，包括请求/响应格式
- **版本管理**: 实现 CAP 的语义化版本管理，确保向后兼容性
- **离线支持**: 所有 CAP 必须支持降级实现，确保离线可用
- **CAP 契约**: 实现 CAP 接口契约的验证机制，确保 Skill 实现的合规性

#### 4.1.3 能力发现机制
- **雷达扫描**: 启动时自动同步 Scene 索引、CAP 注册表、Skill 索引到本地缓存
- **多维度发现**: 实现按场景、按能力分类的多维度浏览
- **搜索功能**: 实现基于关键词的能力和场景搜索
- **推荐系统**: 实现基于用户行为和网络拓扑的能力推荐
- **多发现方式**: 集成 UDP、mDNS、DHT、SkillCenter API 等多种发现方式
- **网络自适应**: 根据网络环境自动选择最优的发现组合

### 4.2 前端重构

#### 4.2.1 发现界面
- **雷达扫描界面**: 可视化的能力发现过程，实时显示扫描进度和发现结果
- **场景浏览**: 按场景分类的能力浏览，支持场景详情查看
- **能力对比**: 不同 Skill 实现的详细对比，包括性能、离线支持、评分等
- **安装流程**: 一键式的场景安装和配置，支持依赖自动安装
- **搜索功能**: 强大的搜索功能，支持按关键词、能力类型、场景类型搜索

#### 4.2.2 个人网络界面
- **设备管理**: 个人设备的管理和状态监控，显示设备在线状态和能力可用性
- **能力转移**: 设备间能力的手动和自动转移，支持一键切换
- **状态同步**: 设备间状态的同步管理，支持差异化配置
- **网络拓扑**: 可视化的个人网络拓扑图，显示设备间的连接关系

#### 4.2.3 分享管理界面
- **能力分享**: 能力的分享和权限设置，支持设置分享范围和过期时间
- **共享池**: 查看和使用共享能力，支持按能力类型、分享者等筛选
- **使用统计**: 能力使用情况的详细统计和分析，支持导出报告
- **审计日志**: 查看能力分享和使用的审计日志，确保合规性

### 4.3 后端重构

#### 4.3.1 能力管理服务
- **CAP 注册表**: 实现和维护标准化的能力注册表，支持 CAP 的注册、查询、更新
- **Skill 管理**: 实现技能的注册、发现、管理和版本控制
- **版本控制**: 实现能力和技能的语义化版本管理，确保向后兼容性
- **离线支持**: 实现能力的离线降级机制，确保在网络中断时仍能正常工作
- **CAP 契约验证**: 实现 CAP 接口契约的验证机制，确保 Skill 实现的合规性

#### 4.3.2 场景管理服务
- **场景生命周期**: 实现场景的创建、激活、停用、删除等完整生命周期管理
- **场景配置**: 实现场景的参数和配置管理，支持动态配置更新
- **场景同步**: 实现场景状态的同步和一致性保证，支持多设备协同
- **场景高可用**: 实现场景的备份、故障转移和自恢复能力
- **Scene = Agent**: 实现场景作为特殊智能体的核心功能

#### 4.3.3 网络服务
- **发现机制**: 实现 UDP、mDNS、DHT、SkillCenter API 等多种发现方式
- **网络拓扑**: 实现网络拓扑的构建、维护和可视化
- **心跳管理**: 实现设备心跳和状态管理，支持不同设备类型的心跳周期
- **离线检测**: 实现设备离线的智能检测和处理，支持设备状态恢复
- **消息协议**: 实现 AGENT_ANNOUNCE、CAP_SHARE、SCENE_CREATE 等消息协议

## 5. 技术实现计划

### 5.1 代码结构重构

#### 5.1.1 单仓库设计
- **Monorepo 结构**: 采用单仓库设计，统一管理 CAP 注册表、场景模板和 Skills 实现
- **目录结构**:
  ```
  ooder-Nexus/
  ├── registry/          # CAP 注册表
  │   ├── cap-index.yaml # CAP 总索引
  │   ├── system/        # 系统区 (00-3F)
  │   ├── common/        # 通用区 (40-9F)
  │   └── extension/     # 扩展区 (A0-FF)
  ├── scenes/            # 场景模板
  │   ├── scene-index.yaml # 场景总索引
  │   ├── messaging/     # 消息场景
  │   ├── auth/          # 认证场景
  │   └── storage/       # 存储场景
  ├── skills/            # Skills 实现
  │   ├── skill-index.yaml # Skill 总索引
  │   ├── skill-msg/     # 消息技能
  │   ├── skill-auth/    # 认证技能
  │   └── skill-vfs/     # 存储技能
  ├── skill-common/      # 公共组件
  ├── tools/             # 工具
  │   ├── skill-generator/ # Skill 生成器
  │   ├── cap-validator/ # CAP 验证器
  │   └── index-builder/ # 索引构建器
  └── docs/              # 文档
  ```

#### 5.1.2 核心模块
- **cap-registry**: 实现 CAP 注册表的管理和维护
- **scene-engine**: 实现场景引擎的核心功能，支持 Scene = Agent
- **skill-manager**: 实现技能的管理、发现和版本控制
- **network-service**: 实现网络服务和多种发现方式
- **security-service**: 实现安全服务和权限控制
- **radar-service**: 实现能力雷达扫描和发现功能
- **sync-service**: 实现设备间和场景间的同步功能

### 5.2 接口设计

#### 5.2.1 SceneDiscoveryService
- **syncAllIndexes()**: 同步 Scene 索引、CAP 注册表、Skill 索引到本地缓存
- **listScenes(String category)**: 按分类获取场景列表
- **searchScenes(String query)**: 基于关键词搜索场景
- **getSceneDetail(String sceneId)**: 获取场景详细信息
- **getAvailableSkills(String sceneId)**: 获取场景可用的 Skill 列表

#### 5.2.2 CapDiscoveryService
- **listCaps(String category)**: 按分类获取 CAP 列表
- **searchCaps(String query)**: 基于关键词搜索 CAP
- **getCapDetail(String capId)**: 获取 CAP 详细信息
- **getAvailableSkills(String capId)**: 获取 CAP 可用的 Skill 列表

#### 5.2.3 SkillPackageManager
- **installScene(String sceneId, SkillSelection selection)**: 安装场景及其依赖
- **replaceSkill(String sceneId, String capId, String newSkillId)**: 更换场景中的 Skill 实现
- **searchSkills(String query)**: 搜索 Skill
- **searchSkillsByCap(String capId)**: 按 CAP 搜索 Skill

#### 5.2.4 PersonalNetworkService
- **getMyDevices()**: 获取我的设备列表
- **broadcastCapabilityUpdate(String capId, CapabilityStatus status)**: 广播能力更新
- **requestCapabilityTransfer(String capId, String toDeviceId)**: 请求能力转移
- **syncConfigToDevices(List<String> deviceIds)**: 同步配置到指定设备

#### 5.2.5 CapabilityShareService
- **shareCapability(String capId, ShareScope scope, SharePermission permission)**: 分享能力
- **unshareCapability(String shareId)**: 取消分享
- **getSharedCapabilityPool(String scope)**: 获取共享能力池
- **useSharedCapability(String shareId, UseRequest request)**: 使用共享能力

#### 5.2.6 CapabilityRadarService
- **startRadarScan(RadarConfig config)**: 启动能力雷达扫描
- **stopRadarScan()**: 停止雷达扫描
- **getDiscoveredCapabilities()**: 获取发现的能力列表
- **subscribeCapabilityDiscovery(Consumer<CapabilityDiscoveryEvent> listener)**: 订阅能力发现事件

### 5.3 数据结构设计

#### 5.3.1 CAP 定义
```yaml
cap:
  id: "40"
  name: "MSG_SEND"
  spec:
    version: "1.0"
    description: "消息发送能力"
    request:
      type: "object"
      properties:
        to: { type: "string" }
        content: { type: "string" }
        priority: { type: "integer", default: 0 }
    response:
      type: "object"
      properties:
        success: { type: "boolean" }
        messageId: { type: "string" }
        timestamp: { type: "integer" }
    offline: true
    fallback: "本地消息队列"
```

#### 5.3.2 场景定义
```yaml
scene:
  id: "messaging"
  name: "消息场景"
  type: "COLLABORATIVE"
  agentId: "scene-messaging-{uuid}"
  requiredCaps:
    - "40"
    - "41"
  defaultSkills:
    "40": "skill-msg-wechat"
    "41": "skill-msg-wechat"
  config:
    autoStart: true
    haMode: true
    heartbeatInterval: 30
    maxRetries: 3
  metadata:
    author: "ooder"
    version: "1.0"
    tags: ["messaging", "communication"]
```

#### 5.3.3 Skill 定义
```yaml
skill:
  id: "skill-msg-wechat"
  name: "微信消息技能"
  version: "1.0"
  description: "通过微信发送消息"
  author: "ooder"
  implements:
    - capId: "40"
      version: "1.0"
    - capId: "41"
      version: "1.0"
  offline: false
  dependencies:
    - id: "skill-auth-wechat"
      version: "^1.0"
  config:
    timeout: 30000
    retryCount: 3
  endpoints:
    - type: "http"
      url: "http://localhost:8080/skill-msg-wechat"
    - type: "local-jar"
      path: "./skills/skill-msg-wechat.jar"
```

#### 5.3.4 设备状态定义
```yaml
device:
  id: "device-001"
  name: "工作电脑-A"
  type: "fixed"
  status: "online"
  capabilities:
    - capId: "40"
      status: "active"
    - capId: "41"
      status: "active"
  heartbeat:
    interval: 30
    lastReceived: 1700000000000
  network:
    ip: "192.168.1.100"
    mac: "AA:BB:CC:DD:EE:FF"
```

## 6. 实施计划

### 6.1 阶段划分

#### 阶段 1: 基础设施 (2 周)
- **CAP 注册表**: 实现能力注册表和管理服务，完成地址空间划分
- **发现机制**: 实现 UDP、mDNS、Local FS 等基础发现方式
- **网络服务**: 实现网络拓扑构建和心跳管理
- **核心工具**: 开发 Skill 生成器、CAP 验证器等工具

#### 阶段 2: 核心功能 (3 周)
- **Scene = Agent**: 实现场景作为智能体的核心功能，包括自动启动和高可用
- **能力管理**: 实现能力的注册、发现、管理和版本控制
- **技能管理**: 实现技能的注册、发现、管理和依赖解析
- **离线支持**: 实现所有 CAP 的离线降级机制

#### 阶段 3: 用户场景 (3 周)
- **个人网络**: 实现个人设备网络、能力转移和状态同步
- **部门分享**: 实现能力分享、协作场景和组能力池
- **公司管理**: 实现官方能力发布、部门能力授权和审计
- **消息协议**: 实现 AGENT_ANNOUNCE、CAP_SHARE、SCENE_CREATE 等消息协议

#### 阶段 4: 前端界面 (2 周)
- **发现界面**: 实现能力发现、场景浏览和安装界面
- **个人网络界面**: 实现个人设备管理和能力转移界面
- **分享管理界面**: 实现能力分享和共享池管理界面
- **管理控制台**: 实现管理员操作和审计界面

#### 阶段 5: 测试和优化 (2 周)
- **功能测试**: 测试所有功能的正确性和完整性
- **性能测试**: 测试系统的性能、稳定性和响应时间
- **兼容性测试**: 测试与旧版本的兼容性和迁移方案
- **安全测试**: 测试系统的安全性和权限控制
- **优化**: 根据测试结果进行性能和功能优化

### 6.2 优先级

1. **高优先级**:
   - CAP 注册表实现和管理
   - 场景管理服务和 Scene = Agent 功能
   - 能力发现机制和多发现方式集成
   - 个人网络功能和设备管理
   - 离线支持和降级机制

2. **中优先级**:
   - 部门分享功能和协作场景
   - 公司管理功能和官方能力发布
   - 前端界面开发和用户体验优化
   - 性能优化和系统稳定性
   - 安全认证和权限控制

3. **低优先级**:
   - 高级推荐系统和智能匹配
   - 高级分析功能和报表
   - 第三方集成和扩展
   - 高级安全功能和加密
   - 网络拓扑可视化和高级管理

## 7. 预期成果

### 7.1 功能成果
- **CAP 驱动架构**: 实现标准化的能力定义、管理和发现
- **Scene = Agent**: 场景作为特殊的智能体，具备自动启动和高可用能力
- **多维度发现**: 支持按场景、按能力分类浏览，集成多种发现方式
- **个人网络**: 个人设备的自动发现、能力转移和状态同步
- **部门分享**: 能力的安全分享、协作场景和组能力池
- **公司管理**: 官方能力发布、部门能力授权和全面审计
- **离线优先**: 所有功能在网络中断时仍能正常工作

### 7.2 技术成果
- **单仓库结构**: 采用 Monorepo 结构，统一管理 CAP 注册表、场景模板和 Skills 实现
- **多种发现方式**: 集成 UDP、mDNS、DHT、SkillCenter API 等多种发现方式
- **离线支持**: 所有 CAP 支持离线降级实现，确保系统可靠性
- **版本管理**: CAP 和 Skill 的语义化版本管理，确保向后兼容性
- **安全机制**: 完善的安全认证、权限控制和审计系统
- **网络智能**: 自适应网络拓扑，智能选择最优发现方式

### 7.3 业务成果
- **防止技能膨胀**: 通过 CAP 标准化，避免重复开发，提高代码复用率
- **提高开发效率**: 能力复用机制，减少开发工作量，加速新功能上线
- **改善用户体验**: 自动化的能力发现和场景管理，简化用户操作
- **增强系统稳定性**: 离线支持和故障转移机制，提高系统可靠性
- **降低维护成本**: 标准化的接口和版本管理，简化系统维护
- **提升安全性**: 完善的安全机制，保护企业数据和系统安全
- **促进协作**: 能力分享和协作场景，加强团队协作效率

## 8. 风险评估

### 8.1 技术风险
- **兼容性问题**: 与旧版本的兼容性和迁移复杂度
- **性能问题**: 多种发现方式的性能开销和资源消耗
- **安全问题**: 能力分享和网络发现的安全风险
- **复杂度问题**: 系统复杂度增加，维护难度提高
- **网络问题**: 不同网络环境下的发现可靠性

### 8.2 管理风险
- **进度风险**: 重构工作量可能超出预期，影响项目时间线
- **质量风险**: 重构过程中可能引入新的 bug 和问题
- **团队风险**: 团队对新架构和协议的适应需要时间
- **依赖风险**: 外部依赖的变更和兼容性问题
- **知识风险**: 核心技术知识的传递和保留

### 8.3 缓解策略
- **渐进式升级**: 分阶段实施，确保每个阶段都可独立运行和验证
- **充分测试**: 每个阶段都进行充分的功能、性能、安全测试
- **文档完善**: 完善的架构文档、开发指南和API文档
- **培训计划**: 为团队提供充分的培训和知识分享
- **回滚机制**: 建立完善的回滚机制，确保在出现问题时能够快速回滚
- **监控系统**: 建立全面的监控系统，及时发现和解决问题
- **技术债务管理**: 定期评估和管理技术债务，避免积累

## 9. 结论

Nexus 工程的重构是一个基于用户故事功能和 0.8.0 协议的系统性工程，旨在实现 CAP 驱动架构、Scene=Agent 和能力驱动发现等核心概念。通过这次重构，我们将打造一个更加灵活、高效、安全的智能体平台，为用户提供更好的体验。

重构计划从用户故事出发，涵盖了个人网络、部门分享和公司管理等不同场景，通过分阶段的实施计划，确保重构工作的顺利进行。同时，我们也充分考虑了可能的风险，并制定了相应的缓解策略。

相信通过这次重构，Nexus 工程将迎来一个新的发展阶段，为 SuperAgent 生态系统的繁荣做出更大的贡献。
