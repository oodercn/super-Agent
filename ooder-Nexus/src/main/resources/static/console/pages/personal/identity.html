<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Nexus Identity Management - 身份管理">
    <meta name="theme-color" content="#000000">
    <title>身份管理 - Nexus Console</title>
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="../../css/remixicon/remixicon.css">
    <link rel="stylesheet" href="../../css/main.css">
    <script src="../../js/theme-manager.js?v=2"></script>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="page-header">
                <h1><i class="ri-shield-user-line"></i> 身份管理</h1>
            </div>
            
            <div class="identity-grid">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="ri-user-line"></i> 基本信息</h3>
                    </div>
                    <div class="card-body">
                        <div class="profile-section">
                            <div class="avatar-section">
                                <div class="avatar" id="userAvatar">
                                    <i class="ri-user-line"></i>
                                </div>
                                <button class="btn btn-sm btn-secondary" onclick="changeAvatar()">更换头像</button>
                            </div>
                            <div class="info-form">
                                <div class="form-group">
                                    <label class="form-label">用户名</label>
                                    <input type="text" class="form-control" id="username" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">昵称</label>
                                    <input type="text" class="form-control" id="nickname" placeholder="设置昵称">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">邮箱</label>
                                    <input type="email" class="form-control" id="email" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">手机号</label>
                                    <input type="tel" class="form-control" id="phone" placeholder="绑定手机号">
                                </div>
                                <button class="btn btn-primary" onclick="saveBasicInfo()">保存修改</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3><i class="ri-key-2-line"></i> 安全设置</h3>
                    </div>
                    <div class="card-body">
                        <div class="security-item">
                            <div class="security-info">
                                <div class="security-title">登录密码</div>
                                <div class="security-desc">定期更换密码可以提高账号安全性</div>
                            </div>
                            <button class="btn btn-secondary" onclick="showChangePasswordModal()">修改密码</button>
                        </div>
                        <div class="security-item">
                            <div class="security-info">
                                <div class="security-title">两步验证</div>
                                <div class="security-desc" id="twoFactorStatus">未启用</div>
                            </div>
                            <button class="btn btn-secondary" id="twoFactorBtn" onclick="toggleTwoFactor()">启用</button>
                        </div>
                        <div class="security-item">
                            <div class="security-info">
                                <div class="security-title">登录设备</div>
                                <div class="security-desc">管理已登录的设备</div>
                            </div>
                            <button class="btn btn-secondary" onclick="showDevicesModal()">查看设备</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3><i class="ri-links-line"></i> 关联账号</h3>
                    </div>
                    <div class="card-body">
                        <div class="linked-accounts" id="linkedAccounts">
                            <div class="loading">加载中...</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3><i class="ri-history-line"></i> 登录历史</h3>
                    </div>
                    <div class="card-body">
                        <div class="login-history" id="loginHistory">
                            <div class="loading">加载中...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="ri-key-2-line"></i> 修改密码</h3>
                <button class="modal-close" onclick="hideChangePasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label class="form-label">当前密码</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">新密码</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">确认新密码</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideChangePasswordModal()">取消</button>
                <button class="btn btn-primary" onclick="changePassword()">确认修改</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="devicesModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3><i class="ri-device-line"></i> 登录设备</h3>
                <button class="modal-close" onclick="hideDevicesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="devices-list" id="devicesList">
                    <div class="loading">加载中...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="logoutAllDevices()">退出所有设备</button>
                <button class="btn btn-secondary" onclick="hideDevicesModal()">关闭</button>
            </div>
        </div>
    </div>
    
    <script src="../../js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadLinkedAccounts();
            loadLoginHistory();
        });
        
        function loadUserInfo() {
            fetch('/api/personal/identity')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const user = data.data;
                        document.getElementById('username').value = user.username || '';
                        document.getElementById('nickname').value = user.nickname || '';
                        document.getElementById('email').value = user.email || '';
                        document.getElementById('phone').value = user.phone || '';
                        
                        if (user.twoFactorEnabled) {
                            document.getElementById('twoFactorStatus').textContent = '已启用';
                            document.getElementById('twoFactorBtn').textContent = '禁用';
                        }
                    }
                })
                .catch(error => {
                    console.error('Failed to load user info:', error);
                });
        }
        
        function loadLinkedAccounts() {
            fetch('/api/personal/identity/linked-accounts')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('linkedAccounts');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(account => `
                            <div class="linked-account-item">
                                <div class="account-icon">
                                    <i class="${getAccountIcon(account.type)}"></i>
                                </div>
                                <div class="account-info">
                                    <div class="account-name">${account.name}</div>
                                    <div class="account-meta">${account.username || '未绑定'}</div>
                                </div>
                                <button class="btn btn-sm ${account.linked ? 'btn-danger' : 'btn-primary'}" 
                                        onclick="${account.linked ? `unlinkAccount('${account.type}')` : `linkAccount('${account.type}')`}">
                                    ${account.linked ? '解绑' : '绑定'}
                                </button>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state">暂无关联账号</div>';
                    }
                })
                .catch(error => {
                    console.error('Failed to load linked accounts:', error);
                    container.innerHTML = '<div class="empty-state">加载失败</div>';
                });
        }
        
        function loadLoginHistory() {
            fetch('/api/personal/identity/login-history')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('loginHistory');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.slice(0, 5).map(record => `
                            <div class="history-item">
                                <div class="history-icon">
                                    <i class="ri-login-circle-line"></i>
                                </div>
                                <div class="history-info">
                                    <div class="history-title">${record.device || '未知设备'}</div>
                                    <div class="history-meta">${record.ip || '-'} · ${record.location || '-'}</div>
                                </div>
                                <div class="history-time">${formatDate(record.time)}</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state">暂无登录记录</div>';
                    }
                })
                .catch(error => {
                    console.error('Failed to load login history:', error);
                    container.innerHTML = '<div class="empty-state">加载失败</div>';
                });
        }
        
        function saveBasicInfo() {
            const data = {
                nickname: document.getElementById('nickname').value,
                phone: document.getElementById('phone').value
            };
            
            fetch('/api/personal/identity', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('保存成功');
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Failed to save:', error);
                alert('保存失败');
            });
        }
        
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show');
        }
        
        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show');
            document.getElementById('changePasswordForm').reset();
        }
        
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('两次输入的密码不一致');
                return;
            }
            
            fetch('/api/personal/identity/password', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideChangePasswordModal();
                    alert('密码修改成功');
                } else {
                    alert('修改失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Failed to change password:', error);
                alert('修改失败');
            });
        }
        
        function toggleTwoFactor() {
            fetch('/api/personal/identity/two-factor', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUserInfo();
                    alert(data.message);
                } else {
                    alert('操作失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Failed to toggle two factor:', error);
                alert('操作失败');
            });
        }
        
        function showDevicesModal() {
            loadDevices();
            document.getElementById('devicesModal').classList.add('show');
        }
        
        function hideDevicesModal() {
            document.getElementById('devicesModal').classList.remove('show');
        }
        
        function loadDevices() {
            fetch('/api/personal/identity/devices')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('devicesList');
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(device => `
                            <div class="device-item">
                                <div class="device-icon">
                                    <i class="${getDeviceIcon(device.type)}"></i>
                                </div>
                                <div class="device-info">
                                    <div class="device-name">${device.name}</div>
                                    <div class="device-meta">${device.os || ''} · ${device.browser || ''}</div>
                                    <div class="device-time">最后活动: ${formatDate(device.lastActive)}</div>
                                </div>
                                ${device.current ? '<span class="badge badge-success">当前设备</span>' : 
                                    '<button class="btn btn-sm btn-danger" onclick="logoutDevice(\'' + device.id + '\')">退出</button>'}
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state">暂无设备记录</div>';
                    }
                })
                .catch(error => {
                    console.error('Failed to load devices:', error);
                    container.innerHTML = '<div class="empty-state">加载失败</div>';
                });
        }
        
        function logoutDevice(deviceId) {
            fetch(`/api/personal/identity/devices/${deviceId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadDevices();
                        alert('设备已退出');
                    } else {
                        alert('操作失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Failed to logout device:', error);
                    alert('操作失败');
                });
        }
        
        function logoutAllDevices() {
            if (confirm('确定要退出所有其他设备吗？')) {
                fetch('/api/personal/identity/devices/all', { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadDevices();
                            alert('已退出所有其他设备');
                        } else {
                            alert('操作失败: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Failed to logout all devices:', error);
                        alert('操作失败');
                    });
            }
        }
        
        function linkAccount(type) {
            window.location.href = `/api/personal/identity/link/${type}`;
        }
        
        function unlinkAccount(type) {
            if (confirm('确定要解绑此账号吗？')) {
                fetch(`/api/personal/identity/unlink/${type}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadLinkedAccounts();
                            alert('已解绑');
                        } else {
                            alert('解绑失败: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Failed to unlink:', error);
                        alert('解绑失败');
                    });
            }
        }
        
        function changeAvatar() {
            alert('头像上传功能开发中');
        }
        
        function getAccountIcon(type) {
            const icons = {
                'wechat': 'ri-wechat-fill',
                'github': 'ri-github-fill',
                'google': 'ri-google-fill',
                'dingtalk': 'ri-dingding-fill'
            };
            return icons[type] || 'ri-link';
        }
        
        function getDeviceIcon(type) {
            const icons = {
                'desktop': 'ri-computer-line',
                'mobile': 'ri-smartphone-line',
                'tablet': 'ri-tablet-line'
            };
            return icons[type] || 'ri-device-line';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN');
        }
    </script>
    
    <style>
        .identity-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }
        
        @media (max-width: 1200px) {
            .identity-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .profile-section {
            display: flex;
            gap: 24px;
        }
        
        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--ns-bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--ns-secondary);
        }
        
        .info-form {
            flex: 1;
        }
        
        .security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--ns-border);
        }
        
        .security-item:last-child {
            border-bottom: none;
        }
        
        .security-title {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .security-desc {
            font-size: 13px;
            color: var(--ns-secondary);
        }
        
        .linked-account-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--ns-border);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .account-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--ns-bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .account-info {
            flex: 1;
        }
        
        .account-name {
            font-weight: 500;
        }
        
        .account-meta {
            font-size: 13px;
            color: var(--ns-secondary);
        }
        
        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--ns-border);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--ns-bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-info {
            flex: 1;
        }
        
        .history-title {
            font-weight: 500;
        }
        
        .history-meta {
            font-size: 13px;
            color: var(--ns-secondary);
        }
        
        .history-time {
            font-size: 13px;
            color: var(--ns-secondary);
        }
        
        .device-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--ns-border);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .device-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--ns-bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .device-info {
            flex: 1;
        }
        
        .device-name {
            font-weight: 500;
        }
        
        .device-meta, .device-time {
            font-size: 13px;
            color: var(--ns-secondary);
        }
        
        .modal-lg {
            max-width: 600px;
        }
    </style>
</body>
</html>
