<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>场景组管理 - Nexus</title>
    
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/nexus.css">
    <style>
        .group-container { display: flex; gap: 20px; }
        .group-sidebar { width: 280px; flex-shrink: 0; }
        .group-main { flex: 1; }
        
        .group-list { background: var(--ns-card-bg); border: 1px solid var(--ns-border); border-radius: 8px; }
        .group-list-header { padding: 16px; border-bottom: 1px solid var(--ns-border); }
        .group-list-header h3 { font-size: 14px; font-weight: 600; color: var(--ns-dark); }
        .group-item { padding: 12px 16px; border-bottom: 1px solid var(--ns-border); cursor: pointer; transition: background 0.2s; }
        .group-item:hover { background: var(--ns-bg-hover); }
        .group-item:last-child { border-bottom: none; }
        .group-item.active { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--nx-primary); }
        .group-item-name { font-size: 14px; font-weight: 500; color: var(--ns-dark); margin-bottom: 4px; }
        .group-item-meta { font-size: 12px; color: var(--ns-secondary); }
        
        .group-detail { background: var(--ns-card-bg); border: 1px solid var(--ns-border); border-radius: 8px; }
        .group-detail-header { padding: 20px; border-bottom: 1px solid var(--ns-border); }
        .group-detail-title { font-size: 18px; font-weight: 600; color: var(--ns-dark); margin-bottom: 8px; }
        .group-detail-desc { font-size: 13px; color: var(--ns-secondary); line-height: 1.5; }
        .group-detail-body { padding: 20px; }
        
        .scene-timeline { position: relative; padding-left: 24px; }
        .scene-timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--ns-border); }
        .scene-timeline-item { position: relative; padding-bottom: 20px; }
        .scene-timeline-item:last-child { padding-bottom: 0; }
        .scene-timeline-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: var(--nx-primary); border: 2px solid var(--ns-card-bg); }
        .scene-timeline-dot.required { background: #ef4444; }
        .scene-timeline-dot.optional { background: var(--ns-secondary); }
        
        .scene-node { background: var(--ns-bg-hover); border-radius: 8px; padding: 16px; }
        .scene-node-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .scene-node-name { font-size: 14px; font-weight: 500; color: var(--ns-dark); }
        .scene-node-id { font-size: 12px; color: var(--ns-secondary); font-family: monospace; }
        .scene-node-desc { font-size: 13px; color: var(--ns-secondary); margin-bottom: 8px; }
        .scene-node-meta { display: flex; gap: 16px; font-size: 12px; color: var(--ns-secondary); }
        
        .dependency-section { margin-top: 24px; }
        .dependency-title { font-size: 14px; font-weight: 600; color: var(--ns-dark); margin-bottom: 12px; }
        .dependency-graph { background: var(--ns-bg-hover); border-radius: 8px; padding: 16px; }
        .dep-flow { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
        .dep-node { background: var(--ns-card-bg); border: 1px solid var(--ns-border); border-radius: 6px; padding: 8px 12px; font-size: 13px; color: var(--ns-dark); }
        .dep-arrow { color: var(--ns-secondary); font-size: 16px; }
        
        .config-section { margin-top: 24px; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .config-item { background: var(--ns-bg-hover); border-radius: 6px; padding: 12px; }
        .config-label { font-size: 12px; color: var(--ns-secondary); margin-bottom: 4px; }
        .config-value { font-size: 14px; font-weight: 500; color: var(--ns-dark); }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--ns-secondary); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; }
        
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .status-active { background: rgba(34, 197, 94, 0.1); color: var(--ns-success); }
        .status-inactive { background: rgba(148, 163, 184, 0.1); color: var(--ns-secondary); }
    </style>
</head>
<body>
    <div class="nx-page">
        <aside class="nx-page__sidebar">
            <div class="nx-p-4 nx-mb-4">
                <h1 class="nx-text-lg nx-font-bold" style="display: flex; align-items: center; gap: 8px;">
                    <i class="ri-server-line"></i> Nexus Console
                </h1>
            </div>
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        
        <main class="nx-page__content">
            <header class="nx-page__header">
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-sidebar-toggle>
                        <i class="ri-menu-line"></i>
                    </button>
                    <h2 class="nx-text-lg nx-font-semibold">场景组管理</h2>
                </div>
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-theme-toggle>
                        <i class="ri-sun-line"></i>
                    </button>
                </div>
            </header>
            
            <div class="nx-page__main">
                <div class="nx-container">
                    <div class="group-container">
                        <div class="group-sidebar">
                            <div class="group-list">
                                <div class="group-list-header">
                                    <h3>场景组列表</h3>
                                </div>
                                <div id="groupList"></div>
                            </div>
                        </div>
                        <div class="group-main">
                            <div class="group-detail" id="groupDetail">
                                <div class="empty-state">
                                    <i class="ri-group-line"></i>
                                    <p>选择一个场景组查看详情</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="/console/js/nexus.js"></script>
    <script src="/console/js/nexus-menu.js"></script>
    <script src="/console/js/page-init.js" data-auto-init></script>
    <script>
        var groups = [];
        var currentGroupId = null;
        
        window.onPageInit = function() {
            loadGroups();
        };
        
        function loadGroups() {
            fetch('/api/scene/groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(function(res) { return res.json(); })
            .then(function(rs) {
                if (rs.requestStatus === 200) {
                    groups = rs.data || [];
                    renderGroupList(groups);
                    if (groups.length > 0) {
                        selectGroup(groups[0].sceneGroupId);
                    }
                }
            });
        }
        
        function renderGroupList(data) {
            var container = document.getElementById('groupList');
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--ns-secondary);">暂无场景组</div>';
                return;
            }
            
            var html = '';
            data.forEach(function(g) {
                var sceneCount = g.scenes ? g.scenes.length : 0;
                html += '<div class="group-item' + (currentGroupId === g.sceneGroupId ? ' active' : '') + '" onclick="selectGroup(\'' + g.sceneGroupId + '\')">' +
                    '<div class="group-item-name">' + g.name + '</div>' +
                    '<div class="group-item-meta">' + sceneCount + ' 场景 · ' + g.type + '</div>' +
                    '</div>';
            });
            container.innerHTML = html;
        }
        
        function selectGroup(groupId) {
            currentGroupId = groupId;
            var group = groups.find(function(g) { return g.sceneGroupId === groupId; });
            renderGroupList(groups);
            renderGroupDetail(group);
        }
        
        function renderGroupDetail(group) {
            if (!group) {
                document.getElementById('groupDetail').innerHTML = '<div class="empty-state"><i class="ri-group-line"></i><p>选择一个场景组查看详情</p></div>';
                return;
            }
            
            var definition = group.definition || {};
            var spec = definition.spec || {};
            var scenes = spec.scenes || [];
            var dependencies = spec.dependencies || [];
            var config = spec.config || {};
            
            var html = '<div class="group-detail-header">' +
                '<div class="group-detail-title">' + group.name + '</div>' +
                '<div class="group-detail-desc">' + (group.description || '') + '</div>' +
                '</div>' +
                '<div class="group-detail-body">';
            
            html += '<h4 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; color: var(--ns-dark)">包含场景 (' + scenes.length + ')</h4>';
            html += '<div class="scene-timeline">';
            
            scenes.forEach(function(s, idx) {
                var dotClass = s.required ? 'required' : 'optional';
                var autoStartText = s.autoStart ? '自动启动' : '手动启动';
                var priorityText = '优先级: ' + (s.priority || 0);
                
                html += '<div class="scene-timeline-item">' +
                    '<div class="scene-timeline-dot ' + dotClass + '"></div>' +
                    '<div class="scene-node">' +
                    '<div class="scene-node-header">' +
                    '<span class="scene-node-name">' + getSceneName(s.sceneId) + '</span>' +
                    '<span class="scene-node-id">' + s.sceneId + '</span>' +
                    '</div>' +
                    '<div class="scene-node-desc">' + (s.description || '') + '</div>' +
                    '<div class="scene-node-meta">' +
                    '<span><i class="ri-user-line"></i> ' + (s.roleId || 'PRIMARY') + '</span>' +
                    '<span><i class="ri-play-line"></i> ' + autoStartText + '</span>' +
                    '<span><i class="ri-flag-line"></i> ' + priorityText + '</span>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            });
            
            html += '</div>';
            
            if (dependencies.length > 0) {
                html += '<div class="dependency-section">' +
                    '<div class="dependency-title">场景依赖关系</div>' +
                    '<div class="dependency-graph">';
                
                dependencies.forEach(function(dep) {
                    var depScenes = dep.dependsOn || [];
                    if (depScenes.length > 0) {
                        html += '<div class="dep-flow" style="margin-bottom: 8px">';
                        depScenes.forEach(function(d, i) {
                            if (i > 0) html += '<span class="dep-arrow">→</span>';
                            html += '<span class="dep-node">' + d + '</span>';
                        });
                        html += '<span class="dep-arrow">→</span>';
                        html += '<span class="dep-node" style="background: var(--nx-primary); color: white;">' + dep.sceneId + '</span>';
                        html += '</div>';
                    }
                });
                
                html += '</div></div>';
            }
            
            if (Object.keys(config).length > 0) {
                html += '<div class="config-section">' +
                    '<div class="dependency-title">组配置</div>' +
                    '<div class="config-grid">';
                
                for (var key in config) {
                    var value = config[key];
                    if (typeof value === 'object') value = JSON.stringify(value);
                    html += '<div class="config-item">' +
                        '<div class="config-label">' + key + '</div>' +
                        '<div class="config-value">' + value + '</div>' +
                        '</div>';
                }
                
                html += '</div></div>';
            }
            
            html += '</div>';
            document.getElementById('groupDetail').innerHTML = html;
        }
        
        function getSceneName(sceneId) {
            var names = {
                'vfs': '虚拟文件系统',
                'auth': '认证授权',
                'org': '组织管理',
                'msg': '消息服务',
                'workflow': '工作流管理',
                'a2ui': 'UI生成'
            };
            return names[sceneId] || sceneId;
        }
    </script>
</body>
</html>
