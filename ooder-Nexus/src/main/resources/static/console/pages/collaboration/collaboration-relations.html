<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>协作关系 - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/nexus.css">
    <style>
        .relation-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: calc(100vh - 200px); }
        
        .relation-tree { background: var(--ns-card-bg); border: 1px solid var(--ns-border); border-radius: 8px; overflow-y: auto; }
        .tree-header { padding: 16px; border-bottom: 1px solid var(--ns-border); font-weight: 600; font-size: 14px; color: var(--ns-dark); }
        .tree-content { padding: 8px; }
        
        .tree-item { padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
        .tree-item:hover { background: var(--ns-bg-hover); }
        .tree-item.active { background: rgba(59, 130, 246, 0.1); color: var(--nx-primary); }
        .tree-item.scene { padding-left: 12px; }
        .tree-item.group { padding-left: 32px; }
        .tree-item.skill { padding-left: 52px; }
        .tree-item i { font-size: 16px; }
        .tree-item.scene > i { color: var(--nx-primary); }
        .tree-item.group > i { color: var(--ns-success); }
        .tree-item.skill > i { color: var(--ns-warning); }
        
        .relation-detail { background: var(--ns-card-bg); border: 1px solid var(--ns-border); border-radius: 8px; display: flex; flex-direction: column; }
        .detail-header { padding: 16px 20px; border-bottom: 1px solid var(--ns-border); display: flex; justify-content: space-between; align-items: center; }
        .detail-title { font-size: 16px; font-weight: 600; color: var(--ns-dark); display: flex; align-items: center; gap: 8px; }
        .detail-type { font-size: 12px; padding: 2px 8px; border-radius: 4px; background: var(--ns-input-bg); color: var(--ns-secondary); }
        
        .detail-content { flex: 1; padding: 20px; overflow-y: auto; }
        
        .detail-section { margin-bottom: 24px; }
        .detail-section-title { font-size: 14px; font-weight: 500; color: var(--ns-dark); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .detail-section-title i { color: var(--nx-primary); }
        
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .info-item { display: flex; flex-direction: column; gap: 4px; }
        .info-label { font-size: 12px; color: var(--ns-secondary); }
        .info-value { font-size: 14px; color: var(--ns-dark); }
        
        .capability-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .capability-tag { padding: 6px 12px; background: var(--ns-input-bg); border-radius: 6px; font-size: 13px; color: var(--ns-dark); display: flex; align-items: center; gap: 6px; }
        .capability-tag i { color: var(--nx-primary); }
        
        .member-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .member-card { padding: 12px; background: var(--ns-input-bg); border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .member-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--nx-primary), #6366f1); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .member-info { flex: 1; }
        .member-name { font-size: 13px; color: var(--ns-dark); }
        .member-role { font-size: 11px; color: var(--ns-secondary); }
        
        .skill-list { display: flex; flex-direction: column; gap: 12px; }
        .skill-item { padding: 12px 16px; background: var(--ns-input-bg); border-radius: 8px; display: flex; align-items: center; gap: 12px; }
        .skill-icon { width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, var(--ns-warning), #f59e0b); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        .skill-info { flex: 1; }
        .skill-name { font-size: 14px; color: var(--ns-dark); }
        .skill-meta { font-size: 12px; color: var(--ns-secondary); }
        
        .graph-container { display: flex; justify-content: center; align-items: center; min-height: 300px; }
        .graph-placeholder { text-align: center; color: var(--ns-secondary); }
        .graph-placeholder i { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--ns-secondary); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="nx-page">
        <aside class="nx-page__sidebar">
            <div class="nx-p-4 nx-mb-4">
                <h1 class="nx-text-lg nx-font-bold" style="display: flex; align-items: center; gap: 8px;">
                    <i class="ri-server-line"></i> Nexus Console
                </h1>
            </div>
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        
        <main class="nx-page__content">
            <header class="nx-page__header">
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-sidebar-toggle>
                        <i class="ri-menu-line"></i>
                    </button>
                    <h2 class="nx-text-lg nx-font-semibold">协作关系</h2>
                </div>
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-theme-toggle>
                        <i class="ri-sun-line"></i>
                    </button>
                </div>
            </header>
            
            <div class="nx-page__main">
                <div class="nx-container">
                    <div class="relation-container">
                        <div class="relation-tree">
                            <div class="tree-header">协作结构</div>
                            <div class="tree-content" id="treeContent">
                                <div class="empty-state">
                                    <i class="ri-apps-line"></i>
                                    <p>暂无协作关系</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relation-detail">
                            <div class="detail-header">
                                <div class="detail-title" id="detailTitle">
                                    <i class="ri-information-line"></i>
                                    选择节点查看详情
                                </div>
                                <span class="detail-type" id="detailType"></span>
                            </div>
                            <div class="detail-content" id="detailContent">
                                <div class="empty-state">
                                    <i class="ri-arrow-left-line"></i>
                                    <p>从左侧选择一个节点查看详细信息</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="/console/js/nexus.js"></script>
    <script src="/console/js/nexus-menu.js"></script>
    <script src="/console/js/page-init.js" data-auto-init></script>
    <script>
        var currentUserId = 'user-001';
        var relations = null;
        var selectedItem = null;
        
        window.onPageInit = function() {
            loadRelations();
        };
        
        function loadRelations() {
            fetch('/api/collaboration/user/relations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUserId })
            })
            .then(function(res) { return res.json(); })
            .then(function(rs) {
                if (rs.requestStatus === 200) {
                    relations = rs.data;
                    renderTree();
                }
            });
        }
        
        function renderTree() {
            if (!relations || !relations.scenes || relations.scenes.length === 0) {
                document.getElementById('treeContent').innerHTML = '<div class="empty-state"><i class="ri-apps-line"></i><p>暂无协作关系</p></div>';
                return;
            }
            
            var html = '';
            
            relations.scenes.forEach(function(scene) {
                html += '<div class="tree-item scene" onclick="selectScene(\'' + scene.sceneId + '\')">' +
                    '<i class="ri-apps-line"></i>' +
                    '<span>' + scene.sceneName + '</span>' +
                    '</div>';
                
                if (scene.groupIds) {
                    scene.groupIds.forEach(function(groupId) {
                        var group = relations.groups.find(function(g) { return g.groupId === groupId; });
                        if (group) {
                            html += '<div class="tree-item group" onclick="selectGroup(\'' + group.groupId + '\')">' +
                                '<i class="ri-team-line"></i>' +
                                '<span>' + group.groupName + '</span>' +
                                '</div>';
                            
                            if (group.skillIds) {
                                group.skillIds.forEach(function(skillId) {
                                    var skill = relations.skills.find(function(s) { return s.skillId === skillId; });
                                    if (skill) {
                                        html += '<div class="tree-item skill" onclick="selectSkill(\'' + skill.skillId + '\')">' +
                                            '<i class="ri-lightbulb-line"></i>' +
                                            '<span>' + skill.skillName + '</span>' +
                                            '</div>';
                                    }
                                });
                            }
                        }
                    });
                }
            });
            
            document.getElementById('treeContent').innerHTML = html;
        }
        
        function selectScene(sceneId) {
            setActiveItem(event.target);
            selectedItem = { type: 'scene', id: sceneId };
            
            var scene = relations.scenes.find(function(s) { return s.sceneId === sceneId; });
            if (!scene) return;
            
            document.getElementById('detailTitle').innerHTML = '<i class="ri-apps-line"></i> ' + scene.sceneName;
            document.getElementById('detailType').textContent = '场景';
            
            var html = '<div class="detail-section">' +
                '<div class="detail-section-title"><i class="ri-information-line"></i> 基本信息</div>' +
                '<div class="info-grid">' +
                '<div class="info-item"><span class="info-label">场景ID</span><span class="info-value">' + scene.sceneId + '</span></div>' +
                '<div class="info-item"><span class="info-label">场景类型</span><span class="info-value">' + (scene.sceneType === 'enterprise' ? '企业' : '个人') + '</span></div>' +
                '<div class="info-item"><span class="info-label">描述</span><span class="info-value">' + (scene.description || '-') + '</span></div>' +
                '<div class="info-item"><span class="info-label">加入时间</span><span class="info-value">' + formatTime(scene.joinedAt) + '</span></div>' +
                '</div></div>';
            
            if (scene.capabilities && scene.capabilities.length > 0) {
                html += '<div class="detail-section">' +
                    '<div class="detail-section-title"><i class="ri-flashlight-line"></i> 能力列表</div>' +
                    '<div class="capability-list">';
                scene.capabilities.forEach(function(cap) {
                    html += '<div class="capability-tag"><i class="ri-flashlight-line"></i>' + cap + '</div>';
                });
                html += '</div></div>';
            }
            
            document.getElementById('detailContent').innerHTML = html;
        }
        
        function selectGroup(groupId) {
            setActiveItem(event.target);
            selectedItem = { type: 'group', id: groupId };
            
            var group = relations.groups.find(function(g) { return g.groupId === groupId; });
            if (!group) return;
            
            document.getElementById('detailTitle').innerHTML = '<i class="ri-team-line"></i> ' + group.groupName;
            document.getElementById('detailType').textContent = '协作组';
            
            var html = '<div class="detail-section">' +
                '<div class="detail-section-title"><i class="ri-information-line"></i> 基本信息</div>' +
                '<div class="info-grid">' +
                '<div class="info-item"><span class="info-label">组ID</span><span class="info-value">' + group.groupId + '</span></div>' +
                '<div class="info-item"><span class="info-label">组地址</span><span class="info-value">' + group.groupAddress + '</span></div>' +
                '<div class="info-item"><span class="info-label">关联场景</span><span class="info-value">' + group.sceneName + '</span></div>' +
                '<div class="info-item"><span class="info-label">我的角色</span><span class="info-value">' + (group.role === 'admin' ? '管理员' : '成员') + '</span></div>' +
                '</div></div>';
            
            if (group.skillIds && group.skillIds.length > 0) {
                html += '<div class="detail-section">' +
                    '<div class="detail-section-title"><i class="ri-lightbulb-line"></i> 组内技能</div>' +
                    '<div class="skill-list">';
                group.skillIds.forEach(function(skillId) {
                    var skill = relations.skills.find(function(s) { return s.skillId === skillId; });
                    if (skill) {
                        html += '<div class="skill-item">' +
                            '<div class="skill-icon"><i class="ri-lightbulb-line"></i></div>' +
                            '<div class="skill-info">' +
                            '<div class="skill-name">' + skill.skillName + '</div>' +
                            '<div class="skill-meta">v' + skill.version + ' · ' + skill.capabilities.length + ' 个能力</div>' +
                            '</div></div>';
                    }
                });
                html += '</div></div>';
            }
            
            document.getElementById('detailContent').innerHTML = html;
            
            loadGroupMembers(groupId);
        }
        
        function loadGroupMembers(groupId) {
            fetch('/api/collaboration/group/members', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ groupId: groupId })
            })
            .then(function(res) { return res.json(); })
            .then(function(rs) {
                if (rs.requestStatus === 200 && rs.data && rs.data.length > 0) {
                    var html = '<div class="detail-section">' +
                        '<div class="detail-section-title"><i class="ri-user-line"></i> 组成员 (' + rs.data.length + ')</div>' +
                        '<div class="member-grid">';
                    rs.data.forEach(function(member) {
                        html += '<div class="member-card">' +
                            '<div class="member-avatar">' + member.userName.charAt(0) + '</div>' +
                            '<div class="member-info">' +
                            '<div class="member-name">' + member.userName + '</div>' +
                            '<div class="member-role">' + (member.role === 'admin' ? '管理员' : '成员') + '</div>' +
                            '</div></div>';
                    });
                    html += '</div></div>';
                    document.getElementById('detailContent').innerHTML += html;
                }
            });
        }
        
        function selectSkill(skillId) {
            setActiveItem(event.target);
            selectedItem = { type: 'skill', id: skillId };
            
            var skill = relations.skills.find(function(s) { return s.skillId === skillId; });
            if (!skill) return;
            
            document.getElementById('detailTitle').innerHTML = '<i class="ri-lightbulb-line"></i> ' + skill.skillName;
            document.getElementById('detailType').textContent = skill.skillType === 'enterprise' ? '企业技能' : '个人技能';
            
            var html = '<div class="detail-section">' +
                '<div class="detail-section-title"><i class="ri-information-line"></i> 基本信息</div>' +
                '<div class="info-grid">' +
                '<div class="info-item"><span class="info-label">技能ID</span><span class="info-value">' + skill.skillId + '</span></div>' +
                '<div class="info-item"><span class="info-label">版本</span><span class="info-value">' + skill.version + '</span></div>' +
                '<div class="info-item"><span class="info-label">状态</span><span class="info-value">' + (skill.status === 'active' ? '运行中' : '已停止') + '</span></div>' +
                '<div class="info-item"><span class="info-label">安装时间</span><span class="info-value">' + formatTime(skill.installedAt) + '</span></div>' +
                '</div></div>';
            
            if (skill.capabilities && skill.capabilities.length > 0) {
                html += '<div class="detail-section">' +
                    '<div class="detail-section-title"><i class="ri-flashlight-line"></i> 提供能力</div>' +
                    '<div class="capability-list">';
                skill.capabilities.forEach(function(cap) {
                    html += '<div class="capability-tag"><i class="ri-flashlight-line"></i>' + cap + '</div>';
                });
                html += '</div></div>';
            }
            
            document.getElementById('detailContent').innerHTML = html;
        }
        
        function setActiveItem(target) {
            document.querySelectorAll('.tree-item').forEach(function(item) {
                item.classList.remove('active');
            });
            target.closest('.tree-item').classList.add('active');
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            var d = new Date(timestamp);
            return d.getFullYear() + '-' + 
                   (d.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                   d.getDate().toString().padStart(2, '0');
        }
    </script>
</body>
</html>
