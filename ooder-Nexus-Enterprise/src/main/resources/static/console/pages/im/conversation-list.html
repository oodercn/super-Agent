<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会话列表 - Nexus Console</title>
    
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/nexus.css">
    <style>
        .conversation-container { display: flex; height: calc(100vh - 140px); gap: 16px; }
        
        .conversation-list { width: 320px; background: var(--ns-card-bg); border-radius: 12px; border: 1px solid var(--ns-border); display: flex; flex-direction: column; }
        .conversation-list-header { padding: 16px; border-bottom: 1px solid var(--ns-border); }
        .conversation-list-header h3 { margin: 0 0 12px 0; color: var(--ns-dark); }
        .search-box { display: flex; align-items: center; background: var(--ns-input-bg); border-radius: 8px; padding: 8px 12px; }
        .search-box i { color: var(--ns-secondary); margin-right: 8px; }
        .search-box input { background: none; border: none; color: var(--ns-dark); width: 100%; outline: none; }
        
        .conversation-items { flex: 1; overflow-y: auto; }
        .conversation-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--ns-border); }
        .conversation-item:hover { background: var(--ns-bg-hover); }
        .conversation-item.active { background: rgba(59, 130, 246, 0.1); }
        .conversation-item.pinned { background: rgba(245, 158, 11, 0.05); }
        
        .conv-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--nx-primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; margin-right: 12px; flex-shrink: 0; }
        .conv-avatar.group { background: var(--ns-success); }
        .conv-avatar.department { background: var(--ns-warning); }
        
        .conv-info { flex: 1; min-width: 0; }
        .conv-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .conv-name { font-weight: 500; color: var(--ns-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conv-time { font-size: 12px; color: var(--ns-secondary); }
        .conv-last-msg { font-size: 13px; color: var(--ns-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .conv-badge { background: var(--ns-danger); color: white; font-size: 12px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
        .conv-pin-icon { color: var(--ns-warning); margin-left: 8px; }
        .conv-mute-icon { color: var(--ns-secondary); margin-left: 4px; }
        
        .conversation-detail { flex: 1; background: var(--ns-card-bg); border-radius: 12px; border: 1px solid var(--ns-border); display: flex; flex-direction: column; }
        .detail-header { padding: 16px; border-bottom: 1px solid var(--ns-border); display: flex; justify-content: space-between; align-items: center; }
        .detail-header h3 { margin: 0; color: var(--ns-dark); display: flex; align-items: center; gap: 8px; }
        .detail-actions { display: flex; gap: 8px; }
        
        .detail-stats { display: flex; gap: 24px; padding: 12px 16px; background: var(--ns-input-bg); border-radius: 8px; margin: 16px; }
        .stat-item { text-align: center; }
        .stat-item .value { font-size: 24px; font-weight: 600; color: var(--nx-primary); }
        .stat-item .label { font-size: 12px; color: var(--ns-secondary); margin-top: 4px; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--nx-primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: var(--ns-card-bg); color: var(--ns-dark); border: 1px solid var(--ns-border); }
        .btn-secondary:hover { background: var(--ns-bg-hover); }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .btn-icon { padding: 8px; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--ns-secondary); }
        .empty-state i { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--ns-card-bg); border-radius: 12px; padding: 24px; width: 500px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: var(--ns-dark); }
        .modal-close { background: none; border: none; color: var(--ns-secondary); font-size: 24px; cursor: pointer; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--ns-secondary); }
        .form-group input, .form-group select { width: 100%; background: var(--ns-input-bg); border: 1px solid var(--ns-border); color: var(--ns-dark); padding: 10px 12px; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="nx-page">
        <aside class="nx-page__sidebar">
            <div class="nx-p-4 nx-mb-4">
                <h1 class="nx-text-lg nx-font-bold" style="display: flex; align-items: center; gap: 8px;">
                    <i class="ri-server-line"></i> Nexus Console
                </h1>
            </div>
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        
        <main class="nx-page__content">
            <header class="nx-page__header">
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-sidebar-toggle>
                        <i class="ri-menu-line"></i>
                    </button>
                    <h2 class="nx-text-lg nx-font-semibold"><i class="ri-chat-1-line"></i> 会话列表</h2>
                </div>
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        <i class="ri-add-line"></i> 新建会话
                    </button>
                </div>
            </header>
            
            <div class="nx-page__main">
                <div class="nx-container">
                    <div class="conversation-container">
                        <div class="conversation-list">
                            <div class="conversation-list-header">
                                <h3><i class="ri-chat-3-line"></i> 全部会话</h3>
                                <div class="search-box">
                                    <i class="ri-search-line"></i>
                                    <input type="text" placeholder="搜索会话..." id="searchInput" oninput="filterConversations()">
                                </div>
                            </div>
                            <div class="conversation-items" id="conversationList">
                            </div>
                        </div>
                        
                        <div class="conversation-detail" id="conversationDetail">
                            <div class="empty-state">
                                <i class="ri-chat-off-line"></i>
                                <p>选择一个会话查看详情</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="ri-add-line"></i> 新建会话</h3>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>会话类型</label>
                <select id="convType">
                    <option value="private">私聊</option>
                    <option value="group">群组</option>
                    <option value="department">部门</option>
                </select>
            </div>
            <div class="form-group">
                <label>会话名称</label>
                <input type="text" id="convName" placeholder="输入会话名称">
            </div>
            <div class="form-group">
                <label>目标ID</label>
                <input type="text" id="convTargetId" placeholder="用户ID/群组ID/部门ID">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="closeCreateModal()">取消</button>
                <button class="btn btn-primary" onclick="createConversation()">创建</button>
            </div>
        </div>
    </div>
    
    <script src="/console/js/nexus.js"></script>
    <script src="/console/js/nexus-menu.js"></script>
    <script src="/console/js/page-init.js" data-auto-init></script>
    <script>
        var currentUserId = 'user-001';
        var conversations = [];
        var selectedConv = null;
        
        window.onPageInit = function() {
            loadConversations();
        };
        
        function loadConversations() {
            fetch('/api/gateway/im/conversation/list', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUserId })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    conversations = data.data || [];
                    renderConversations();
                }
            })
            .catch(function(err) { console.error('加载会话失败:', err); });
        }
        
        function renderConversations() {
            var container = document.getElementById('conversationList');
            container.innerHTML = '';
            
            conversations.forEach(function(conv) {
                var item = document.createElement('div');
                item.className = 'conversation-item' + (conv.pinned ? ' pinned' : '');
                item.onclick = function() { selectConversation(conv); };
                
                var avatarClass = conv.conversationType === 'group' ? 'group' : (conv.conversationType === 'department' ? 'department' : '');
                var avatarIcon = conv.conversationType === 'group' ? 'ri-group-line' : (conv.conversationType === 'department' ? 'ri-building-line' : 'ri-user-line');
                
                item.innerHTML = 
                    '<div class="conv-avatar ' + avatarClass + '"><i class="' + avatarIcon + '"></i></div>' +
                    '<div class="conv-info">' +
                        '<div class="conv-header">' +
                            '<span class="conv-name">' + (conv.name || conv.targetId) + '</span>' +
                            '<span class="conv-time">' + formatTime(conv.lastMessageTime) + '</span>' +
                        '</div>' +
                        '<div class="conv-last-msg">' + (conv.lastMessage || '暂无消息') + '</div>' +
                    '</div>' +
                    (conv.unreadCount > 0 ? '<span class="conv-badge">' + conv.unreadCount + '</span>' : '') +
                    (conv.pinned ? '<i class="ri-pushpin-fill conv-pin-icon"></i>' : '') +
                    (conv.muted ? '<i class="ri-volume-mute-line conv-mute-icon"></i>' : '');
                
                container.appendChild(item);
            });
        }
        
        function selectConversation(conv) {
            selectedConv = conv;
            var items = document.querySelectorAll('.conversation-item');
            items.forEach(function(item) { item.classList.remove('active'); });
            event.currentTarget.classList.add('active');
            
            markAsRead(conv.conversationId);
            showConversationDetail(conv);
        }
        
        function showConversationDetail(conv) {
            var detail = document.getElementById('conversationDetail');
            var avatarClass = conv.conversationType === 'group' ? 'group' : (conv.conversationType === 'department' ? 'department' : '');
            var typeLabel = conv.conversationType === 'group' ? '群组' : (conv.conversationType === 'department' ? '部门' : '私聊');
            
            detail.innerHTML = 
                '<div class="detail-header">' +
                    '<h3><div class="conv-avatar ' + avatarClass + '" style="width:32px;height:32px;font-size:14px;"><i class="ri-user-line"></i></div> ' + (conv.name || conv.targetId) + '</h3>' +
                    '<div class="detail-actions">' +
                        '<button class="btn btn-secondary btn-sm" onclick="togglePin(\'' + conv.conversationId + '\')"><i class="ri-pushpin-line"></i></button>' +
                        '<button class="btn btn-secondary btn-sm" onclick="toggleMute(\'' + conv.conversationId + '\')"><i class="ri-volume-mute-line"></i></button>' +
                        '<button class="btn btn-secondary btn-sm" onclick="deleteConversation(\'' + conv.conversationId + '\')"><i class="ri-delete-bin-line"></i></button>' +
                    '</div>' +
                '</div>' +
                '<div class="detail-stats">' +
                    '<div class="stat-item"><div class="value">' + typeLabel + '</div><div class="label">类型</div></div>' +
                    '<div class="stat-item"><div class="value">' + conv.unreadCount + '</div><div class="label">未读消息</div></div>' +
                    '<div class="stat-item"><div class="value">' + formatTime(conv.lastMessageTime) + '</div><div class="label">最后消息</div></div>' +
                '</div>';
        }
        
        function markAsRead(convId) {
            fetch('/api/im/conversation/read', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ conversationId: convId })
            })
            .then(function() { loadConversations(); });
        }
        
        function togglePin(convId) {
            var conv = conversations.find(function(c) { return c.conversationId === convId; });
            if (conv) {
                fetch('/api/im/conversation/pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversationId: convId, pinned: !conv.pinned })
                })
                .then(function() { loadConversations(); });
            }
        }
        
        function toggleMute(convId) {
            var conv = conversations.find(function(c) { return c.conversationId === convId; });
            if (conv) {
                fetch('/api/im/conversation/mute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversationId: convId, muted: !conv.muted })
                })
                .then(function() { loadConversations(); });
            }
        }
        
        function deleteConversation(convId) {
            if (confirm('确定要删除这个会话吗？')) {
                fetch('/api/im/conversation/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversationId: convId })
                })
                .then(function() { loadConversations(); });
            }
        }
        
        function openCreateModal() { document.getElementById('createModal').classList.add('active'); }
        function closeCreateModal() { document.getElementById('createModal').classList.remove('active'); }
        
        function createConversation() {
            var type = document.getElementById('convType').value;
            var name = document.getElementById('convName').value;
            var targetId = document.getElementById('convTargetId').value;
            
            fetch('/api/im/conversation/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ownerId: currentUserId, type: type, name: name, targetId: targetId })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    closeCreateModal();
                    loadConversations();
                }
            });
        }
        
        function filterConversations() {
            var keyword = document.getElementById('searchInput').value.toLowerCase();
            var items = document.querySelectorAll('.conversation-item');
            items.forEach(function(item) {
                var name = item.querySelector('.conv-name').textContent.toLowerCase();
                item.style.display = name.indexOf(keyword) > -1 ? 'flex' : 'none';
            });
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '';
            var date = new Date(timestamp);
            return date.getHours() + ':' + String(date.getMinutes()).padStart(2, '0');
        }
    </script>
</body>
</html>
