<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理大屏 - Nexus Console</title>
    
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/nexus.css">
    <style>
        .dashboard-header {
            background: var(--nx-primary);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
        }
        
        .dashboard-header h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
        }
        
        .dashboard-header__meta {
            display: flex;
            gap: 24px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--ns-card-bg);
            border: 1px solid var(--ns-border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .stat-card__icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .stat-card__icon.primary {
            background: rgba(59, 130, 246, 0.2);
            color: var(--nx-primary);
        }
        
        .stat-card__icon.success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--ns-success);
        }
        
        .stat-card__icon.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--ns-warning);
        }
        
        .stat-card__icon.danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--ns-danger);
        }
        
        .stat-card__info h3 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            color: var(--ns-dark);
        }
        
        .stat-card__info p {
            margin: 4px 0 0 0;
            font-size: 14px;
            color: var(--ns-secondary);
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: var(--ns-card-bg);
            border: 1px solid var(--ns-border);
            border-radius: 12px;
        }
        
        .panel__header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--ns-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel__title {
            font-size: 16px;
            font-weight: 600;
            color: var(--ns-dark);
        }
        
        .panel__body {
            padding: 16px 20px;
        }
        
        .service-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--ns-input-bg);
            border-radius: 8px;
        }
        
        .service-item__name {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--ns-dark);
        }
        
        .service-item__icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .service-item__status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.up {
            background: rgba(34, 197, 94, 0.2);
            color: var(--ns-success);
        }
        
        .status-badge.down {
            background: rgba(239, 68, 68, 0.2);
            color: var(--ns-danger);
        }
        
        .status-badge.degraded {
            background: rgba(245, 158, 11, 0.2);
            color: var(--ns-warning);
        }
        
        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .alert-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--ns-input-bg);
            border-radius: 8px;
            border-left: 3px solid;
        }
        
        .alert-item.warning {
            border-left-color: var(--ns-warning);
        }
        
        .alert-item.critical, .alert-item.error {
            border-left-color: var(--ns-danger);
        }
        
        .alert-item.info {
            border-left-color: var(--nx-primary);
        }
        
        .alert-item__icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .alert-item__icon.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--ns-warning);
        }
        
        .alert-item__icon.critical, .alert-item__icon.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--ns-danger);
        }
        
        .alert-item__icon.info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--nx-primary);
        }
        
        .alert-item__content {
            flex: 1;
        }
        
        .alert-item__message {
            color: var(--ns-dark);
            margin-bottom: 4px;
        }
        
        .alert-item__time {
            font-size: 12px;
            color: var(--ns-secondary);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .quick-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: var(--ns-input-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .quick-action:hover {
            border-color: var(--nx-primary);
            background: var(--ns-bg-hover);
        }
        
        .quick-action__icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(59, 130, 246, 0.2);
            color: var(--nx-primary);
        }
        
        .quick-action__label {
            font-size: 13px;
            color: var(--ns-dark);
        }
        
        .progress-bar {
            height: 8px;
            background: var(--ns-border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar__fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .progress-bar__fill.primary {
            background: var(--nx-primary);
        }
        
        .progress-bar__fill.success {
            background: var(--ns-success);
        }
        
        .progress-bar__fill.warning {
            background: var(--ns-warning);
        }
        
        .progress-bar__fill.danger {
            background: var(--ns-danger);
        }
        
        .refresh-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--ns-secondary);
        }
        
        .refresh-indicator.spinning i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--ns-secondary);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="nx-page">
        <aside class="nx-page__sidebar">
            <div class="nx-p-4 nx-mb-4">
                <h1 class="nx-text-lg nx-font-bold" style="display: flex; align-items: center; gap: 8px;">
                    <i class="ri-server-line"></i> Nexus Console
                </h1>
            </div>
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        
        <main class="nx-page__content">
            <header class="nx-page__header">
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-sidebar-toggle>
                        <i class="ri-menu-line"></i>
                    </button>
                    <h2 class="nx-text-lg nx-font-semibold">管理大屏</h2>
                </div>
                <div class="nx-flex nx-items-center nx-gap-3">
                    <div class="refresh-indicator" id="refreshIndicator">
                        <i class="ri-refresh-line"></i>
                        <span id="lastUpdate">-</span>
                    </div>
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-theme-toggle>
                        <i class="ri-sun-line"></i>
                    </button>
                    <button class="nx-btn nx-btn--primary" onclick="refreshAll()">
                        <i class="ri-refresh-line"></i> 刷新
                    </button>
                </div>
            </header>
            
            <div class="nx-page__main">
                <div class="nx-container">
                    <div class="dashboard-header">
                        <h1><i class="ri-dashboard-3-line"></i> Nexus 管理大屏</h1>
                        <div class="dashboard-header__meta">
                            <span><i class="ri-time-line"></i> 运行时间: <span id="uptime">-</span></span>
                            <span><i class="ri-heart-pulse-line"></i> 系统状态: <span id="systemStatus">-</span></span>
                            <span><i class="ri-calendar-line"></i> <span id="currentTime">-</span></span>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-card__icon primary">
                                <i class="ri-user-line"></i>
                            </div>
                            <div class="stat-card__info">
                                <h3 id="activeSessions">-</h3>
                                <p>活跃会话</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__icon success">
                                <i class="ri-database-2-line"></i>
                            </div>
                            <div class="stat-card__info">
                                <h3 id="cacheHitRate">-</h3>
                                <p>缓存命中率</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__icon warning">
                                <i class="ri-heart-line"></i>
                            </div>
                            <div class="stat-card__info">
                                <h3 id="serviceHealth">-</h3>
                                <p>服务健康</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__icon danger">
                                <i class="ri-alarm-warning-line"></i>
                            </div>
                            <div class="stat-card__info">
                                <h3 id="alertCount">-</h3>
                                <p>告警数量</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="two-column">
                        <div class="panel">
                            <div class="panel__header">
                                <span class="panel__title">系统资源</span>
                            </div>
                            <div class="panel__body">
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: var(--ns-dark);">CPU 使用率</span>
                                        <span id="cpuUsageText" style="color: var(--ns-secondary);">-</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar__fill primary" id="cpuUsageBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: var(--ns-dark);">内存使用率</span>
                                        <span id="memoryUsageText" style="color: var(--ns-secondary);">-</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar__fill success" id="memoryUsageBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: var(--ns-dark);">磁盘使用率</span>
                                        <span id="diskUsageText" style="color: var(--ns-secondary);">-</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar__fill warning" id="diskUsageBar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel__header">
                                <span class="panel__title">服务状态</span>
                            </div>
                            <div class="panel__body">
                                <div class="service-list" id="serviceList">
                                    <div class="empty-state">
                                        <i class="ri-loader-4-line"></i>
                                        <p>加载中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="two-column">
                        <div class="panel">
                            <div class="panel__header">
                                <span class="panel__title">最近告警</span>
                                <button class="nx-btn nx-btn--sm nx-btn--secondary" onclick="clearAlerts()">
                                    清除
                                </button>
                            </div>
                            <div class="panel__body">
                                <div class="alert-list" id="alertList">
                                    <div class="empty-state">
                                        <i class="ri-checkbox-circle-line"></i>
                                        <p>暂无告警</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel__header">
                                <span class="panel__title">快捷操作</span>
                            </div>
                            <div class="panel__body">
                                <div class="quick-actions">
                                    <div class="quick-action" onclick="clearCache()">
                                        <div class="quick-action__icon">
                                            <i class="ri-delete-bin-line"></i>
                                        </div>
                                        <span class="quick-action__label">清理缓存</span>
                                    </div>
                                    <div class="quick-action" onclick="runHealthCheck()">
                                        <div class="quick-action__icon">
                                            <i class="ri-heart-pulse-line"></i>
                                        </div>
                                        <span class="quick-action__label">健康检查</span>
                                    </div>
                                    <div class="quick-action" onclick="exportReport()">
                                        <div class="quick-action__icon">
                                            <i class="ri-file-download-line"></i>
                                        </div>
                                        <span class="quick-action__label">导出报告</span>
                                    </div>
                                    <div class="quick-action" onclick="viewLogs()">
                                        <div class="quick-action__icon">
                                            <i class="ri-file-list-3-line"></i>
                                        </div>
                                        <span class="quick-action__label">查看日志</span>
                                    </div>
                                    <div class="quick-action" onclick="viewSessions()">
                                        <div class="quick-action__icon">
                                            <i class="ri-user-settings-line"></i>
                                        </div>
                                        <span class="quick-action__label">会话管理</span>
                                    </div>
                                    <div class="quick-action" onclick="viewSettings()">
                                        <div class="quick-action__icon">
                                            <i class="ri-settings-3-line"></i>
                                        </div>
                                        <span class="quick-action__label">系统设置</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/console/js/nexus.js"></script>
    <script src="/console/js/nexus-menu.js"></script>
    <script src="/console/js/page-init.js" data-auto-init></script>
    <script>
        var refreshInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadAll();
            startAutoRefresh();
            updateCurrentTime();
        });

        function startAutoRefresh() {
            refreshInterval = setInterval(function() {
                refreshAll();
            }, 30000);
        }

        function updateCurrentTime() {
            setInterval(function() {
                document.getElementById('currentTime').textContent = new Date().toLocaleString('zh-CN');
            }, 1000);
        }

        function loadAll() {
            loadSystemMetrics();
            loadSessionStats();
            loadCacheStats();
            loadServiceHealth();
            loadAlerts();
        }

        function refreshAll() {
            var indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('spinning');
            
            loadAll();
            
            setTimeout(function() {
                indicator.classList.remove('spinning');
                updateLastRefresh();
            }, 1000);
        }

        function updateLastRefresh() {
            document.getElementById('lastUpdate').textContent = '更新于 ' + new Date().toLocaleTimeString('zh-CN');
        }

        async function loadSystemMetrics() {
            try {
                var response = await fetch('/api/monitor/metrics');
                var rs = await response.json();
                if (rs.success && rs.data) {
                    renderSystemMetrics(rs.data);
                }
            } catch (error) {
                console.error('Load system metrics failed:', error);
            }
        }

        function renderSystemMetrics(metrics) {
            var cpuUsage = metrics.cpuUsage || 0;
            var memoryUsage = metrics.memoryUsage || 0;
            var diskUsage = metrics.diskUsage || 0;
            
            document.getElementById('cpuUsageText').textContent = cpuUsage.toFixed(1) + '%';
            document.getElementById('cpuUsageBar').style.width = cpuUsage + '%';
            updateProgressBarClass('cpuUsageBar', cpuUsage);
            
            document.getElementById('memoryUsageText').textContent = memoryUsage.toFixed(1) + '%';
            document.getElementById('memoryUsageBar').style.width = memoryUsage + '%';
            updateProgressBarClass('memoryUsageBar', memoryUsage);
            
            document.getElementById('diskUsageText').textContent = diskUsage.toFixed(1) + '%';
            document.getElementById('diskUsageBar').style.width = diskUsage + '%';
            updateProgressBarClass('diskUsageBar', diskUsage);
            
            if (metrics.uptime) {
                document.getElementById('uptime').textContent = formatUptime(metrics.uptime);
            }
            
            document.getElementById('systemStatus').textContent = metrics.status || 'UNKNOWN';
        }

        function updateProgressBarClass(barId, value) {
            var bar = document.getElementById(barId);
            bar.classList.remove('primary', 'success', 'warning', 'danger');
            if (value >= 90) {
                bar.classList.add('danger');
            } else if (value >= 80) {
                bar.classList.add('warning');
            } else {
                bar.classList.add('success');
            }
        }

        async function loadSessionStats() {
            try {
                var response = await fetch('/api/session/stats', { method: 'POST' });
                var rs = await response.json();
                if (rs.success && rs.data) {
                    document.getElementById('activeSessions').textContent = rs.data.activeSessions || 0;
                }
            } catch (error) {
                console.error('Load session stats failed:', error);
            }
        }

        async function loadCacheStats() {
            try {
                var response = await fetch('/api/cache/stats', { method: 'POST' });
                var rs = await response.json();
                if (rs.success && rs.data) {
                    document.getElementById('cacheHitRate').textContent = rs.data.hitRate.toFixed(1) + '%';
                }
            } catch (error) {
                console.error('Load cache stats failed:', error);
            }
        }

        async function loadServiceHealth() {
            try {
                var response = await fetch('/api/health/services');
                var rs = await response.json();
                if (rs.success && rs.data) {
                    renderServiceHealth(rs.data);
                }
            } catch (error) {
                console.error('Load service health failed:', error);
            }
        }

        function renderServiceHealth(services) {
            var html = '';
            var healthyCount = 0;
            var totalCount = 0;
            
            var serviceIcons = {
                'session': 'ri-user-line',
                'cache': 'ri-database-2-line',
                'monitor': 'ri-pulse-line'
            };
            
            var serviceNames = {
                'session': '会话服务',
                'cache': '缓存服务',
                'monitor': '监控服务'
            };
            
            for (var key in services) {
                if (services.hasOwnProperty(key)) {
                    var service = services[key];
                    totalCount++;
                    if (service.status === 'UP') healthyCount++;
                    
                    var statusClass = service.status === 'UP' ? 'up' : 'down';
                    var icon = serviceIcons[key] || 'ri-service-line';
                    var name = serviceNames[key] || key;
                    
                    html += '<div class="service-item">';
                    html += '  <div class="service-item__name">';
                    html += '    <div class="service-item__icon" style="background: rgba(59, 130, 246, 0.2); color: var(--nx-primary);">';
                    html += '      <i class="' + icon + '"></i>';
                    html += '    </div>';
                    html += '    <span>' + name + '</span>';
                    html += '  </div>';
                    html += '  <div class="service-item__status">';
                    html += '    <span class="status-badge ' + statusClass + '">' + service.status + '</span>';
                    html += '  </div>';
                    html += '</div>';
                }
            }
            
            document.getElementById('serviceList').innerHTML = html || '<div class="empty-state"><i class="ri-checkbox-circle-line"></i><p>暂无服务</p></div>';
            document.getElementById('serviceHealth').textContent = healthyCount + '/' + totalCount;
        }

        async function loadAlerts() {
            try {
                var response = await fetch('/api/monitor/alerts');
                var rs = await response.json();
                if (rs.success && rs.data) {
                    renderAlerts(rs.data);
                    document.getElementById('alertCount').textContent = rs.data.length || 0;
                }
            } catch (error) {
                console.error('Load alerts failed:', error);
            }
        }

        function renderAlerts(alerts) {
            if (!alerts || alerts.length === 0) {
                document.getElementById('alertList').innerHTML = '<div class="empty-state"><i class="ri-checkbox-circle-line"></i><p>暂无告警</p></div>';
                return;
            }
            
            var html = '';
            var iconMap = {
                'warning': 'ri-alert-line',
                'critical': 'ri-error-warning-line',
                'error': 'ri-error-warning-line',
                'info': 'ri-information-line'
            };
            
            alerts.slice(0, 10).forEach(function(alert) {
                var level = alert.level || 'info';
                var icon = iconMap[level] || 'ri-information-line';
                
                html += '<div class="alert-item ' + level + '">';
                html += '  <div class="alert-item__icon ' + level + '">';
                html += '    <i class="' + icon + '"></i>';
                html += '  </div>';
                html += '  <div class="alert-item__content">';
                html += '    <div class="alert-item__message">' + (alert.message || '-') + '</div>';
                html += '    <div class="alert-item__time">' + formatTime(alert.timestamp) + '</div>';
                html += '  </div>';
                html += '</div>';
            });
            
            document.getElementById('alertList').innerHTML = html;
        }

        async function clearAlerts() {
            try {
                var response = await fetch('/api/monitor/alerts/clear', { method: 'POST' });
                var rs = await response.json();
                if (rs.success) {
                    loadAlerts();
                    document.getElementById('alertCount').textContent = '0';
                }
            } catch (error) {
                console.error('Clear alerts failed:', error);
            }
        }

        async function clearCache() {
            if (!confirm('确定要清理缓存吗？')) return;
            
            try {
                var response = await fetch('/api/cache/clear', { method: 'POST' });
                var rs = await response.json();
                if (rs.success) {
                    alert('缓存已清理');
                    loadCacheStats();
                }
            } catch (error) {
                console.error('Clear cache failed:', error);
            }
        }

        async function runHealthCheck() {
            try {
                var response = await fetch('/api/health/check/detailed');
                var rs = await response.json();
                if (rs.success) {
                    alert('健康检查完成: ' + rs.data.status);
                    loadServiceHealth();
                }
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        function exportReport() {
            window.location.href = '/api/health/report';
        }

        function viewLogs() {
            window.location.href = '/console/pages/nexus/log-management.html';
        }

        function viewSessions() {
            window.location.href = '/console/pages/nexus/system-status.html';
        }

        function viewSettings() {
            window.location.href = '/console/pages/config/app-config.html';
        }

        function formatUptime(ms) {
            var seconds = Math.floor(ms / 1000);
            var days = Math.floor(seconds / 86400);
            var hours = Math.floor((seconds % 86400) / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return days + '天 ' + hours + '小时';
            } else if (hours > 0) {
                return hours + '小时 ' + minutes + '分钟';
            } else {
                return minutes + '分钟';
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            var date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }
    </script>
</body>
</html>
