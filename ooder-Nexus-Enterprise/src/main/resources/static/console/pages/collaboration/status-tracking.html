<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>状态跟踪 - Nexus Console</title>
    
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/nexus.css">
</head>
<body>
    <div class="nx-page">
        <aside class="nx-page__sidebar">
            <div class="nx-p-4 nx-mb-4">
                <h1 class="nx-text-lg nx-font-bold" style="display: flex; align-items: center; gap: 8px;">
                    <i class="ri-server-line"></i> Nexus Console
                </h1>
            </div>
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        
        <main class="nx-page__content">
            <header class="nx-page__header">
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-sidebar-toggle>
                        <i class="ri-menu-line"></i>
                    </button>
                    <h2 class="nx-text-lg nx-font-semibold">状态跟踪</h2>
                </div>
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-theme-toggle>
                        <i class="ri-sun-line"></i>
                    </button>
                    <button class="nx-btn nx-btn--secondary" onclick="loadData()">
                        <i class="ri-refresh-line"></i> 刷新
                    </button>
                </div>
            </header>
            
            <div class="nx-page__main">
                <div class="nx-container">
                    <div class="nx-grid nx-grid-cols-4 nx-mb-6">
                        <div class="nx-stat-card">
                            <div class="nx-stat-card__icon nx-stat-card__icon--primary">
                                <i class="ri-list-check"></i>
                            </div>
                            <div class="nx-stat-card__content">
                                <div class="nx-stat-card__label">总任务</div>
                                <div class="nx-stat-card__value" id="totalTasks">-</div>
                            </div>
                        </div>
                        <div class="nx-stat-card">
                            <div class="nx-stat-card__icon nx-stat-card__icon--warning">
                                <i class="ri-time-line"></i>
                            </div>
                            <div class="nx-stat-card__content">
                                <div class="nx-stat-card__label">待执行</div>
                                <div class="nx-stat-card__value" id="pendingTasks">-</div>
                            </div>
                        </div>
                        <div class="nx-stat-card">
                            <div class="nx-stat-card__icon nx-stat-card__icon--info">
                                <i class="ri-play-line"></i>
                            </div>
                            <div class="nx-stat-card__content">
                                <div class="nx-stat-card__label">执行中</div>
                                <div class="nx-stat-card__value" id="runningTasks">-</div>
                            </div>
                        </div>
                        <div class="nx-stat-card">
                            <div class="nx-stat-card__icon nx-stat-card__icon--success">
                                <i class="ri-checkbox-circle-line"></i>
                            </div>
                            <div class="nx-stat-card__content">
                                <div class="nx-stat-card__label">已完成</div>
                                <div class="nx-stat-card__value" id="completedTasks">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nx-grid nx-grid-cols-3 nx-gap-6">
                        <div class="nx-card" style="grid-column: span 2;">
                            <div class="nx-card__header">
                                <h3 class="nx-card__title"><i class="ri-time-line"></i> 执行时间线</h3>
                            </div>
                            <div class="nx-card__body">
                                <div class="nx-table-container" style="max-height: 400px; overflow-y: auto;">
                                    <table class="nx-table">
                                        <thead>
                                            <tr>
                                                <th>任务ID</th>
                                                <th>名称</th>
                                                <th>状态</th>
                                                <th>分配节点</th>
                                                <th>创建时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="timelineTable">
                                            <tr><td colspan="6" class="nx-text-center">加载中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="nx-card">
                            <div class="nx-card__header">
                                <h3 class="nx-card__title">任务详情</h3>
                            </div>
                            <div class="nx-card__body">
                                <div id="taskDetails">
                                    <p class="nx-text-secondary">选择任务查看详情</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nx-card nx-mt-6">
                        <div class="nx-card__header">
                            <h3 class="nx-card__title">快速导航</h3>
                        </div>
                        <div class="nx-card__body">
                            <div class="nx-flex nx-gap-3">
                                <button class="nx-btn nx-btn--secondary" onclick="window.location.href='/console/pages/collaboration/collab-requests.html'">
                                    <i class="ri-message-2-line"></i> 协作请求
                                </button>
                                <button class="nx-btn nx-btn--secondary" onclick="window.location.href='/console/pages/collaboration/task-distribution.html'">
                                    <i class="ri-task-line"></i> 任务分配
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/console/js/nexus.js"></script>
    <script src="/console/js/nexus-menu.js"></script>
    <script src="/console/js/page-init.js" data-auto-init></script>
    <script src="/console/js/pages/collaboration-api.js"></script>
    <script>
        let allTasks = [];
        let selectedTaskId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            selectedTaskId = urlParams.get('id');
            
            loadData();
        });

        async function loadData() {
            try {
                const rs = await CollaborationAPI.getTasks({});
                allTasks = rs.data || [];
                renderTimeline(allTasks);
                loadStats();
                
                if (selectedTaskId) {
                    const task = allTasks.find(t => t.taskId === selectedTaskId);
                    if (task) {
                        renderTaskDetails(task);
                    }
                }
            } catch (error) {
                document.getElementById('timelineTable').innerHTML = 
                    '<tr><td colspan="6" class="nx-text-center nx-text-danger">加载失败: ' + error.message + '</td></tr>';
            }
        }

        async function loadStats() {
            try {
                const rs = await CollaborationAPI.getStats();
                const stats = rs.data;
                if (stats) {
                    document.getElementById('totalTasks').textContent = stats.totalTasks || 0;
                    document.getElementById('pendingTasks').textContent = stats.pendingTasks || 0;
                    document.getElementById('runningTasks').textContent = stats.runningTasks || 0;
                    document.getElementById('completedTasks').textContent = stats.completedTasks || 0;
                }
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }

        function renderTimeline(tasks) {
            if (!tasks || tasks.length === 0) {
                document.getElementById('timelineTable').innerHTML = 
                    '<tr><td colspan="6" class="nx-text-center">暂无任务记录</td></tr>';
                return;
            }

            const sorted = tasks.sort((a, b) => (b.createdTime || 0) - (a.createdTime || 0));

            let html = '';
            sorted.forEach(task => {
                const status = CollaborationAPI.formatTaskStatus(task.status);
                const time = CollaborationAPI.formatTime(task.createdTime);
                const selectedClass = selectedTaskId === task.taskId ? 'nx-table__row--selected' : '';
                
                html += '<tr class="' + selectedClass + '" onclick="selectTask(\'' + task.taskId + '\')">';
                html += '  <td>' + (task.taskId || '-') + '</td>';
                html += '  <td>' + (task.name || task.taskId) + '</td>';
                html += '  <td><span class="nx-badge nx-badge--' + getStatusBadge(task.status) + '">' + status.text + '</span></td>';
                html += '  <td>' + (task.assignedNode || '-') + '</td>';
                html += '  <td>' + time + '</td>';
                html += '  <td>';
                html += '    <button class="nx-btn nx-btn--sm nx-btn--secondary" onclick="event.stopPropagation(); selectTask(\'' + task.taskId + '\')">详情</button>';
                html += '  </td>';
                html += '</tr>';
            });
            
            document.getElementById('timelineTable').innerHTML = html;
        }

        function getStatusBadge(status) {
            const map = {
                'PENDING': 'warning',
                'RUNNING': 'primary',
                'COMPLETED': 'success',
                'FAILED': 'danger'
            };
            return map[status] || 'secondary';
        }

        function selectTask(taskId) {
            selectedTaskId = taskId;
            const task = allTasks.find(t => t.taskId === taskId);
            if (task) {
                renderTaskDetails(task);
                renderTimeline(allTasks);
            }
        }

        function renderTaskDetails(task) {
            if (!task) return;
            
            const createdTime = CollaborationAPI.formatTime(task.createdTime);
            const dueTime = CollaborationAPI.formatTime(task.dueTime);
            
            const progress = task.status === 'COMPLETED' ? 100 : 
                            task.status === 'RUNNING' ? 50 : 
                            task.status === 'FAILED' ? 0 : 0;
            
            let html = '';
            html += '<div class="nx-mb-2"><strong>任务ID:</strong> ' + (task.taskId || '-') + '</div>';
            html += '<div class="nx-mb-2"><strong>名称:</strong> ' + (task.name || '-') + '</div>';
            html += '<div class="nx-mb-2"><strong>类型:</strong> ' + (task.type || '-') + '</div>';
            html += '<div class="nx-mb-2"><strong>状态:</strong> <span class="nx-badge nx-badge--' + getStatusBadge(task.status) + '">' + (task.status || '-') + '</span></div>';
            html += '<div class="nx-mb-2"><strong>优先级:</strong> ' + (task.priority || '-') + '</div>';
            html += '<div class="nx-mb-2"><strong>分配节点:</strong> ' + (task.assignedNode || '-') + '</div>';
            html += '<div class="nx-mb-2"><strong>创建时间:</strong> ' + createdTime + '</div>';
            html += '<div class="nx-mb-2"><strong>截止时间:</strong> ' + dueTime + '</div>';
            html += '<div class="nx-mb-2"><strong>描述:</strong> ' + (task.description || '-') + '</div>';
            
            html += '<div class="nx-mt-4">';
            html += '  <div class="nx-text-sm nx-text-secondary nx-mb-2">进度: ' + progress + '%</div>';
            html += '  <div class="nx-progress">';
            html += '    <div class="nx-progress__bar" style="width: ' + progress + '%;"></div>';
            html += '  </div>';
            html += '</div>';
            
            document.getElementById('taskDetails').innerHTML = html;
        }
    </script>
</body>
</html>
