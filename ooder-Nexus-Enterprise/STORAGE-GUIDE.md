# 存储管理指南

## 1. 存储系统概述

Nexus 是一个基于 ooderAgent 架构的 P2P AI 能力分发枢纽产品，采用 MIT 开源协议。当前版本是在 ooderAgent 核心 0.6.6 开发的预览版程序，0.6.6 以后会独立建立分支。部分程序未经严格测试，正式发布版本前仅供研究学习。

### SDK 0.6.6 与示例程序说明

SDK 0.6.6 实现了完整的 ooderAgent 协议，为 Nexus 提供了稳定的底层通信能力。Nexus 在 SDK 基础的通讯和能力管理上，针对常见的路由器安装、智能设备安装提供了网络和路由管理示例页面，同时针对家庭网关的特殊设备也提供了相应的开发示例。

开发者可以通过 skillsCenter 下载相应的 skills 插件，安装在自己的路由器或网关上，就可以有针对性地进行开发，使其支持跨生态的 AI 分发服务。

### 1.2 存储架构

Nexus 存储系统采用分层架构设计，提供统一的虚拟文件系统接口，支持多种存储后端。

#### 1.2.1 核心组件
- **虚拟文件系统 (VFS)**：提供统一的文件操作接口
- **存储后端**：支持本地存储、网络存储等多种存储方式
- **版本控制系统**：管理文件版本历史
- **文件哈希系统**：基于 MD5 的文件哈希计算和缓存
- **存储清理系统**：自动清理过期数据和缓存

#### 1.2.2 存储类型
- **本地存储**：基于本地文件系统
- **网络存储**：支持 NAS、SAN 等网络存储
- **对象存储**：支持 S3 兼容的对象存储

## 2. 存储配置

### 2.1 配置文件

存储系统的主要配置位于 `application.yml` 文件中的 `ooder.storage` 部分。

### 2.2 核心配置项

#### 2.2.1 本地存储配置

```yaml
ooder:
  storage:
    type: "local"  # 存储类型
    local:
      root-path: "./data/storage"  # 存储根路径
      cache-path: "./data/cache"  # 缓存路径
      temp-path: "./data/temp"  # 临时文件路径
    version:
      enabled: true  # 是否启用版本控制
      max-versions: 10  # 最大版本数
    hash:
      algorithm: "MD5"  # 哈希算法
    cleanup:
      enabled: true  # 是否启用清理
      interval: 86400  # 清理间隔（秒）
```

### 2.3 目录结构

```
./data/
├── storage/  # 主存储目录
│   ├── files/  # 文件存储
│   └── folders/  # 文件夹元数据
├── cache/  # 缓存目录
│   └── hashes/  # 文件哈希缓存
└── temp/  # 临时文件目录
```

## 3. 存储管理功能

### 3.1 文件管理

#### 3.1.1 文件操作
- **创建文件**：上传新文件到存储系统
- **读取文件**：下载文件或查看文件内容
- **更新文件**：修改现有文件内容
- **删除文件**：从存储系统中删除文件

#### 3.1.2 文件属性
- **文件名**：文件的显示名称
- **文件大小**：文件的字节大小
- **创建时间**：文件的创建时间
- **修改时间**：文件的最后修改时间
- **哈希值**：文件的 MD5 哈希值
- **版本号**：文件的当前版本号

### 3.2 文件夹管理

#### 3.2.1 文件夹操作
- **创建文件夹**：在指定位置创建新文件夹
- **读取文件夹**：查看文件夹内容
- **更新文件夹**：修改文件夹名称或属性
- **删除文件夹**：删除文件夹及其内容

#### 3.2.2 文件夹结构
- **层级结构**：支持多级文件夹嵌套
- **路径表示**：使用 `/` 分隔的路径表示
- **根目录**：系统默认的根文件夹

### 3.3 版本控制

#### 3.3.1 版本管理功能
- **自动版本**：文件修改时自动创建新版本
- **版本历史**：查看文件的所有历史版本
- **版本恢复**：恢复到之前的任意版本
- **版本限制**：可配置最大版本数

#### 3.3.2 版本存储策略
- **增量存储**：只存储文件变更部分
- **版本压缩**：对旧版本进行压缩存储
- **版本清理**：超过最大版本数时自动清理最旧版本

### 3.4 文件哈希

#### 3.4.1 哈希功能
- **MD5 计算**：为每个文件计算 MD5 哈希值
- **哈希缓存**：缓存文件哈希值，提高性能
- **文件去重**：基于哈希值的文件去重
- **完整性校验**：通过哈希值验证文件完整性

#### 3.4.2 哈希计算策略
- **按需计算**：首次访问时计算哈希值
- **后台计算**：大文件在后台异步计算哈希
- **缓存管理**：定期清理过期的哈希缓存

### 3.5 存储清理

#### 3.5.1 清理功能
- **缓存清理**：清理过期的缓存数据
- **临时文件清理**：清理临时文件
- **版本清理**：清理超过限制的文件版本
- **空间回收**：回收未使用的存储空间

#### 3.5.2 清理策略
- **定时清理**：按配置的时间间隔自动执行清理
- **阈值触发**：当存储空间达到阈值时触发清理
- **手动触发**：通过 API 手动触发清理操作

## 4. 存储最佳实践

### 4.1 存储规划

#### 4.1.1 空间规划
- **估算存储需求**：根据预期的文件数量和大小估算存储需求
- **预留空间**：建议预留至少 30% 的空闲空间
- **监控空间使用**：定期监控存储空间使用情况

#### 4.1.2 目录结构设计
- **合理分类**：根据文件类型和用途设计目录结构
- **命名规范**：使用一致的命名规范
- **层级控制**：避免过深的目录层级（建议不超过 5 层）

### 4.2 性能优化

#### 4.2.1 存储性能优化
- **SSD 存储**：对于频繁访问的文件，推荐使用 SSD 存储
- **缓存配置**：合理配置缓存大小和策略
- **并发控制**：避免过多并发文件操作
- **批量操作**：对于多个文件操作，使用批量 API 减少网络开销

#### 4.2.2 文件操作优化
- **文件大小**：单个文件建议不超过 1GB
- **文件数量**：单个文件夹下文件数量建议不超过 1000 个
- **上传策略**：大文件建议使用分片上传
- **下载策略**：大文件建议使用断点续传

### 4.3 数据安全

#### 4.3.1 数据备份
- **定期备份**：制定定期备份计划
- **多副本**：重要数据建议保存多个副本
- **异地备份**：将备份存储在不同物理位置
- **备份验证**：定期验证备份的完整性和可恢复性

#### 4.3.2 访问控制
- **权限管理**：合理设置文件和文件夹权限
- **访问审计**：记录文件访问日志
- **加密存储**：对敏感数据进行加密存储

### 4.4 存储扩展

#### 4.4.1 存储扩容
- **本地存储扩容**：增加本地磁盘空间
- **网络存储扩展**：配置网络存储作为补充
- **存储迁移**：在存储介质之间迁移数据

#### 4.4.2 存储监控
- **空间监控**：监控存储空间使用情况
- **性能监控**：监控存储操作性能
- **错误监控**：监控存储系统错误和异常

## 5. API 使用指南

### 5.1 存储空间 API

#### 5.1.1 获取存储空间信息
```bash
GET /api/storage/space
```

**响应示例**：
```json
{
  "total": 10737418240,  // 总空间（字节）
  "used": 2147483648,   // 已用空间（字节）
  "free": 8589934592,   // 可用空间（字节）
  "usage": 20           // 使用率（百分比）
}
```

### 5.2 文件夹管理 API

#### 5.2.1 获取文件夹内容
```bash
GET /api/storage/folder/{folderId}/children
```

#### 5.2.2 创建文件夹
```bash
POST /api/storage/folder
Content-Type: application/json

{
  "name": "新文件夹",
  "parentId": "root"
}
```

#### 5.2.3 删除文件夹
```bash
DELETE /api/storage/folder/{folderId}
```

### 5.3 文件管理 API

#### 5.3.1 上传文件
```bash
POST /api/storage/upload
Content-Type: multipart/form-data

# 表单数据
- file: <文件内容>
- folderId: <目标文件夹 ID>
```

#### 5.3.2 下载文件
```bash
GET /api/storage/download/{fileId}
```

#### 5.3.3 删除文件
```bash
DELETE /api/storage/file/{fileId}
```

#### 5.3.4 更新文件信息
```bash
PUT /api/storage/file/{fileId}
Content-Type: application/json

{
  "name": "新文件名"
}
```

### 5.4 版本管理 API

#### 5.4.1 获取文件版本列表
```bash
GET /api/storage/file/{fileId}/versions
```

#### 5.4.2 恢复文件版本
```bash
POST /api/storage/file/{fileId}/restore/{versionId}
```

### 5.5 存储清理 API

#### 5.5.1 清理存储缓存
```bash
POST /api/storage/cleanup
```

### 5.6 文件分享 API

#### 5.6.1 获取分享的文件列表
```bash
GET /api/storage/shared
```

#### 5.6.2 分享文件
```bash
POST /api/storage/share
Content-Type: application/json

{
  "fileId": "<文件 ID>",
  "targets": ["<用户 ID 或群组 ID>"]
}
```

#### 5.6.3 获取收到的文件列表
```bash
GET /api/storage/received
```

## 6. 常见问题与解决方案

### 6.1 存储问题

#### 6.1.1 存储空间不足
- **症状**：上传文件失败，系统提示存储空间不足
- **原因**：磁盘空间已满或接近满
- **解决方案**：
  1. 清理不必要的文件
  2. 扩展存储空间
  3. 调整存储清理策略

#### 6.1.2 文件上传失败
- **症状**：文件上传过程中失败或超时
- **原因**：网络中断、文件过大、权限不足
- **解决方案**：
  1. 检查网络连接
  2. 对于大文件，使用分片上传
  3. 检查上传权限

#### 6.1.3 文件下载失败
- **症状**：文件下载过程中失败或损坏
- **原因**：网络中断、文件损坏、权限不足
- **解决方案**：
  1. 检查网络连接
  2. 验证文件完整性
  3. 检查下载权限

#### 6.1.4 版本恢复失败
- **症状**：无法恢复到之前的文件版本
- **原因**：版本数据损坏、权限不足
- **解决方案**：
  1. 检查版本数据完整性
  2. 检查恢复权限
  3. 从备份中恢复

### 6.2 性能问题

#### 6.2.1 文件操作缓慢
- **症状**：文件上传、下载或操作速度缓慢
- **原因**：存储介质性能不足、网络延迟高、系统负载高
- **解决方案**：
  1. 使用性能更好的存储介质
  2. 优化网络连接
  3. 减少系统负载

#### 6.2.2 哈希计算耗时
- **症状**：大文件哈希计算时间过长
- **原因**：文件过大、系统资源不足
- **解决方案**：
  1. 后台异步计算哈希
  2. 增加系统资源
  3. 优化哈希计算算法

## 7. 存储监控与维护

### 7.1 监控指标

#### 7.1.1 存储指标
- **空间使用率**：存储空间使用百分比
- **IOPS**：每秒输入/输出操作数
- **吞吐量**：存储读写速度
- **响应时间**：存储操作响应时间

#### 7.1.2 系统指标
- **缓存命中率**：缓存命中百分比
- **哈希计算时间**：哈希计算平均时间
- **清理频率**：存储清理执行频率
- **错误率**：存储操作错误率

### 7.2 维护任务

#### 7.2.1 日常维护
- **空间检查**：定期检查存储空间使用情况
- **日志审查**：审查存储系统日志
- **备份验证**：验证数据备份完整性
- **性能测试**：定期测试存储性能

#### 7.2.2 定期维护
- **碎片整理**：对存储介质进行碎片整理
- **数据校验**：校验存储数据完整性
- **缓存清理**：手动清理过期缓存
- **版本管理**：清理不必要的旧版本

### 7.3 故障处理

#### 7.3.1 存储故障
- **磁盘故障**：更换故障磁盘并从备份恢复数据
- **文件系统损坏**：修复文件系统或从备份恢复
- **数据损坏**：从备份恢复损坏数据

#### 7.3.2 恢复流程
1. **故障识别**：识别存储故障类型和范围
2. **故障隔离**：隔离故障存储，避免影响其他系统
3. **数据恢复**：从备份恢复数据
4. **验证恢复**：验证恢复的数据完整性
5. **系统重启**：重启存储服务并验证功能

## 8. 存储系统集成

### 8.1 与其他系统集成

#### 8.1.1 与 ooder-skillsCenter 集成
Nexus 存储系统推荐与 ooder-skillsCenter 配合使用，实现技能的存储和管理。

#### 8.1.2 与外部存储系统集成
- **NAS 集成**：将 NAS 作为存储后端
- **对象存储集成**：集成 S3 兼容的对象存储
- **云存储集成**：集成主流云存储服务

### 8.2 集成配置

#### 8.2.1 NAS 集成配置
```yaml
ooder:
  storage:
    type: "network"
    network:
      protocol: "nfs"
      host: "192.168.1.100"
      path: "/nas/nexus-storage"
      username: "user"
      password: "password"
```

#### 8.2.2 对象存储集成配置
```yaml
ooder:
  storage:
    type: "object"
    object:
      endpoint: "https://s3.example.com"
      bucket: "nexus-storage"
      accessKey: "your-access-key"
      secretKey: "your-secret-key"
```

## 9. 总结

Nexus 存储系统提供了灵活、可靠的存储解决方案，支持多种存储后端和高级功能。通过遵循本指南中的最佳实践，您可以充分利用 Nexus 存储系统的能力，确保数据的安全存储和高效管理。

相关应用推荐配合 ooder-skillsCenter 使用，以获得更好的整体体验。

**注意**：本指南适用于 Nexus 预览版程序，部分功能可能在正式版本中有所变更。

---

**最后更新时间**：2026-02-02
**版本**：v1.0.0
**发布平台**：gitee 独家发布