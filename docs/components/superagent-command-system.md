# SuperAgent命令体系设计

## 1. 命令系统概述

### 1.1 命令系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          命令系统 (Command System)               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  │  命令工厂   │  │  命令分发器 │  │  命令执行器 │  │  结果处理器 │
│  │ Command     │  │ Command     │  │ Command     │  │ Result      │
│  │ Factory     │  │ Dispatcher  │  │ Executor    │  │ Processor   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 命令系统组件

| 组件 | 功能描述 |
|------|----------|
| 命令工厂 | 根据命令类型创建具体的命令实例 |
| 命令分发器 | 根据命令路由规则将命令分发到目标Agent |
| 命令执行器 | 在目标Agent上执行命令并返回结果 |
| 结果处理器 | 处理命令执行结果，返回给请求方 |

## 2. 命令下发及处理流程

### 2.1 命令下发协议

| 协议 | 适用场景 | 特点 |
|------|----------|------|
| HTTP/HTTPS | 同步命令下发、命令结果查询 | 可靠、广泛支持 |
| WebSocket | 实时命令下发、双向通信 | 低延迟、全双工 |
| MQTT | 异步命令下发、设备数据上报 | 轻量级、支持QoS |
| gRPC | 高性能命令下发、流式通信 | 高效、支持双向流 |

### 2.2 命令处理流程

```
1. 命令发起方 → 命令创建 → 命令工厂
   - 根据命令类型创建具体命令实例
   - 设置命令参数和目标Agent
   
2. 命令工厂 → 命令发送 → 命令分发器
   - 调用命令分发器发送命令
   - 携带命令元数据和认证信息
   
3. 命令分发器 → 命令路由 → 目标Agent
   - 根据命令目标地址路由命令
   - 支持负载均衡和故障转移
   - 记录命令发送日志
   
4. 目标Agent → 命令接收 → 命令执行器
   - 接收命令并验证合法性
   - 检查命令权限和有效期
   - 记录命令接收日志
   
5. 命令执行器 → 命令执行 → 命令目标
   - 在目标上执行命令
   - 处理命令执行异常
   - 记录命令执行日志
   
6. 命令执行器 → 结果返回 → 结果处理器
   - 返回命令执行结果
   - 包含执行状态和数据
   - 记录结果返回日志
   
7. 结果处理器 → 结果返回 → 命令发起方
   - 处理命令执行结果
   - 转换结果格式
   - 发送结果通知
```

### 2.3 命令生命周期

| 状态 | 描述 |
|------|------|
| CREATED | 命令已创建 |
| SENT | 命令已发送 |
| RECEIVED | 命令已被接收 |
| EXECUTING | 命令正在执行 |
| EXECUTED | 命令执行完成 |
| SUCCESS | 命令执行成功 |
| FAILED | 命令执行失败 |
| TIMEOUT | 命令执行超时 |
| CANCELLED | 命令已取消 |

## 3. 现有命令按Agent整理

### 3.1 MCP Agent命令

| 命令类型 | 功能描述 | 适用场景 |
|----------|----------|----------|
| DebugCommand | 调试命令，用于设置调试参数 | 开发调试 |

### 3.2 Route Agent命令

| 命令类型 | 功能描述 | 适用场景 |
|----------|----------|----------|
| ChannelNegotiateCommand | 通道协商命令，用于协商通信通道 | 网络配置 |
| ChannelNegotiateReportCommand | 通道协商报告命令，用于报告协商结果 | 网络状态报告 |

### 3.3 End Agent命令

#### 3.3.1 通用Agent命令

| 命令类型 | 功能描述 | 适用场景 |
|----------|----------|----------|
| AttributeWriteCommand | 属性写入命令，用于设置属性 | 系统控制 |

### 3.4 系统管理命令

| 命令类型 | 功能描述 | 适用场景 |
|----------|----------|----------|

## 4. 系统性命令设计

### 4.1 同步VFS数据命令

**命令名称**：VfsSyncCommand

**功能描述**：同步VFS中的数据到指定Agent

**命令参数**：

| 参数名称 | 类型 | 必填 | 描述 |
|----------|------|------|------|
| sourcePath | String | 是 | 源文件路径 |
| targetPath | String | 是 | 目标文件路径 |
| agentId | String | 是 | 目标Agent ID |
| syncType | SyncType | 是 | 同步类型（FULL, INCREMENTAL） |
| overwrite | Boolean | 否 | 是否覆盖已有文件 |

**返回结果**：

| 字段名称 | 类型 | 描述 |
|----------|------|------|
| result | String | 同步结果 |
| syncSize | Long | 同步文件大小 |
| syncTime | Long | 同步耗时（毫秒） |
| fileCount | Integer | 同步文件数量 |

**适用场景**：
- 配置文件同步
- 固件文件同步
- 数据文件同步

### 4.2 上传处理后文档命令

**命令名称**：DocumentUploadCommand

**功能描述**：上传处理后的文档到指定存储位置

**命令参数**：

| 参数名称 | 类型 | 必填 | 描述 |
|----------|------|------|------|
| documentId | String | 是 | 文档唯一标识 |
| documentPath | String | 是 | 文档本地路径 |
| targetStorage | String | 是 | 目标存储位置 |
| metadata | Map<String, Object> | 否 | 文档元数据 |
| accessControl | AccessControlPolicy | 否 | 访问控制策略 |

**返回结果**：

| 字段名称 | 类型 | 描述 |
|----------|------|------|
| result | String | 上传结果 |
| documentUrl | String | 文档访问URL |
| storageLocation | String | 实际存储位置 |
| fileSize | Long | 文档大小 |

**适用场景**：
- 文档处理结果上传
- 报告生成后上传
- 数据导出结果上传

### 4.3 调用指定接口命令

**命令名称**：InterfaceCallCommand

**功能描述**：调用指定Agent或外部系统的接口

**命令参数**：

| 参数名称 | 类型 | 必填 | 描述 |
|----------|------|------|------|
| targetType | TargetType | 是 | 目标类型（AGENT, EXTERNAL） |
| targetId | String | 是 | 目标ID |
| interfaceName | String | 是 | 接口名称 |
| method | String | 是 | 请求方法（GET, POST, PUT, DELETE等） |
| params | Map<String, Object> | 否 | 接口参数 |
| headers | Map<String, String> | 否 | 请求头 |
| timeout | Integer | 否 | 超时时间（毫秒） |

**返回结果**：

| 字段名称 | 类型 | 描述 |
|----------|------|------|
| result | String | 调用结果 |
| statusCode | Integer | HTTP状态码 |
| responseData | Object | 响应数据 |
| responseHeaders | Map<String, String> | 响应头 |
| executionTime | Long | 执行耗时（毫秒） |

**适用场景**：
- Agent间接口调用
- 外部系统接口调用
- 跨服务功能调用

### 4.4 强制离线命令

**命令名称**：ForceOfflineCommand

**功能描述**：强制指定Agent或设备离线

**命令参数**：

| 参数名称 | 类型 | 必填 | 描述 |
|----------|------|------|------|
| targetType | TargetType | 是 | 目标类型（AGENT, DEVICE） |
| targetId | String | 是 | 目标ID |
| reason | String | 否 | 强制离线原因 |
| clearData | Boolean | 否 | 是否清除本地数据 |
| notifyUser | Boolean | 否 | 是否通知用户 |

**返回结果**：

| 字段名称 | 类型 | 描述 |
|----------|------|------|
| result | String | 执行结果 |
| targetStatus | String | 目标当前状态 |
| offlineTime | Long | 离线时间 |

**适用场景**：
- 设备异常时强制离线
- 安全风险设备处理
- 设备维护时强制离线

## 5. 场景命令支持

### 5.1 场景命令定义

**命令名称**：SceneExecuteCommand

**功能描述**：执行指定场景

**命令参数**：

| 参数名称 | 类型 | 必填 | 描述 |
|----------|------|------|------|
| sceneId | String | 是 | 场景ID |
| parameters | Map<String, Object> | 否 | 场景参数 |
| executionMode | ExecutionMode | 否 | 执行模式（SYNC, ASYNC） |
| priority | Integer | 否 | 执行优先级 |

**返回结果**：

| 字段名称 | 类型 | 描述 |
|----------|------|------|
| result | String | 执行结果 |
| sceneStatus | String | 场景当前状态 |
| executedActions | Integer | 执行的动作数量 |
| executionTime | Long | 执行耗时（毫秒） |

### 5.2 场景命令处理流程

```
1. 命令发起方 → 发送SceneExecuteCommand → 命令分发器
2. 命令分发器 → 路由命令 → 目标MCP Agent
3. MCP Agent → 解析场景 → 场景管理服务
4. 场景管理服务 → 加载场景定义 → 场景定义存储
5. MCP Agent → 执行场景动作 → 相关Agent
   a. 发送命令到各个目标Agent
   b. 等待命令执行结果
   c. 处理命令执行异常
6. MCP Agent → 结果汇总 → 结果处理器
7. 结果处理器 → 返回结果 → 命令发起方
```

### 5.3 典型场景命令示例

#### 5.3.1 通用自动化场景

**场景名称**：环境激活模式
**触发条件**：系统事件触发
**执行动作**：
1. 激活环境设备
2. 调节环境参数
3. 启动辅助系统

**命令示例**：
```json
{
  "commandId": "cmd-scene-001",
  "commandType": "SceneExecuteCommand",
  "sceneId": "scene-activation",
  "parameters": {
    "environmentParam": 26,
    "volume": 50
  },
  "executionMode": "SYNC",
  "priority": 100
}
```

#### 5.3.2 系统工作模式场景

**场景名称**：工作模式
**触发条件**：系统事件触发
**执行动作**：
1. 激活工作设备
2. 调整环境参数
3. 启动协作系统

**命令示例**：
```json
{
  "commandId": "cmd-scene-002",
  "commandType": "SceneExecuteCommand",
  "sceneId": "scene-working",
  "parameters": {
    "environmentParam": 24,
    "source": "device"
  },
  "executionMode": "ASYNC",
  "priority": 200
}
```

## 6. 命令安全设计

### 6.1 命令认证与授权

```
1. 命令发起方 → 身份认证 → 认证中心
   - 提供身份凭证
   - 验证身份合法性
   
2. 认证中心 → 授权检查 → 权限管理服务
   - 检查命令权限
   - 验证操作权限范围
   
3. 权限管理服务 → 生成授权令牌 → 命令发起方
   - 生成命令授权令牌
   - 设置令牌有效期
   
4. 命令发起方 → 命令发送 → 命令分发器
   - 携带授权令牌
   - 发送命令请求
   
5. 命令分发器 → 令牌验证 → 认证中心
   - 验证令牌有效性
   - 检查令牌权限
   
6. 认证中心 → 验证结果 → 命令分发器
   - 返回验证结果
   - 允许或拒绝命令
```

### 6.2 命令加密

- **传输加密**：使用TLS/SSL加密命令传输
- **数据加密**：敏感命令数据加密存储
- **签名验证**：命令数据签名，防止篡改

### 6.3 命令审计

- 记录命令发送日志
- 记录命令执行日志
- 记录命令结果日志
- 支持命令日志查询和分析
- 支持命令审计报告生成

## 7. 命令系统扩展机制

### 7.1 命令扩展方式

1. **命令插件化**：支持通过插件方式扩展命令类型
2. **命令工厂扩展**：允许自定义命令工厂创建新命令
3. **命令执行器扩展**：支持自定义命令执行逻辑
4. **结果处理器扩展**：支持自定义结果处理逻辑

### 7.2 命令扩展流程

```
1. 定义新命令类 → 继承BaseCommand
2. 实现命令执行逻辑 → 实现CommandExecutor接口
3. 注册命令到命令工厂 → 配置命令映射
4. 实现命令序列化/反序列化 → 实现CommandSerializer接口
5. 测试命令功能 → 编写单元测试和集成测试
6. 部署命令扩展 → 部署到命令系统
```

## 8. 命令系统监控与管理

### 8.1 命令监控指标

| 指标名称 | 描述 |
|----------|------|
| 命令发送速率 | 每秒发送的命令数量 |
| 命令执行成功率 | 命令执行成功的比例 |
| 命令平均执行时间 | 命令执行的平均耗时 |
| 命令失败率 | 命令执行失败的比例 |
| 命令超时率 | 命令执行超时的比例 |
| 命令队列长度 | 等待执行的命令数量 |

### 8.2 命令管理功能

- 命令查看：查看命令历史和状态
- 命令取消：取消正在执行的命令
- 命令重试：重试失败的命令
- 命令统计：统计命令执行情况
- 命令告警：设置命令相关告警规则

## 9. 总结

SuperAgent命令系统采用模块化、可扩展的设计，支持多种命令类型和通信协议，能够满足各种复杂场景的命令下发和处理需求。通过系统地梳理命令体系和场景命令支持，我们为SuperAgent系统提供了完整的命令解决方案，包括：

1. 清晰的命令下发及处理流程
2. 按Agent分类整理的现有命令
3. 新增的系统性命令设计
4. 场景命令支持机制
5. 完善的命令安全设计
6. 灵活的命令扩展机制
7. 全面的命令监控与管理

这些设计确保了SuperAgent系统能够高效、可靠地处理各种命令，支持复杂的业务场景和应用需求。