# Agent内部通讯和组网概述

## 1. 设计目标

- 实现SuperAgent系统内部各组件之间的安全、可靠、高效通讯
- 支持MCP Mesh组网，提高系统可用性和扩展性
- 定义清晰的组件间通讯协议和流程
- 确保通讯安全性，包括认证、加密和授权
- 支持Agent的动态发现和加入

## 2. 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                     MCP Mesh Network                          │
└─────────────────────────────────────────────────────────────────┘
                │                            │
                ▼                            ▼
┌──────────────────────┐              ┌──────────────────────┐
│  RouteAgent Cluster  │              │  RouteAgent Cluster  │
└──────────────────────┘              └──────────────────────┘
                │                            │
                ▼                            ▼
┌──────────────────────┐              ┌──────────────────────┐
│  EndAgent Pool       │              │  EndAgent Pool       │
└──────────────────────┘              └──────────────────────┘
                │                            │
                ▼                            ▼
┌──────────────────────┐              ┌──────────────────────┐
│  SKILL               │              │  SKILL               │
└──────────────────────┘              └──────────────────────┘
```

## 3. 组件关系

| 组件 | 描述 | 主要职责 |
|------|------|----------|
| MCP | Master Control Point | 系统核心，负责管理和协调其他组件，Mesh组网 |
| RouteAgent | 路由器代理 | 负责消息路由，EndAgent管理，密钥分发 |
| EndAgent | 终端代理 | 执行具体任务，与SKILL交互，与RouteAgent通信 |
| SKILL | 物理程序 | 实现具体业务逻辑，通过EndAgent与外部交互 |

## 4. 核心设计原则

1. **安全优先**：所有通讯均需加密和认证
2. **MCP集中管理**：MCP负责密钥分发和组网管理
3. **分层通讯**：严格的组件间通讯层级，避免跨层直接通信
4. **动态组网**：支持组件的动态发现和加入
5. **故障容错**：网络故障自动恢复，确保系统可用性
6. **Capability静态定义**：由SKILL开发者完成静态定义，开发完成后不可修改，支持1:n关系
7. **特殊AGENT支持**：内置SKILL和AGENT一体的特殊AGENT，如A2UIAGENT由LLM直接管理

## 5. 分册内容索引

1. **Agent内部通讯和组网概述** - 本文档
2. **SKILL与EndAgent通讯设计** - SKILL与EndAgent的交互机制
3. **EndAgent与RouteAgent通讯设计** - EndAgent与RouteAgent的认证和通讯
4. **RouteAgent与MCP通讯设计** - RouteAgent与MCP的交互和跨网络通讯
5. **MCP Mesh组网设计** - MCP节点的Mesh组网实现
6. **安全KEY交换机制** - 组件间的密钥交换和管理
7. **EndAgent向MCPAgent注册流程设计** - EndAgent向MCPAgent的注册过程（参考Zigbee组网）
8. **MCPAgent向AI Server通讯流程设计** - MCPAgent向AI Server的通讯过程（参考Zigbee组网）
9. **能力定义（CAT）** - 组件能力的定义和使用
10. **通讯协议定义** - 组件间的通讯协议规范
11. **组网过程** - 完整的组网流程和状态管理

## 6. 设计歧义与已确认点

### 6.1 已确认设计决策

| 设计点 | 确认结果 |
|--------|----------|
| **RouteAgent密钥交换** | RouteAgent与MCP连接后，MCP下发统一临时密钥，只有密钥相同的Agent才能使用KEK加密通讯 |
| **Agent发现机制** | MCP默认开放固定端口接受Agent扫描请求加入，请求时需提供SKILL的MD5和AI中心注册信息；独立部署环境中，RouteAgent在MCP开放加网服务后同步开放，EndAgent可通过扫描RouteAgent完成加网 |
| **CAT定义** | 由SKILL开发者完成定义，开发完成后CAT不可修改 |
| **网络故障恢复** | 由RouteAgent核心完成，EndAgent只需与RouteAgent保持通讯即可标识为正常 |

## 7. 参考文档

- SuperAgent架构设计文档
- SuperAgent安全设计文档
- Zigbee通讯协议
- MQTT协议规范
- TLS/SSL加密标准
- Diffie-Hellman密钥交换算法