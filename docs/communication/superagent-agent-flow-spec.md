# SuperAgent Agent（组网）流程规范

## 1. Agent概述

SuperAgent系统中的Agent分为三种类型：
- **MCP Agent**：服务流入口
- **Route Agent**：桥接转发
- **End Agent**：功能执行

## 2. Agent注册流程

### 2.1 Agent注册中心功能

- 处理Agent的注册请求
- 管理Agent的基本信息
- 处理Agent的注销请求
- 提供Agent发现服务
- 监控Agent的心跳
- 检测Agent的健康状态
- 处理Agent的上下线

### 2.2 Agent注册流程

```
1. Agent → 注册请求 → Agent注册中心
   - 请求包含：Agent基本信息、通信信息、功能信息等
   - 采用TLS加密通信
   - 携带JWT令牌进行身份验证
   
2. Agent注册中心 → 验证请求
   - 验证JWT令牌有效性
   - 验证Agent ID唯一性
   - 验证通信端点可达性
   - 验证功能信息完整性
   
3. Agent注册中心 → 存储信息
   - 将Agent信息存储到数据库
   - 更新内存中的注册表
   - 建立按类型、功能、状态等索引
   
4. Agent注册中心 → 启动心跳监控
   - 设置心跳超时时间（默认30秒）
   - 启动心跳检测线程
   
5. Agent注册中心 → 发送注册事件
   - 通知相关组件Agent已注册
   - 更新订阅者列表
   
6. Agent注册中心 → 返回注册结果
   - 返回注册成功或失败
   - 返回Agent ID和其他必要信息
   - 返回心跳配置信息
```

## 3. Agent发现流程

### 3.1 Agent发现机制

- 基于Agent注册中心的集中式发现
- 基于广播的分布式发现
- 基于DNS的服务发现

### 3.2 Agent发现流程

```
1. Agent → 发现请求 → Agent注册中心
   - 请求包含：分类、功能、状态等查询条件
   - 采用HTTP/HTTPS协议
   - 携带身份验证信息
   
2. Agent注册中心 → 查询处理
   - 根据条件查询Agent注册表
   - 应用过滤条件
   - 排序结果（基于负载、响应时间等）
   
3. Agent注册中心 → 返回结果
   - 返回符合条件的Agent列表
   - 包含Agent基本信息和通信信息
   - 包含Agent状态和健康信息
   - 包含Agent负载信息
   
4. Agent → 建立连接
   - 根据返回的Agent信息
   - 与目标Agent建立通信连接
   - 验证通信协议兼容性
   - 交换加密密钥
   
5. Agent → 监控连接状态
   - 定期发送心跳包
   - 检测连接异常
   - 处理连接断开情况
```

## 4. Agent通信流程

### 4.1 通信协议

- **HTTP/HTTPS**：用于请求-响应式通信
- **WebSocket**：用于双向实时通信
- **MQTT**：用于消息发布-订阅
- **gRPC**：用于高性能服务调用

### 4.2 通信安全

- **TLS/SSL加密**：所有通信通道均加密
- **JWT认证**：Agent间通信携带JWT令牌
- **数字签名**：请求和响应均需数字签名
- **会话密钥**：基于公钥交换生成会话密钥

### 4.3 MCP Agent与Route Agent通信

```
1. MCP Agent → 请求 → Route Agent
   - 请求包含：action, parameters, context等
   - 采用HTTP/HTTPS或gRPC协议
   - 携带JWT令牌
   - 数据加密传输
   
2. Route Agent → 请求验证
   - 验证JWT令牌有效性
   - 验证请求签名
   - 验证请求参数完整性
   
3. Route Agent → 请求处理
   - 解析请求内容
   - 提取路由关键字
   - 确定所需功能类型
   - 匹配路由规则
   
4. Route Agent → 请求转发
   - 将请求转发给选中的End Agent
   - 记录转发日志
   - 设置超时时间
   
5. End Agent → 响应 → Route Agent
   - 执行请求的功能
   - 生成响应结果
   - 加密响应数据
   - 签名响应
   
6. Route Agent → 响应处理
   - 验证响应签名
   - 解密响应数据
   - 处理响应结果
   
7. Route Agent → 响应返回
   - 将响应返回给MCP Agent
   - 记录响应日志
   - 更新统计信息
```

### 4.4 Route Agent与End Agent通信

```
1. Route Agent → 请求 → End Agent
   - 请求包含：action, parameters, context等
   - 采用WebSocket或gRPC协议
   - 携带JWT令牌
   - 数据加密传输
   
2. End Agent → 请求验证
   - 验证JWT令牌有效性
   - 验证请求签名
   - 验证请求权限
   
3. End Agent → 任务解析
   - 解析任务内容
   - 确定所需Skill和接口
   - 准备执行环境
   
4. End Agent → Skill调用
   - 查找可用的Skill
   - 调用Skill的相应接口
   - 传递执行参数
   - 等待Skill返回结果
   
5. End Agent → 结果处理
   - 处理Skill的执行结果
   - 格式化响应数据
   - 加密响应数据
   - 签名响应
   
6. End Agent → 响应返回
   - 将响应返回给Route Agent
   - 记录执行日志
   - 产生相应的事件
```

## 5. Agent心跳机制

### 5.1 心跳流程

```
1. Agent → 心跳请求 → Agent注册中心
   - 定期发送心跳包（默认30秒）
   - 包含Agent ID、状态、负载信息等
   - 采用轻量级协议（如MQTT）
   
2. Agent注册中心 → 处理心跳
   - 更新Agent的最后心跳时间
   - 更新Agent的状态和负载信息
   - 检查Agent是否正常
   
3. Agent注册中心 → 心跳超时处理
   - 如果超过3次心跳超时（默认90秒），标记Agent为离线
   - 更新Agent状态为ERROR
   - 发送Agent离线事件
   - 通知相关组件
   
4. Agent → 恢复连接
   - 如果Agent恢复正常，重新发送注册请求
   - Agent注册中心更新Agent状态为RUNNING
   - 发送Agent上线事件
```

## 6. Agent故障处理流程

### 6.1 故障检测

- 基于心跳机制的故障检测
- 基于请求超时的故障检测
- 基于健康检查的故障检测

### 6.2 故障处理策略

- **重试机制**：失败后自动重试，支持指数退避算法
- **故障转移**：将请求转发到备用Agent
- **负载均衡调整**：自动调整负载均衡策略
- **服务降级**：在资源不足时降级服务

### 6.3 故障处理流程

```
1. 检测到Agent故障
   - 心跳超时
   - 请求超时
   - 健康检查失败
   
2. Agent注册中心 → 更新状态
   - 将Agent状态标记为ERROR
   - 发送Agent故障事件
   - 更新负载均衡配置
   
3. 调用方 → 故障处理
   - 根据故障类型选择处理策略
   - 重试、故障转移或服务降级
   - 记录故障日志
   
4. 故障恢复
   - Agent恢复正常，重新注册
   - Agent注册中心更新状态为RUNNING
   - 发送Agent恢复事件
   - 恢复负载均衡配置
   
5. 故障分析
   - 生成故障报告
   - 分析故障原因
   - 提出改进建议
```

## 7. Skill激活与发现流程

### 7.1 Skill激活流程

```
1. Skill → 激活请求 → Skill管理中心
   - 请求包含：Skill基本信息、VFS文件地址、AIServer认证证书等
   - 前置条件：必须已通过AIServer认证
   - 当前状态：AISERVER_AUTHENTICATED → BROADCASTING
   
2. Skill管理中心 → 验证请求
   - 验证AIServer认证证书有效性
   - 验证VFS文件完整性
   - 验证功能分类合法性
   - 验证技术栈兼容性
   
3. Skill管理中心 → 激活Skill
   - 设置Skill状态为BROADCASTING
   - 生成临时通信令牌
   - 返回激活结果
   
4. Skill → 开始广播
   - 在本地网络内广播自己的存在
   - 广播内容包括：Skill基本信息、通信端点、确认的Cat功能列表等
   - 广播频率可配置（默认5秒）
```

### 7.2 Skill发现流程（MCP Agent侧）

```
1. MCP Agent → 启动扫描
   - 在本网络内扫描广播中的Skill
   - 监听指定的广播频道（默认UDP端口5353）
   - 过滤不匹配的Skill（根据安全级别、功能需求等）
   
2. MCP Agent → 发现Skill
   - 接收Skill广播信息
   - 解析Skill基本信息和通信端点
   - 验证Skill合法性
   - 验证AIServer认证证书有效性（强制要求）
   
3. MCP Agent → 上报发现结果
   - 将发现的Skill信息上报给SuperAgent核心引擎
   - 包含：Skill基本信息、发现时间、通信信息、AIServer认证状态等
   - 当前状态：BROADCASTING → DISCOVERED
   
4. SuperAgent核心引擎 → 通知用户
   - 通过Web控制台或APP通知用户
   - 展示发现的Skill详细信息和AIServer认证状态
   - 等待用户确认
```

## 8. Skill入网流程

### 8.1 Skill入网流程

```
1. 用户 → 同意加入 → SuperAgent核心引擎
   - 通过Web控制台或APP确认
   - 可配置授权权限
   - 设置Skill名称和描述
   - 系统自动验证Skill的AIServer认证状态（强制要求）
   
2. SuperAgent核心引擎 → 分配资源
   - 分配VFS存储空间
   - 生成授权访问信息
   - 创建Skill实例记录
   - 分配唯一的Skill实例ID
   
3. SuperAgent核心引擎 → 通知MCP Agent
   - 发送用户同意结果
   - 包含：VFS分配信息、授权信息等
   - 当前状态：DISCOVERED → APPROVED
   
4. MCP Agent → 通知Skill
   - 发送入网通知
   - 包含：VFS访问信息、授权密钥、Skill实例ID等
   - 采用加密通信
   
5. Skill → 确认入网
   - 验证VFS访问权限
   - 保存授权信息
   - 设置状态为READY
   - 返回确认结果
   
6. MCP Agent → 启动Skill
   - 发送启动命令
   - 监控Skill启动状态
   - 当前状态：READY → RUNNING
   
7. Skill → 开始运行
   - 初始化资源
   - 建立与MCP Agent的通信连接
   - 注册到Skill注册中心
   - 开始提供服务
```

## 9. Agent注销流程

### 9.1 主动注销流程

```
1. Agent → 注销请求 → Agent注册中心
   - 请求包含：Agent ID、注销原因等
   - 携带JWT令牌进行身份验证
   
2. Agent注册中心 → 验证请求
   - 验证JWT令牌有效性
   - 验证Agent是否存在
   
3. Agent注册中心 → 更新状态
   - 将Agent状态标记为SHUTDOWN
   - 停止心跳监控
   - 清理相关资源
   
4. Agent注册中心 → 发送注销事件
   - 通知相关组件Agent已注销
   - 更新订阅者列表
   
5. Agent注册中心 → 返回注销结果
   - 返回注销成功或失败
   
6. Agent → 清理资源
   - 关闭所有连接
   - 释放资源
   - 停止所有线程
```

### 9.2 被动注销流程

```
1. Agent注册中心 → 检测到故障
   - 心跳超时
   - 健康检查失败
   - 通信连接断开
   
2. Agent注册中心 → 尝试恢复
   - 发送恢复请求
   - 等待响应（默认30秒）
   
3. Agent注册中心 → 注销Agent
   - 如果无法恢复，将Agent状态标记为ERROR
   - 发送Agent离线事件
   - 清理相关资源
   - 更新负载均衡配置
   
4. Agent注册中心 → 记录日志
   - 记录注销原因
   - 记录故障时间
   - 记录相关指标
```

## 10. Agent网络拓扑

### 10.1 集中式拓扑

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   外部系统      │────▶│    API Gateway  │────▶│    MCP Agent    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                      │
                                                      ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    End Agent    │◀────│    Route Agent  │◀────│ Agent注册中心   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                      │
                                                      ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    End Agent    │◀────│    Route Agent  │◀────│ Skill注册中心   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 10.2 分布式拓扑

```
┌─────────────────┐     ┌─────────────────┐
│   外部系统      │────▶│    API Gateway  │
└─────────────────┘     └─────────────────┘
                              │
                              ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    MCP Agent    │◀────▶│    MCP Agent    │◀────▶│    MCP Agent    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
      │                       │                       │
      ▼                       ▼                       ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    Route Agent  │     │    Route Agent  │     │    Route Agent  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
      │                       │                       │
      ▼                       ▼                       ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    End Agent    │     │    End Agent    │     │    End Agent    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 11. Agent网络管理

### 11.1 网络监控

- 监控Agent之间的通信质量
- 监控网络延迟和丢包率
- 监控带宽使用率
- 检测网络故障

### 11.2 网络优化

- 动态调整路由规则
- 优化通信协议
- 实现数据压缩
- 采用边缘计算减少网络流量

### 11.3 网络安全

- 所有通信均采用TLS/SSL加密
- 实现网络访问控制
- 检测和防止DDoS攻击
- 实现入侵检测和防御

## 12. 总结

SuperAgent Agent（组网）流程规范定义了Agent的注册、发现、通信、故障处理等核心流程，确保了Agent之间的可靠协作和安全通信。这些流程设计结合了分布式系统的最佳实践，为SuperAgent系统提供了坚实的基础。