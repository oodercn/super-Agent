# Ooder Agent SDK 0.7.0 需求规格说明书

> 本文档定义了Ooder Agent SDK 0.7.0版本的最终功能需求规格，作为开发和测试的基准文档。

## 文档信息

- 版本：v0.7.0
- 创建日期：2026-02-15
- 状态：定稿中

---

## 一、概述

### 1.1 项目背景

Ooder Agent SDK 0.7.0版本是一个重大升级版本，主要实现了技能闭环设计，支持技能的发现、安装、运行和故障切换全生命周期管理。

### 1.2 项目目标

1. 实现零配置的技能发现机制
2. 支持有/无SkillCenter两种工作模式
3. 实现技能安装的严格模式转换
4. 支持场景组管理和故障切换
5. 确保组网安全和高可用

### 1.3 适用范围

- 单机/小团队开发环境（无SkillCenter模式）
- 企业级生产环境（有SkillCenter模式）
- P2P个人技能共享场景
- 边缘计算场景

---

## 二、功能需求

### 2.1 技能发现模块

#### FR-001: 零配置技能发现

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 系统启动时自动扫描并发现可用技能源，无需配置文件或环境变量 |

**验收标准：**
1. 启动时自动执行UDP Broadcast、mDNS/DNS-SD、DHT、SkillCenter API、本地文件系统扫描
2. 单个发现方法失败不影响其他方法
3. 汇总所有发现结果，返回可用技能列表
4. 支持增量发现，不阻塞主流程

#### FR-002: 多协议技能源支持

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 支持多种协议访问技能源 |

**验收标准：**
1. 支持file://、http://、https://、github://、udp://、dht://协议
2. 每种协议有独立的超时和重试策略
3. 协议解析错误不影响其他协议

#### FR-003: 场景和技能元数据解析

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 解析技能源的场景定义和技能清单 |

**验收标准：**
1. 正确解析scene.yaml和skill.yaml
2. 支持YAML格式验证
3. 支持版本兼容性检查

### 2.2 技能安装模块

#### FR-004: 技能包下载和验证

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 从技能源下载技能包并验证完整性 |

**验收标准：**
1. 支持断点续传
2. 验证SHA256校验和
3. 验证数字签名
4. 验证失败自动清理已下载文件

#### FR-005: 严格模式转换

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 安装时强制写入严格模式所需的元数据 |

**验收标准：**
1. 生成identity.yaml（身份证明）
2. 初始化config/（运行配置）
3. 初始化vfs/（VFS资源）
4. 初始化auth/（认证模式）
5. 注册到本地注册表

#### FR-006: 协作场景处理

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 自动处理技能依赖的协作场景 |

**验收标准：**
1. 检查协作场景是否存在
2. 不存在时自动搜索并安装
3. 检测并处理循环依赖
4. 申请加入协作场景

#### FR-007: 安装回滚机制

| 属性 | 值 |
|------|-----|
| 优先级 | 中 |
| 状态 | 待实现 |
| 描述 | 安装失败时自动回滚已完成的操作 |

**验收标准：**
1. 记录安装进度
2. 失败时按逆序回滚
3. 清理所有已创建的文件和资源
4. 释放已分配的端口

### 2.3 场景组管理模块

#### FR-008: 场景组创建

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 创建场景组并生成SceneGroupKey |

**验收标准：**
1. 生成唯一的groupId
2. 生成主密钥和访问密钥
3. 使用Shamir算法分割密钥
4. 分发给所有成员

#### FR-009: 场景加入

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 技能申请加入已存在的场景 |

**验收标准：**
1. 发送加入请求
2. 验证身份和权限
3. 分发SceneGroupKey分片
4. 建立安全通道
5. 同步VFS资源访问权

#### FR-010: 能力调用

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 调用场景提供的能力 |

**验收标准：**
1. 发现可用能力
2. 验证调用权限
3. 路由到正确的技能
4. 返回执行结果
5. 支持异步调用

### 2.4 故障切换模块

#### FR-011: 故障检测

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 检测RouteAgent故障 |

**验收标准：**
1. 心跳检测（5秒间隔）
2. 连续3次超时判定为故障
3. 向MCP Agent确认故障状态
4. 避免误判

#### FR-012: 故障切换

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | BACKUP自动接管PRIMARY职责 |

**验收标准：**
1. 选举新的PRIMARY
2. 继承SceneGroupKey
3. 恢复链路表
4. 启动技能服务
5. 切换时间 < 30秒

#### FR-013: 原链路恢复

| 属性 | 值 |
|------|-----|
| 优先级 | 中 |
| 状态 | 待实现 |
| 描述 | 原PRIMARY恢复后的处理 |

**验收标准：**
1. 检测原PRIMARY恢复
2. 评估是否需要切换回
3. 同步最新状态
4. 无缝切换或以BACKUP角色加入

### 2.5 安全模块

#### FR-014: 密钥管理

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 管理场景组的密钥体系 |

**验收标准：**
1. 支持多层CA结构
2. 支持Shamir秘密共享
3. 密钥安全存储（加密）
4. 支持密钥轮换

#### FR-015: 访问控制

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 基于角色的访问控制 |

**验收标准：**
1. 支持角色定义
2. 支持能力权限映射
3. 支持VFS资源权限
4. 权限验证正确率100%

### 2.6 元数据可观测性模块

#### FR-016: 四维元数据查询

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 通过API获取对象的完整四维元数据 |

**验收标准：**
1. 支持查询Skill对象的WHO/WHERE/WHEN/WHAT信息
2. 支持查询Scene对象的WHO/WHERE/WHEN/WHAT信息
3. 支持查询SceneGroup对象的WHO/WHERE/WHEN/WHAT信息
4. API响应时间 < 100ms

**四维元数据定义：**
- WHO：对象主体（主场景Skills、协作场景Skills、Agent、用户）
- WHERE：对象位置（部署位置、网络位置、存储位置、场景位置）
- WHEN：对象时间线（发现、安装、组网、运行四个阶段）
- WHAT：对象功能（用途描述、服务使用、执行结果、状态变更）

#### FR-017: 变更记录追踪

| 属性 | 值 |
|------|-----|
| 优先级 | 高 |
| 状态 | 待实现 |
| 描述 | 记录和查询对象的所有变更历史 |

**验收标准：**
1. 记录所有SKILL_INSTALL、SKILL_UNINSTALL变更
2. 记录所有SCENE_JOIN、SCENE_LEAVE变更
3. 记录所有ROLE_CHANGE、FAILOVER变更
4. 记录所有KEY_ROTATE、CAP_ADD、CAP_REMOVE变更
5. 变更记录不可篡改
6. 支持按时间范围查询变更记录

**变更记录格式：**
```
{
    "timestamp": "变更时间",
    "changeType": "变更类型",
    "objectId": "变更对象ID",
    "objectType": "变更对象类型",
    "changes": [{"field": "字段", "oldValue": "旧值", "newValue": "新值"}],
    "reason": "变更原因",
    "operator": "操作者",
    "notes": "备注"
}
```

#### FR-018: 场景变化追踪

| 属性 | 值 |
|------|-----|
| 优先级 | 中 |
| 状态 | 待实现 |
| 描述 | 追踪场景变化带来的元数据变更 |

**验收标准：**
1. 场景加入时自动更新相关元数据
2. 场景离开时自动记录变更原因
3. 角色变更时自动更新权限配置
4. 故障切换时自动记录切换详情

**场景变化备注规范：**
| 变更类型 | 必须记录的备注信息 |
|----------|-------------------|
| SCENE_JOIN | 加入原因、分配角色、授权能力 |
| SCENE_LEAVE | 离开原因、权限回收情况 |
| ROLE_CHANGE | 变更原因、原角色、新角色 |
| FAILOVER | 故障原因、切换时间、恢复状态 |

### 2.7 Cap管理模块

#### FR-019: Cap命名规范检查

| 属性 | 值 |
|------|-----|
| 优先级 | 中 |
| 状态 | 待实现 |
| 描述 | 检查Cap ID命名规范，避免重复定义 |

**验收标准：**
1. 同一场景内的Cap ID必须唯一
2. Cap ID命名规范：{场景前缀}-{功能名称}
3. 跨场景引用时，使用完整Cap ID：{场景名称}.{Cap ID}
4. 检测并报告重复定义

**Cap命名规范：**
| 场景 | Cap ID前缀 | 示例 |
|------|------------|------|
| auth | auth- | auth-user, auth-org |
| messaging | msg- | msg-send, msg-receive |
| vfs | file- | file-read, file-write |
| notification | notify- | notify-push, notify-email |

#### FR-020: 协同场景Cap引用

| 属性 | 值 |
|------|-----|
| 优先级 | 中 |
| 状态 | 待实现 |
| 描述 | 管理协同场景中的Cap引用和权限 |

**验收标准：**
1. 支持跨场景Cap引用
2. 引用时自动检查Cap是否存在
3. 引用时自动检查权限是否满足
4. 支持Cap引用的依赖分析

---

## 三、非功能需求

### 3.1 性能需求

| ID | 需求描述 | 指标 |
|----|----------|------|
| NFR-001 | 技能发现响应时间 | < 5秒（本地网络） |
| NFR-002 | 技能安装时间 | < 60秒（100MB技能包） |
| NFR-003 | 能力调用延迟 | < 100ms（本地） |
| NFR-004 | 故障切换时间 | < 30秒 |
| NFR-005 | 并发能力调用 | > 1000 QPS |

### 3.2 可靠性需求

| ID | 需求描述 | 指标 |
|----|----------|------|
| NFR-006 | 系统可用性 | > 99.9% |
| NFR-007 | 数据可靠性 | > 99.999% |
| NFR-008 | 故障恢复时间 | < 30秒 |
| NFR-009 | 无单点故障 | 支持 |

### 3.3 安全需求

| ID | 需求描述 | 指标 |
|----|----------|------|
| NFR-010 | 传输加密 | TLS 1.3 |
| NFR-011 | 存储加密 | AES-256-GCM |
| NFR-012 | 密钥强度 | RSA-4096 / Ed25519 |
| NFR-013 | 认证失败处理 | 锁定账户 |

### 3.4 兼容性需求

| ID | 需求描述 | 指标 |
|----|----------|------|
| NFR-014 | Java版本 | Java 8+ |
| NFR-015 | 操作系统 | Windows, Linux, macOS |
| NFR-016 | 协议版本 | 向下兼容0.6.x |

### 3.5 可维护性需求

| ID | 需求描述 | 指标 |
|----|----------|------|
| NFR-017 | 代码覆盖率 | > 80% |
| NFR-018 | 文档完整性 | 100% API文档 |
| NFR-019 | 日志完整性 | 所有关键操作 |

---

## 四、接口需求

### 4.1 SDK API

#### IFR-001: SkillPackageManager接口

```java
public interface SkillPackageManager {
    // 发现技能
    CompletableFuture<List<SkillPackage>> discoverSkills(DiscoveryFilter filter);
    
    // 安装技能
    CompletableFuture<InstallResult> installSkill(InstallRequest request);
    
    // 卸载技能
    CompletableFuture<UninstallResult> uninstallSkill(String skillId);
    
    // 请求加入场景
    CompletableFuture<SceneJoinResult> requestScene(SceneRequest request);
    
    // 获取已安装技能列表
    List<SkillPackage> getInstalledSkills();
    
    // 获取技能详情
    SkillPackage getSkillPackage(String skillId);
}
```

#### IFR-002: SceneGroupManager接口

```java
public interface SceneGroupManager {
    // 创建场景组
    SceneGroup createSceneGroup(String sceneName);
    
    // 加入场景组
    void joinSceneGroup(String groupId, SceneJoinRequest request);
    
    // 离开场景组
    void leaveSceneGroup(String groupId);
    
    // 获取场景组信息
    SceneGroup getSceneGroup(String groupId);
    
    // 调用能力
    CapabilityResult invokeCapability(String groupId, String capabilityId, Object params);
}
```

### 4.2 SkillCenter API

#### IFR-003: 技能管理API

| 端点 | 方法 | 描述 |
|------|------|------|
| /api/skills | GET | 获取技能列表 |
| /api/skills/{id} | GET | 获取技能详情 |
| /api/skills | POST | 注册技能 |
| /api/skills/{id} | PUT | 更新技能 |
| /api/skills/{id} | DELETE | 删除技能 |
| /api/skills/{id}/download | GET | 下载技能包 |
| /api/skills/{id}/versions | GET | 获取版本列表 |

#### IFR-004: 场景管理API

| 端点 | 方法 | 描述 |
|------|------|------|
| /api/scenes | GET | 获取场景列表 |
| /api/scenes/{id} | GET | 获取场景详情 |
| /api/scenes/{id}/skills | GET | 获取场景下的技能 |
| /api/scenes/{id}/join | POST | 加入场景 |
| /api/scenes/{id}/leave | POST | 离开场景 |

#### IFR-005: 能力调用API

| 端点 | 方法 | 描述 |
|------|------|------|
| /api/capabilities/{id}/invoke | POST | 调用能力 |
| /api/capabilities/{id}/check-permission | POST | 检查权限 |

---

## 五、数据需求

### 5.1 数据存储

| 数据类型 | 存储位置 | 保留时间 |
|----------|----------|----------|
| 技能包 | 本地文件系统 | 永久 |
| 本地注册表 | ~/.ooder/registry/ | 永久 |
| 场景组KEY | 加密存储 | 按配置 |
| 日志 | ~/.ooder/logs/ | 30天 |
| 临时文件 | 系统临时目录 | 会话期间 |

### 5.2 数据备份

| 数据类型 | 备份策略 | 恢复时间 |
|----------|----------|----------|
| 本地注册表 | 每次变更 | < 1分钟 |
| 场景组KEY | 多节点冗余 | < 5分钟 |
| VFS资源 | 按配置 | 取决于数据量 |

---

## 六、约束条件

### 6.1 技术约束

1. 必须支持Java 8
2. 必须使用Spring Boot 2.7.x
3. 必须使用Maven构建
4. 必须支持离线运行

### 6.2 业务约束

1. 技能ID必须全局唯一
2. 场景名称在同一命名空间内唯一
3. 端口范围1024-65535
4. 单个技能包最大1GB

### 6.3 安全约束

1. 所有网络通信必须加密
2. 敏感数据必须加密存储
3. 密钥必须安全存储
4. 操作必须有审计日志

---

## 七、验收标准

### 7.1 功能验收

| 验收项 | 验收标准 | 验收方法 |
|--------|----------|----------|
| 技能发现 | 能发现所有配置的技能源 | 自动化测试 |
| 技能安装 | 能正确安装并运行技能 | 集成测试 |
| 场景加入 | 能正确加入场景并获取权限 | 集成测试 |
| 故障切换 | 能在30秒内完成切换 | 性能测试 |
| 安全验证 | 所有安全机制正确工作 | 安全测试 |

### 7.2 性能验收

| 验收项 | 验收标准 | 验收方法 |
|--------|----------|----------|
| 发现响应 | < 5秒 | 性能测试 |
| 安装时间 | < 60秒 | 性能测试 |
| 调用延迟 | < 100ms | 性能测试 |
| 并发能力 | > 1000 QPS | 压力测试 |

### 7.3 文档验收

| 验收项 | 验收标准 |
|--------|----------|
| API文档 | 100%覆盖 |
| 用户指南 | 完整 |
| 部署指南 | 完整 |
| 故障排除指南 | 完整 |

---

## 八、里程碑计划

| 里程碑 | 日期 | 交付物 |
|--------|------|--------|
| M1: 协议定稿 | 2026-02-20 | 协议文档、元数据规范 |
| M2: SDK核心实现 | 2026-03-01 | SkillPackageManager实现 |
| M3: SkillCenter实现 | 2026-03-10 | SkillCenter服务 |
| M4: 故障切换实现 | 2026-03-20 | 故障切换模块 |
| M5: 集成测试 | 2026-03-30 | 测试报告 |
| M6: 文档完善 | 2026-04-05 | 完整文档 |
| M7: 发布 | 2026-04-10 | 0.7.0正式版 |

---

## 九、风险分析

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 协议设计缺陷 | 中 | 高 | 充分评审，原型验证 |
| 性能不达标 | 中 | 中 | 性能测试，优化迭代 |
| 安全漏洞 | 低 | 高 | 安全审计，渗透测试 |
| 兼容性问题 | 中 | 中 | 兼容性测试，版本管理 |

---

## 十、版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v0.1 | 2026-02-15 | 初始版本，定义核心需求 |

---

## 附录：参考文档

- [共识文档](./v0.7.0-skill-closed-loop-consensus.md)
- [术语定义规范](./v0.7.0-terminology-specification.md)
- [流程分支规范](./v0.7.0-process-branch-specification.md)
- [元数据规范](./v0.7.0-metadata-specification.md)
