# Ooder Agent SDK 0.7.0 流程分支规范

> 本文档定义了Ooder Agent SDK 0.7.0版本的核心流程分支，包括边界条件、异常处理和回滚机制。

## 文档信息

- 版本：v0.7.0
- 创建日期：2026-02-15
- 状态：定义中

---

## 一、技能发现流程分支

### 1.1 主流程

```
开始
  │
  ▼
启动扫描（零配置发现）
  │
  ├──▶ UDP Broadcast ──▶ 等待响应
  ├──▶ mDNS/DNS-SD ──▶ 查询本地服务
  ├──▶ DHT ──▶ 查询引导节点
  ├──▶ SkillCenter API ──▶ 连接预置地址
  └──▶ Local FS ──▶ 扫描标准路径
  │
  ▼
汇总技能源列表
  │
  ▼
对每个技能源检查 /skills/ 目录
  │
  ▼
解析场景和技能元数据
  │
  ▼
返回可用技能列表
  │
  ▼
结束
```

### 1.2 边界条件

| 条件 | 描述 | 处理方式 |
|------|------|----------|
| 无网络连接 | 所有网络发现方法失败 | 仅使用本地文件系统发现 |
| SkillCenter不可达 | 预置地址无响应 | 使用其他发现方法，标记SkillCenter不可用 |
| DHT引导节点离线 | 所有引导节点不可达 | 使用其他发现方法，延迟重试DHT |
| 本地目录为空 | 标准路径下无技能 | 返回空列表，提示用户安装技能 |
| 技能源响应超时 | 单个技能源响应时间过长 | 跳过该技能源，继续处理其他源 |

### 1.3 异常处理分支

```
发现过程中异常处理：

┌─────────────────────────────────────────────────────────────────────────────┐
│ 异常类型              │ 错误码 │ 处理策略                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ 网络超时              │ 1004   │ 指数退避重试，最多3次                        │
│ 网络错误              │ 1005   │ 尝试其他发现方法                             │
│ 认证失败              │ 1001   │ 跳过该技能源，记录日志                       │
│ 证书无效              │ 2001   │ 跳过该技能源，提示用户                       │
│ 数据格式错误          │ 1008   │ 跳过该技能，记录错误                         │
│ 资源不存在            │ 1003   │ 跳过该技能源                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、技能安装流程分支

### 2.1 主流程

```
开始
  │
  ▼
下载技能包
  │
  ▼
验证校验和签名 ──▶ [验证失败] ──▶ 拒绝安装
  │
  ▼ [验证成功]
解压到临时目录
  │
  ▼
解析skill.yaml
  │
  ▼
检测循环依赖 ──▶ [存在循环] ──▶ 执行降级策略
  │
  ▼ [无循环]
生成身份证明（identity.yaml）
  │
  ▼
初始化配置（config/）
  │
  ▼
初始化VFS资源（vfs/）
  │
  ▼
初始化认证模式（auth/）
  │
  ▼
处理协作场景
  │
  ▼
注册到本地注册表
  │
  ▼
清理临时文件
  │
  ▼
结束
```

### 2.2 边界条件

| 条件 | 描述 | 处理方式 |
|------|------|----------|
| 技能已安装 | 同一技能ID已存在 | 检查版本，提示用户是否覆盖或保留 |
| 端口冲突 | 分配的端口已被占用 | 自动分配下一个可用端口 |
| 磁盘空间不足 | 安装目录空间不够 | 拒绝安装，提示用户清理空间 |
| 权限不足 | 无写入权限 | 拒绝安装，提示用户提升权限 |
| 依赖缺失 | 必需的依赖不存在 | 触发依赖安装或拒绝安装 |
| 网络中断 | 下载过程中网络断开 | 暂停安装，支持断点续传 |

### 2.3 异常处理分支

```
安装过程中异常处理：

┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段          │ 异常类型         │ 错误码 │ 处理策略                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ 下载阶段      │ 网络中断         │ 1005   │ 支持断点续传，重试3次           │
│              │ 校验和失败       │ 2000   │ 删除已下载文件，重新下载        │
│              │ 签名验证失败     │ 2000   │ 拒绝安装，报告安全风险          │
├─────────────────────────────────────────────────────────────────────────────┤
│ 解析阶段      │ YAML格式错误     │ 1008   │ 拒绝安装，报告格式错误          │
│              │ 必需字段缺失     │ 1000   │ 拒绝安装，报告缺失字段          │
│              │ 版本不兼容       │ 1009   │ 拒绝安装，提示兼容版本          │
├─────────────────────────────────────────────────────────────────────────────┤
│ 初始化阶段    │ 端口分配失败     │ 1007   │ 尝试下一个可用端口              │
│              │ VFS创建失败      │ 1007   │ 回滚已创建的文件，报告错误      │
│              │ 密钥生成失败     │ 2000   │ 回滚安装，报告安全错误          │
├─────────────────────────────────────────────────────────────────────────────┤
│ 协作场景阶段  │ 场景不存在       │ 1003   │ 触发场景技能搜索                │
│              │ 加入被拒绝       │ 1002   │ 根据required决定是否继续        │
│              │ 循环依赖         │ 1007   │ 执行降级策略                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 回滚机制

```
安装失败回滚流程：

安装失败
  │
  ▼
记录失败原因和当前阶段
  │
  ▼
判断已完成的阶段
  │
  ├──▶ [已注册到本地注册表] ──▶ 从注册表移除
  │
  ├──▶ [已初始化认证模式] ──▶ 删除auth/目录
  │
  ├──▶ [已初始化VFS资源] ──▶ 删除vfs/目录
  │
  ├──▶ [已初始化配置] ──▶ 删除config/目录
  │
  ├──▶ [已生成身份证明] ──▶ 删除identity.yaml
  │
  ├──▶ [已解压] ──▶ 删除技能目录
  │
  └──▶ [已下载] ──▶ 删除临时下载文件
  │
  ▼
释放已分配的资源（端口等）
  │
  ▼
记录回滚日志
  │
  ▼
向用户报告失败原因和建议
  │
  ▼
结束
```

---

## 三、场景加入流程分支

### 3.1 主流程

```
开始
  │
  ▼
检查场景是否存在
  │
  ├──▶ [存在且能力匹配] ──▶ 发送加入请求
  │                           │
  │                           ▼
  │                         场景验证请求
  │                           │
  │                           ▼
  │                         获取访问令牌
  │                           │
  │                           ▼
  │                         建立安全通道
  │                           │
  │                           ▼
  │                         同步VFS资源访问权
  │                           │
  │                           ▼
  │                         加入成功
  │
  ├──▶ [存在但能力不匹配] ──▶ 评估是否需要扩展
  │                             │
  │                             ├──▶ [需要扩展] ──▶ 申请扩展能力
  │                             │
  │                             └──▶ [不需要扩展] ──▶ 使用现有能力
  │
  └──▶ [不存在] ──▶ 搜索场景技能
                      │
                      ▼
                    检测循环依赖
                      │
                      ├──▶ [无循环] ──▶ 安装场景技能 ──▶ 重新尝试加入
                      │
                      └──▶ [有循环] ──▶ 执行降级策略
  │
  ▼
结束
```

### 3.2 边界条件

| 条件 | 描述 | 处理方式 |
|------|------|----------|
| 场景已满 | 场景已达到最大成员数 | 等待有空位或寻找其他场景 |
| 权限不足 | 不满足加入所需权限 | 提示用户获取权限或联系管理员 |
| KEY过期 | 场景组KEY已过期 | 申请续期或重新生成 |
| 网络分区 | 与场景组网络不通 | 等待网络恢复或使用备用路由 |
| 版本不兼容 | 场景协议版本不匹配 | 尝试协议协商或拒绝加入 |

### 3.3 异常处理分支

```
场景加入过程中异常处理：

┌─────────────────────────────────────────────────────────────────────────────┐
│ 异常类型              │ 错误码 │ 处理策略                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ 场景不存在            │ 1003   │ 触发场景技能搜索和安装                      │
│ 加入被拒绝            │ 1002   │ 根据required决定是否失败或继续              │
│ 认证失败              │ 1001   │ 重新认证或提示用户                          │
│ 令牌过期              │ 2002   │ 自动重新获取令牌                            │
│ 网络超时              │ 1004   │ 重试3次，间隔指数退避                       │
│ 循环依赖              │ 1007   │ 执行降级策略                                │
│ VFS访问被拒绝         │ 1002   │ 检查KEY权限，申请扩展                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、循环依赖处理流程

### 4.1 检测算法

```
循环依赖检测：

维护依赖链: dependencyChain = []

function checkCircularDependency(skillId):
    if skillId in dependencyChain:
        // 发现循环依赖
        cycleStart = dependencyChain.indexOf(skillId)
        cycle = dependencyChain[cycleStart:]
        return {circular: true, cycle: cycle}
    return {circular: false}

function installSkill(skillId):
    check = checkCircularDependency(skillId)
    if check.circular:
        return handleCircularDependency(check.cycle)
    
    dependencyChain.push(skillId)
    // ... 执行安装 ...
    dependencyChain.pop()
```

### 4.2 降级策略

```
循环依赖降级策略选择：

发现循环依赖
  │
  ▼
检查依赖的required属性
  │
  ├──▶ [required: false] ──▶ 策略: skip ──▶ 跳过该依赖
  │
  ├──▶ [required: true] ──▶ 检查是否已存在部分场景
  │                           │
  │                           ├──▶ [存在] ──▶ 策略: use-existing ──▶ 使用现有场景
  │                           │
  │                           └──▶ [不存在] ──▶ 检查是否可延迟
  │                                              │
  │                                              ├──▶ [可延迟] ──▶ 策略: lazy-load
  │                                              │
  │                                              └──▶ [不可延迟] ──▶ 策略: fail
  │
  └──▶ [开发环境] ──▶ 策略: mock ──▶ 使用模拟服务
```

### 4.3 降级策略详细说明

| 策略 | 适用场景 | 执行动作 | 后续处理 |
|------|----------|----------|----------|
| skip | required: false | 跳过该依赖，继续安装 | 安装完成后记录跳过的依赖 |
| use-existing | 场景已部分存在 | 使用现有场景，不安装新技能 | 监控场景能力是否满足 |
| lazy-load | 非立即需要 | 延迟加载，标记待处理 | 运行时按需触发安装 |
| mock | 开发测试环境 | 使用模拟服务替代 | 提示用户生产环境需安装真实技能 |
| fail | required: true且无法降级 | 安装失败，报告错误 | 提供解决建议和依赖图 |

---

## 五、故障切换流程分支

### 5.1 主流程

```
开始（故障检测）
  │
  ▼
BACKUP未收到PRIMARY心跳
  │
  ▼
开始计时（15秒超时）
  │
  ▼
向MCP Agent确认PRIMARY状态
  │
  ├──▶ [PRIMARY正常] ──▶ 重置计时器，继续监听
  │
  └──▶ [PRIMARY故障] ──▶ MCP Agent授权切换
                          │
                          ▼
                        选举新PRIMARY
                          │
                          ▼
                        继承场景组KEY
                          │
                          ▼
                        恢复链路表
                          │
                          ▼
                        启动技能服务
                          │
                          ▼
                        广播路由更新
                          │
                          ▼
                        切换完成
  │
  ▼
结束
```

### 5.2 边界条件

| 条件 | 描述 | 处理方式 |
|------|------|----------|
| 多个BACKUP同时检测 | 多个BACKUP同时发起切换 | MCP Agent协调选举，选择最优BACKUP |
| 无可用BACKUP | 所有BACKUP都不可用 | MCP Agent接管或报警 |
| KEY分片不足 | 剩余节点不足以恢复KEY | 使用MCP Agent备份的KEY |
| VFS资源不可达 | VFS存储服务不可用 | 使用本地缓存，标记降级模式 |
| 技能启动失败 | 技能无法正常启动 | 重试3次，失败则标记场景不可用 |

### 5.3 异常处理分支

```
故障切换过程中异常处理：

┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段          │ 异常类型         │ 错误码 │ 处理策略                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ 选举阶段      │ 选举冲突         │ 1007   │ MCP Agent仲裁                   │
│              │ 无候选者         │ 1009   │ MCP Agent接管或报警             │
├─────────────────────────────────────────────────────────────────────────────┤
│ KEY继承阶段   │ KEY分片不足      │ 2000   │ 使用MCP Agent备份               │
│              │ KEY验证失败      │ 2000   │ 拒绝切换，报警                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ 链路恢复阶段  │ 链路表损坏       │ 1008   │ 从其他BACKUP同步                │
│              │ 连接建立失败     │ 1005   │ 重试3次，标记不可达节点         │
├─────────────────────────────────────────────────────────────────────────────┤
│ 技能启动阶段  │ 技能不存在       │ 1003   │ 从场景组网络下载                │
│              │ 技能启动失败     │ 1007   │ 重试3次，标记场景降级           │
│              │ 端口冲突         │ 1007   │ 重新分配端口                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 原链路恢复处理

```
原PRIMARY恢复处理流程：

原PRIMARY重新上线
  │
  ▼
发送RECOVERY_NOTIFY到当前PRIMARY
  │
  ▼
当前PRIMARY确认原PRIMARY身份
  │
  ▼
评估是否需要切换回原PRIMARY
  │
  ├──▶ [需要切换] ──▶ 同步最新链路表到原PRIMARY
  │                     │
  │                     ▼
  │                   原PRIMARY接管PRIMARY角色
  │                     │
  │                     ▼
  │                   当前PRIMARY降级为BACKUP
  │                     │
  │                     ▼
  │                   广播路由更新
  │
  └──▶ [不需要切换] ──▶ 原PRIMARY以BACKUP角色加入
                        │
                        ▼
                      同步当前链路表
                        │
                        ▼
                      开始监听PRIMARY心跳
```

**切换评估因素：**

| 因素 | 权重 | 说明 |
|------|------|------|
| 资源状态 | 30% | CPU、内存、存储的可用性 |
| 网络质量 | 25% | 延迟、带宽、稳定性 |
| 业务连续性 | 25% | 是否有正在进行的任务 |
| 历史稳定性 | 20% | 过去的故障频率和恢复时间 |

---

## 六、能力调用流程分支

### 6.1 主流程

```
开始
  │
  ▼
发现能力
  │
  ▼
验证权限 ──▶ [无权限] ──▶ 返回权限错误
  │
  ▼ [有权限]
生成调用请求
  │
  ▼
发送到场景
  │
  ▼
场景路由到技能
  │
  ▼
技能执行能力
  │
  ▼
返回结果
  │
  ▼
结束
```

### 6.2 边界条件

| 条件 | 描述 | 处理方式 |
|------|------|----------|
| 能力不存在 | 请求的能力ID不存在 | 返回404，提供可用能力列表 |
| 技能不可用 | 提供该能力的技能离线 | 尝试其他提供者或返回错误 |
| 参数无效 | 输入参数不符合Schema | 返回400，说明参数错误 |
| 速率限制 | 超过调用频率限制 | 返回429，说明限制规则 |
| 超时 | 执行时间超过限制 | 返回408，支持重试 |

### 6.3 异常处理分支

```
能力调用过程中异常处理：

┌─────────────────────────────────────────────────────────────────────────────┐
│ 异常类型              │ 错误码 │ 处理策略                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ 能力不存在            │ 1003   │ 返回可用能力列表                            │
│ 权限不足              │ 1002   │ 返回权限错误，说明所需权限                  │
│ 参数无效              │ 1000   │ 返回参数错误，说明期望格式                  │
│ 技能不可用            │ 1009   │ 尝试其他提供者或排队等待                    │
│ 执行超时              │ 1004   │ 返回超时错误，支持异步结果查询              │
│ 执行失败              │ 1007   │ 返回错误详情，支持重试                      │
│ 速率限制              │ 1006   │ 返回限制信息，说明重试时间                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、错误码定义

### 7.1 通用错误码 (1xxx)

| 错误码 | 名称 | 描述 | HTTP状态码 |
|--------|------|------|------------|
| 1000 | INVALID_PARAMETER | 参数错误 | 400 |
| 1001 | AUTHENTICATION_FAILED | 认证失败 | 401 |
| 1002 | PERMISSION_DENIED | 权限不足 | 403 |
| 1003 | RESOURCE_NOT_FOUND | 资源不存在 | 404 |
| 1004 | REQUEST_TIMEOUT | 请求超时 | 408 |
| 1005 | NETWORK_ERROR | 网络错误 | 503 |
| 1006 | SERVICE_BUSY | 服务繁忙 | 429 |
| 1007 | INTERNAL_ERROR | 内部错误 | 500 |
| 1008 | DATA_FORMAT_ERROR | 数据格式错误 | 400 |
| 1009 | AGENT_UNAVAILABLE | Agent不可用 | 503 |

### 7.2 安全错误码 (2xxx)

| 错误码 | 名称 | 描述 | HTTP状态码 |
|--------|------|------|------------|
| 2000 | SECURITY_VIOLATION | 安全验证失败 | 403 |
| 2001 | CERTIFICATE_INVALID | 证书无效 | 403 |
| 2002 | TOKEN_EXPIRED | 令牌过期 | 401 |
| 2003 | WAN_CONNECTION_FAILED | 广域网连接失败 | 503 |
| 2004 | NETWORK_PARTITION | 网络分区 | 503 |

---

## 八、版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v0.1 | 2026-02-15 | 初始版本，定义核心流程分支 |
