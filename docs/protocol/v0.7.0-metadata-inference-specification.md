# Ooder Agent SDK v0.7.0 元数据推定规范

> 本文档基于"谁、在哪、什么时间、做什么"四维原则，对元数据进行严格推理和定义。

## 文档信息

- 版本：v0.7.0
- 创建日期：2026-02-15
- 状态：推定中

---

## 一、元数据推定原则

### 1.1 四维推定框架

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     元数据四维推定框架                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 维度一：谁？(WHO)                                                    │   │
│  │                                                                      │   │
│  │ 包括：                                                               │   │
│  │ - 主场景Skills：技能的主要提供者                                      │   │
│  │ - 协作场景Skills：技能的协作依赖                                      │   │
│  │ - Agent：执行技能的智能体                                             │   │
│  │ - 用户：技能的使用者                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 维度二：在哪？(WHERE)                                                │   │
│  │                                                                      │   │
│  │ 包括：                                                               │   │
│  │ - 部署位置：本地/云端/边缘                                           │   │
│  │ - 网络位置：IP地址、端口                                             │   │
│  │ - 存储位置：VFS路径                                                  │   │
│  │ - 场景位置：场景组中的角色位置                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 维度三：什么时间？(WHEN)                                             │   │
│  │                                                                      │   │
│  │ 四个阶段：                                                           │   │
│  │ - 发现阶段：技能搜索和发现                                            │   │
│  │ - 安装阶段：技能下载和配置                                            │   │
│  │ - 组网阶段：场景加入和角色分配                                        │   │
│  │ - 运行阶段：能力调用和故障切换                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 维度四：做什么？(WHAT)                                               │   │
│  │                                                                      │   │
│  │ 包括：                                                               │   │
│  │ - 用途描述：技能的功能描述                                            │   │
│  │ - 服务使用：如何调用技能                                              │   │
│  │ - 执行结果：技能的输出                                                │   │
│  │ - 状态变更：技能状态变化                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 元数据可观测性原则

**原则：通过API可以完整获取所有对象的四维信息**

```
API响应必须包含：
{
    "who": {
        "skillId": "...",
        "sceneRole": "primary | collaborative",
        "agentRole": "provider | consumer",
        "sceneGroupRole": "PRIMARY | BACKUP"
    },
    "where": {
        "deployment": "local | cloud | edge",
        "endpoint": "192.168.1.100:8080",
        "vfsPath": "/data/...",
        "sceneGroupId": "scene-xxx-001"
    },
    "when": {
        "discoveredAt": "2026-02-15T10:00:00Z",
        "installedAt": "2026-02-15T10:05:00Z",
        "joinedAt": "2026-02-15T10:10:00Z",
        "runningSince": "2026-02-15T10:15:00Z"
    },
    "what": {
        "description": "...",
        "usage": "...",
        "result": "...",
        "status": "running | stopped | error"
    }
}
```

---

## 二、场景对象完整性定义

### 2.1 VFS Skills场景定义

#### 2.1.1 场景定义

```yaml
apiVersion: skill.ooder.net/v1
kind: SceneDefinition

metadata:
  name: vfs
  version: "1.0"
  description: 虚拟文件系统场景，提供文件存储、访问和管理能力

spec:
  type: primary                    # VFS作为主场景
  
  capabilities:
    - id: file-read
      name: File Read
      description: 读取文件
      category: storage
      parameters:
        - name: path
          type: string
          required: true
          description: 文件路径
      returns:
        type: FileContent
        description: 文件内容
      permissions:
        - vfs:read
    
    - id: file-write
      name: File Write
      description: 写入文件
      category: storage
      parameters:
        - name: path
          type: string
          required: true
        - name: content
          type: object
          required: true
      returns:
        type: WriteResult
      permissions:
        - vfs:write
    
    - id: file-delete
      name: File Delete
      description: 删除文件
      category: storage
      parameters:
        - name: path
          type: string
          required: true
      permissions:
        - vfs:delete
    
    - id: file-list
      name: File List
      description: 列出目录内容
      category: storage
      parameters:
        - name: path
          type: string
          required: true
      returns:
        type: array
      permissions:
        - vfs:read
    
    - id: file-upload
      name: File Upload
      description: 上传文件
      category: transfer
      parameters:
        - name: file
          type: binary
          required: true
        - name: path
          type: string
          required: true
      permissions:
        - vfs:write
    
    - id: file-download
      name: File Download
      description: 下载文件
      category: transfer
      parameters:
        - name: path
          type: string
          required: true
      returns:
        type: binary
      permissions:
        - vfs:read
  
  roles:
    - name: reader
      capabilities:
        - file-read
        - file-list
        - file-download
    - name: writer
      capabilities:
        - file-read
        - file-write
        - file-list
        - file-upload
        - file-download
    - name: admin
      capabilities:
        - file-read
        - file-write
        - file-delete
        - file-list
        - file-upload
        - file-download
  
  protocols:
    transport: http
    format: binary
    encryption: tls
  
  security:
    authRequired: true
    allowedRoles:
      - reader
      - writer
      - admin
```

#### 2.1.2 VFS作为协作场景

当VFS作为其他技能的协作场景时：

```yaml
# skill-msg-feishu中的协作场景配置
spec:
  scenes:
    collaborative:
      - name: vfs
        role: consumer
        required: false
        capabilities:
          - file-upload      # 消息附件上传
          - file-download    # 消息附件下载
        fallback:
          action: skip
          message: "文件传输功能不可用"
```

### 2.2 Cap重复定义检查

#### 2.2.1 检查规则

```
检查原则：
1. 同一场景内的Cap ID必须唯一
2. 不同场景的Cap ID可以相同，但含义可能不同
3. Cap ID命名规范：{场景前缀}-{功能名称}
4. 跨场景引用时，使用完整Cap ID：{场景名称}.{Cap ID}
```

#### 2.2.2 Cap命名规范

| 场景 | Cap ID前缀 | 示例 |
|------|------------|------|
| auth | auth- | auth-user, auth-org |
| messaging | msg- | msg-send, msg-receive |
| vfs | file- | file-read, file-write |
| notification | notify- | notify-push, notify-email |

#### 2.2.3 Cap重复定义检查表

| Cap ID | 定义场景 | 其他场景引用 | 是否冲突 | 备注 |
|--------|----------|--------------|----------|------|
| file-read | vfs | messaging(协作) | 否 | 消息场景作为消费者使用 |
| file-write | vfs | messaging(协作) | 否 | 消息场景作为消费者使用 |
| file-upload | vfs | messaging(协作) | 否 | 消息附件上传 |
| file-download | vfs | messaging(协作) | 否 | 消息附件下载 |
| org-data-read | auth | messaging(协作) | 否 | 消息场景读取组织数据 |
| user-auth | auth | messaging(协作) | 否 | 消息场景用户认证 |

#### 2.2.4 Cap引用格式

```yaml
# 在skill.yaml中引用其他场景的Cap
spec:
  scenes:
    collaborative:
      - name: auth
        capabilities:
          - auth.user-auth      # 完整引用格式
          - auth.org-data-read
      - name: vfs
        capabilities:
          - vfs.file-upload
          - vfs.file-download
```

---

## 三、协同场景配置定义

### 3.1 协同场景配置结构

```yaml
spec:
  scenes:
    collaborative:
      - name: auth                    # 协同场景名称
        role: consumer                # 角色：消费者
        
        # 发现配置
        discovery:
          method: auto                # auto | manual
          prefer: skill-org-feishu    # 优先选择的技能
          timeout: 30s                # 发现超时
        
        # 能力需求
        capabilities:
          - id: user-auth
            required: true            # 是否必需
            description: 用户认证能力
          - id: org-data-read
            required: true
            description: 组织数据读取
        
        # 角色定义
        roleConfig:
          inScene: consumer           # 在协同场景中的角色
          permissions:                # 需要的权限
            - auth:execute
            - org:read
        
        # 配置需求
        configRequirements:
          - key: auth.endpoint
            type: string
            required: true
            description: 认证服务端点
          - key: auth.appId
            type: string
            required: true
            description: 应用ID
        
        # 降级策略
        fallback:
          action: install             # install | skip | fail
          prefer: skill-org-feishu
          message: "需要安装组织认证技能"
```

### 3.2 协同者角色定义

#### 3.2.1 角色定义位置

```
协同者角色定义位置：

1. 场景定义（scene.yaml）
   - 定义场景内的角色类型
   - 定义角色对应的能力

2. 技能配置（skill.yaml）
   - 定义技能在场景中的角色
   - 定义角色所需的配置

3. 场景组配置（SceneGroupKey）
   - 定义成员在场景组中的角色
   - 定义角色对应的权限
```

#### 3.2.2 角色定义示例

**场景定义中的角色：**
```yaml
# scene.yaml
spec:
  roles:
    - name: admin
      capabilities:
        - user-auth
        - org-data-read
        - org-data-write
      description: 管理员角色
    - name: user
      capabilities:
        - user-auth
        - org-data-read
      description: 普通用户角色
```

**技能配置中的角色：**
```yaml
# skill.yaml
spec:
  scenes:
    collaborative:
      - name: auth
        role: consumer
        roleConfig:
          inScene: user              # 申请的角色
          justification: "消息服务需要用户认证能力"
```

**场景组中的角色：**
```yaml
# SceneGroupKey
members:
  - agentId: route-agent-a
    role: PRIMARY                   # 场景组角色
    sceneRole: admin                # 场景角色
    capabilities: [...]             # 授权的能力
```

### 3.3 从变主角色变更

#### 3.3.1 角色变更场景

| 变更类型 | 触发条件 | 变更内容 |
|----------|----------|----------|
| BACKUP→PRIMARY | PRIMARY故障 | 场景组角色变更 |
| consumer→provider | 技能升级 | 场景角色变更 |
| user→admin | 权限提升 | 场景角色变更 |

#### 3.3.2 角色变更流程

```
BACKUP → PRIMARY 变更流程：

1. 故障检测
   │
   ├── BACKUP检测到PRIMARY故障
   └── 触发故障切换流程
   │
   ▼
2. 角色变更请求
   │
   ├── 向MCP Agent发送ROLE_CHANGE请求
   │   {
   │       "type": "ROLE_CHANGE",
   │       "agentId": "route-agent-b",
   │       "groupId": "scene-messaging-001",
   │       "fromRole": "BACKUP",
   │       "toRole": "PRIMARY",
   │       "reason": "failover"
   │   }
   │
   ▼
3. MCP Agent验证
   │
   ├── 验证变更合法性
   ├── 更新SceneGroupKey
   └── 签发新的权限
   │
   ▼
4. 角色变更确认
   │
   ├── 更新本地角色状态
   ├── 激活PRIMARY权限
   └── 广播角色变更
   │
   ▼
5. 场景角色同步
   │
   ├── 如果场景角色也需要变更
   ├── 更新sceneRole
   └── 重新申请能力授权
```

#### 3.3.3 角色变更元数据

```yaml
# 角色变更记录
roleChanges:
  - timestamp: "2026-02-15T10:00:30Z"
    agentId: "route-agent-b"
    changeType: "BACKUP_TO_PRIMARY"
    trigger: "failover"
    previousRole:
      sceneGroupRole: "BACKUP"
      sceneRole: "user"
    newRole:
      sceneGroupRole: "PRIMARY"
      sceneRole: "admin"
    approved: true
    approvedBy: "mcp-agent"
    notes: "PRIMARY故障切换"
```

---

## 四、四维元数据完整定义

### 4.1 Skill对象四维元数据

```yaml
# Skill完整元数据
apiVersion: skill.ooder.net/v1
kind: Skill

metadata:
  id: skill-msg-feishu
  name: Feishu Messaging Service
  version: "0.7.0"
  
  # WHO: 谁
  who:
    type: enterprise-skill
    sceneRole:
      primary: messaging              # 主场景
      collaborative:                  # 协作场景
        - auth
        - vfs
    provider: "ooder.cn"
    author: "ooder-team"
  
  # WHERE: 在哪
  where:
    deployment: local                 # local | cloud | edge
    endpoint: "192.168.1.100:8081"
    vfsRoot: "/opt/ooder/skills/skill-msg-feishu/vfs"
    sceneGroupId: "scene-messaging-001"
    sceneGroupRole: "PRIMARY"
  
  # WHEN: 什么时间
  when:
    discoveredAt: "2026-02-15T10:00:00Z"
    discoveredFrom: "https://skillcenter.ooder.net"
    installedAt: "2026-02-15T10:05:00Z"
    joinedSceneAt: "2026-02-15T10:10:00Z"
    runningSince: "2026-02-15T10:15:00Z"
    lastHeartbeat: "2026-02-15T12:00:00Z"
  
  # WHAT: 做什么
  what:
    description: "飞书即时消息服务，提供消息发送、接收、历史查询等功能"
    usage:
      - capability: msg-send
        description: "发送消息给指定用户"
        example: "skill.invoke('msg-send', {to: 'user-001', content: {...}})"
      - capability: msg-receive
        description: "接收消息"
        example: "skill.subscribe('msg-receive', callback)"
    result:
      successRate: 0.999
      avgLatency: "50ms"
      totalCalls: 10000
    status: running

spec:
  # ... 原有spec内容 ...
```

### 4.2 Scene对象四维元数据

```yaml
# Scene完整元数据
apiVersion: skill.ooder.net/v1
kind: SceneDefinition

metadata:
  name: messaging
  version: "1.0"
  
  # WHO: 谁
  who:
    providers:                        # 场景提供者
      - skillId: skill-msg-feishu
        agentId: route-agent-a
        role: provider
    consumers:                        # 场景消费者
      - skillId: skill-notification
        agentId: route-agent-b
        role: consumer
  
  # WHERE: 在哪
  where:
    sceneGroupId: "scene-messaging-001"
    primaryAgent: "route-agent-a"
    backupAgents:
      - "route-agent-b"
      - "route-agent-c"
    vfsLocation: "/opt/ooder/scenes/messaging"
  
  # WHEN: 什么时间
  when:
    createdAt: "2026-02-15T10:00:00Z"
    lastModified: "2026-02-15T10:00:00Z"
    lastFailover: null
  
  # WHAT: 做什么
  what:
    description: "即时消息场景，提供消息发送、接收、历史查询能力"
    capabilities:
      - msg-send
      - msg-receive
      - msg-history
    status: active

spec:
  # ... 原有spec内容 ...
```

### 4.3 SceneGroup对象四维元数据

```yaml
# SceneGroup完整元数据
groupId: scene-messaging-001
sceneName: messaging
version: 1

# WHO: 谁
who:
  members:
    - agentId: route-agent-a
      role: PRIMARY
      sceneRole: admin
      skills:
        - skill-msg-feishu
      joinedAt: "2026-02-15T10:00:00Z"
    - agentId: route-agent-b
      role: BACKUP
      sceneRole: user
      skills:
        - skill-msg-feishu
      joinedAt: "2026-02-15T10:10:00Z"

# WHERE: 在哪
where:
  primaryEndpoint: "192.168.1.100:8080"
  backupEndpoints:
    - "192.168.1.101:8080"
  vfsRoot: "/opt/ooder/scenes/messaging/vfs"

# WHEN: 什么时间
when:
  createdAt: "2026-02-15T10:00:00Z"
  lastModified: "2026-02-15T10:10:00Z"
  lastFailover: null
  keyExpiresAt: "2027-02-15T10:00:00Z"

# WHAT: 做什么
what:
  description: "消息场景组，提供高可用的消息服务"
  capabilities:
    - msg-send
    - msg-receive
    - msg-history
  status: active
  healthScore: 0.99

# 权限和密钥
permissions:
  vfs:
    "data/messages": ["read", "write"]
    "cache/sessions": ["read", "write", "delete"]
  capabilities:
    "msg-send": true
    "msg-receive": true
    "msg-history": true

masterKey: "..."
accessKey: "..."
signature: "..."
```

---

## 五、元数据变更备注

### 5.1 变更类型定义

| 变更类型 | 触发场景 | 影响范围 | 备注 |
|----------|----------|----------|------|
| SKILL_INSTALL | 技能安装 | 新增Skill对象 | 记录安装时间和来源 |
| SKILL_UNINSTALL | 技能卸载 | 删除Skill对象 | 记录卸载原因 |
| SCENE_JOIN | 加入场景 | SceneGroup.members | 记录角色分配 |
| SCENE_LEAVE | 离开场景 | SceneGroup.members | 记录离开原因 |
| ROLE_CHANGE | 角色变更 | SceneGroup.members[].role | 记录变更原因 |
| FAILOVER | 故障切换 | SceneGroup.primary | 记录切换时间 |
| KEY_ROTATE | 密钥轮换 | SceneGroup.masterKey | 记录轮换原因 |
| CAP_ADD | 能力新增 | Scene.capabilities | 记录新增能力 |
| CAP_REMOVE | 能力移除 | Scene.capabilities | 记录移除原因 |

### 5.2 变更记录格式

```yaml
# 变更记录
changeLog:
  - timestamp: "2026-02-15T10:05:00Z"
    changeType: "SKILL_INSTALL"
    objectId: "skill-msg-feishu"
    objectType: "Skill"
    changes:
      - field: "status"
        oldValue: null
        newValue: "installed"
      - field: "installedAt"
        oldValue: null
        newValue: "2026-02-15T10:05:00Z"
    reason: "用户请求安装"
    operator: "user-001"
    notes: "首次安装消息服务技能"
  
  - timestamp: "2026-02-15T10:10:00Z"
    changeType: "SCENE_JOIN"
    objectId: "scene-messaging-001"
    objectType: "SceneGroup"
    changes:
      - field: "members"
        oldValue: [{"agentId": "route-agent-a", "role": "PRIMARY"}]
        newValue: [{"agentId": "route-agent-a", "role": "PRIMARY"}, {"agentId": "route-agent-b", "role": "BACKUP"}]
    reason: "Route Agent B加入场景组"
    operator: "route-agent-b"
    notes: "作为BACKUP角色加入，提供故障切换支持"
  
  - timestamp: "2026-02-15T10:30:00Z"
    changeType: "FAILOVER"
    objectId: "scene-messaging-001"
    objectType: "SceneGroup"
    changes:
      - field: "members[0].role"
        oldValue: "PRIMARY"
        newValue: "OFFLINE"
      - field: "members[1].role"
        oldValue: "BACKUP"
        newValue: "PRIMARY"
    reason: "Route Agent A硬件故障"
    operator: "mcp-agent"
    notes: "PRIMARY故障，BACKUP自动接管，切换时间30秒"
```

---

## 六、API可观测性设计

### 6.1 获取完整Skill对象

```
GET /api/skills/{skillId}/full

响应：
{
    "who": {...},
    "where": {...},
    "when": {...},
    "what": {...},
    "spec": {...},
    "changeLog": [...]
}
```

### 6.2 获取完整Scene对象

```
GET /api/scenes/{sceneName}/full

响应：
{
    "who": {...},
    "where": {...},
    "when": {...},
    "what": {...},
    "spec": {...},
    "changeLog": [...]
}
```

### 6.3 获取完整SceneGroup对象

```
GET /api/scene-groups/{groupId}/full

响应：
{
    "who": {...},
    "where": {...},
    "when": {...},
    "what": {...},
    "permissions": {...},
    "changeLog": [...]
}
```

---

## 七、版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v0.1 | 2026-02-15 | 初始版本，元数据推定规范 |
